<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>秋过冬漫长</title>
  
  <subtitle>没有比脚更长的路，走过去，前面是个天！</subtitle>
  <link href="http://chaooo.github.io/atom.xml" rel="self"/>
  
  <link href="http://chaooo.github.io/"/>
  <updated>2022-09-15T14:22:19.368Z</updated>
  <id>http://chaooo.github.io/</id>
  
  <author>
    <name>郑超(Charles·Zheng)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>「数据结构与算法」单模式字符串匹配算法（BF、RK、KMP、BM）</title>
    <link href="http://chaooo.github.io/2022/06/25/data-structure-text-pattern-algorithm.html"/>
    <id>http://chaooo.github.io/2022/06/25/data-structure-text-pattern-algorithm.html</id>
    <published>2022-06-25T13:15:00.000Z</published>
    <updated>2022-09-15T14:22:19.368Z</updated>
    
    <content type="html"><![CDATA[<p>介绍字符串匹配算法之前，先定义几个概念：</p><ul><li><strong>主串</strong><code>Text</code>: 长度记作 <code>n</code>；</li><li><strong>模式串</strong><code>Pattern</code>: 长度记作 <code>m</code>，并且 <code>m&lt;=n</code>。</li><li>有效位移<code>s</code>（Valid Shift）：即模式串在主串中出现，并且位置移动 <code>s</code> 次。<br><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_01.png"></li></ul><h3 id="1-BF-算法"><a href="#1-BF-算法" class="headerlink" title="1. BF 算法"></a>1. BF 算法</h3><p>BF（Brute Force）算法，中文叫作暴力匹配算法，也叫朴素匹配算法。</p><p>从主串的首或尾开始逐个匹配字母（比较顺序没有限制）。<br><code>BF 算法</code>的思想可以用一句话来概括：在主串中，检查从起始位置 <code>0</code> 开始到 <code>n-m</code> 位置且长度为 <code>m</code> 的 <code>n-m+1</code> 个子串，看有没有跟模式串匹配的。如下图：</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_02.png"></p><p><code>BF 算法</code>从名字可以看出，这种算法的字符串匹配方式很“暴力”，当然也就会比较简单、好懂，但相应的性能也不高。<br>我们每次都比对 <code>m</code> 个字符，要比对 <code>n-m+1</code> 次，所以，这种算法的最坏情况时间复杂度是 <code>O(n*m)</code>。</p><p>尽管理论上，<code>BF 算法</code>的时间复杂度很高，是 <code>O(n*m)</code>，但在实际的开发中，它却是一个比较常用的字符串匹配算法。原因有两点。</p><ul><li>第一，实际的软件开发中，大部分情况下，模式串和主串的长度都不会太长。而且每次模式串与主串中的子串匹配的时候，当中途遇到不能匹配的字符的时候，就可以就停止了，不需要把 <code>m</code> 个字符都比对一下。所以，尽管理论上的最坏情况时间复杂度是 <code>O(n*m)</code>，但是，统计意义上，大部分情况下，算法执行效率要比这个高很多。</li><li>第二，朴素字符串匹配算法思想简单，代码实现也非常简单。在工程中，在满足性能要求的前提下，简单是首选。这也是我们常说的<a href="https://zh.wikipedia.org/wiki/KISS%E5%8E%9F%E5%88%99">KISS（Keep it Simple and Stupid）设计原则</a>。</li></ul><h4 id="1-1-BF-算法总结"><a href="#1-1-BF-算法总结" class="headerlink" title="1.1 BF 算法总结"></a>1.1 BF 算法总结</h4><p><code>BF 算法</code>（Brute Force）是最简单、粗暴的字符串匹配算法，它的实现思路是，拿模式串与主串中是所有子串匹配，看是否有能匹配的子串。<br>尽管理论上的最坏情况时间复杂度很高，是 <code>O(n*m)</code>（<code>n</code>、<code>m</code> 表示主串和模式串的长度）。<br>但在实际的开发中，它却是一个比较常用的字符串匹配算法。因为这种算法实现简单，对于处理小规模的字符串匹配很好用。</p><h4 id="1-2-Java代码实现"><a href="#1-2-Java代码实现" class="headerlink" title="1.2 Java代码实现"></a>1.2 Java代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串暴力匹配算法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text 主串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern 模式串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">bf</span><span class="params">(String text, String pattern)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> text.length();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length();</span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) &#123;<span class="keyword">return</span> -<span class="number">1</span>;&#125;</span><br><span class="line">    <span class="comment">// i表示主串与模式串对齐的第一个字符</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= n - m) &#123;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        <span class="comment">// 模式串从后往前匹配</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= m-<span class="number">1</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (text.charAt(i+j) != pattern.charAt(j))&#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// j为已匹配的字符串下一个字符的下标</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == m) &#123;</span><br><span class="line">            <span class="comment">// 匹配成功，返回主串与模式串第一个匹配的字符的位置</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        i += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-RK-算法"><a href="#2-RK-算法" class="headerlink" title="2. RK 算法"></a>2. RK 算法</h3><p>RK（Rabin-Karp）算法，是由它的两位发明者 Rabin 和 Karp 的名字来命名的。这个算法算是 <code>BF 算法</code>的升级版。</p><p><code>BF 算法</code>中，如果主串长度为 <code>n</code>，模式串长度为 <code>m</code>，那在主串中，就会有 <code>n-m+1</code> 个长度为 <code>m</code> 的子串与模式串匹配。但是，每次检查主串与子串是否匹配，需要依次比对每个字符，所以 <code>BF 算法</code>的时间复杂度就比较高，是 <code>O(n*m)</code>。</p><p><code>RK 算法</code>的思路：通过哈希算法对主串中的 <code>n-m+1</code> 个子串分别求哈希值，然后逐个与模式串的哈希值比较大小。如果某个子串的哈希值与模式串相等，那就说明对应的子串和模式串匹配了。因为哈希值是一个数字，数字之间比较是否相等是非常快速的，所以模式串和子串比较的效率就提高了。</p><p>整个<code>RK 算法</code>包含两部分：<br>第一部分，计算子串哈希值；通过设计特殊的哈希算法，只需要扫描一遍主串就能计算出所有子串的哈希值了，所以这部分的时间复杂度是 <code>O(n)</code>。<br>第二部分，模式串哈希值与每个子串哈希值之间的比较的时间复杂度是 <code>O(1)</code>，总共需要比较 <code>n-m+1</code> 个子串的哈希值，所以，这部分的时间复杂度也是 <code>O(n)</code>。<br>所以，<code>RK 算法</code>整体的时间复杂度就是 <code>O(n)</code>。<br>但是，当存在哈希冲突的时候，有可能存在子串和模式串的哈希值虽然是相同的，但是两者本身并不匹配。极端情况下，如果存在大量的冲突，每次都要再对比子串和模式串本身，那时间复杂度就会退化成 <code>O(n*m)</code>。但也不要太悲观，一般情况下，冲突不会很多，<code>RK 算法</code>的效率还是比 <code>BF 算法</code>高的。</p><h4 id="2-1-RK-算法总结"><a href="#2-1-RK-算法总结" class="headerlink" title="2.1 RK 算法总结"></a>2.1 RK 算法总结</h4><p><code>RK 算法</code>（Rabin-Karp）是对每个子串分别求哈希值，然后拿子串的哈希值与模式串的哈希值比较，减少了比较的时间。<br>理想情况下，<code>RK 算法</code>的时间复杂度是 <code>O(n)</code>。不过这样的效率取决于哈希算法的设计方法，如果存在冲突的情况下，时间复杂度可能会退化。极端情况下，哈希算法大量冲突，时间复杂度就退化为 <code>O(n*m)</code>。</p><h4 id="2-2-Java代码实现"><a href="#2-2-Java代码实现" class="headerlink" title="2.2 Java代码实现"></a>2.2 Java代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rabin-Karp算法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text 主串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern 模式串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">rk</span><span class="params">(String text, String pattern)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> text.length();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length();</span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span><br><span class="line">    <span class="comment">// 对模式串与第一个字串求哈希值</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">patternCode</span> <span class="operator">=</span> pattern.hashCode();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sub</span> <span class="operator">=</span> text.substring(<span class="number">0</span>, m);</span><br><span class="line">    <span class="type">int</span> <span class="variable">subCode</span> <span class="operator">=</span> sub.hashCode();</span><br><span class="line">    <span class="comment">// 对主串中的n-m+1个子串分别求哈希值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; n - m + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 哈希值相同，才进一步确认</span></span><br><span class="line">        <span class="keyword">if</span> (patternCode.equals(subCode) &amp;&amp; sub.equals(pattern)) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 继续下一个子串</span></span><br><span class="line">        i++;</span><br><span class="line">        sub = text.substring(i, i + m);</span><br><span class="line">        subCode = sub.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-KMP-算法"><a href="#3-KMP-算法" class="headerlink" title="3. KMP 算法"></a>3. KMP 算法</h3><p>KMP（Knuth Morris Pratt）算法，是最常用的之一。它以三个发明者命名，很多时候，提到字符串匹配，我们首先想到的就是<code>KMP 算法</code>。</p><p><code>KMP 算法</code>的核心思想：<br>在模式串与主串匹配的过程中，当遇到不可匹配的字符的时候，我们希望找到一些规律，可以将模式串往后多滑动几位，跳过那些肯定不会匹配的情况。</p><p>先了解几个概念：</p><ul><li><strong>前缀</strong>：指除了最后一个字符以外，一个字符串的全部头部组合；</li><li><strong>后缀</strong>：指除了第一个字符以外，一个字符串的全部尾部组合；</li><li><strong>部分匹配值</strong>：”前缀”和”后缀”的最长的共有元素的长度。</li></ul><p>以模式串”ABCDABD”为例：</p><table><thead><tr><th align="left">子串</th><th align="left">前缀</th><th align="left">后缀</th><th align="left">共有</th><th align="left">长度</th></tr></thead><tbody><tr><td align="left">A</td><td align="left">空</td><td align="left">空</td><td align="left">-</td><td align="left">0</td></tr><tr><td align="left">AB</td><td align="left">[A]</td><td align="left">[B]</td><td align="left">-</td><td align="left">0</td></tr><tr><td align="left">ABC</td><td align="left">[A, AB]</td><td align="left">[BC, C]</td><td align="left">-</td><td align="left">0</td></tr><tr><td align="left">ABCD</td><td align="left">[A, AB, ABC]</td><td align="left">[BCD, CD, D]</td><td align="left">-</td><td align="left">0</td></tr><tr><td align="left">ABCDA</td><td align="left">[A, AB, ABC, ABCD]</td><td align="left">[BCDA, CDA, DA, A]</td><td align="left">A</td><td align="left">1</td></tr><tr><td align="left">ABCDAB</td><td align="left">[A, AB, ABC, ABCD, ABCDA]</td><td align="left">[BCDAB, CDAB, DAB, AB, B]</td><td align="left">AB</td><td align="left">2</td></tr><tr><td align="left">ABCDABD</td><td align="left">[A, AB, ABC, ABCD, ABCDA, ABCDAB]</td><td align="left">[BCDABD, CDABD, DABD, ABD, BD, D]</td><td align="left">-</td><td align="left">0</td></tr></tbody></table><p>所以模式串”ABCDABD”的《部分匹配表》是：</p><table><thead><tr><th align="left">模式串</th><th align="left">A</th><th align="left">B</th><th align="left">C</th><th align="left">D</th><th align="left">A</th><th align="left">B</th><th align="left">D</th></tr></thead><tbody><tr><td align="left">部分匹配表</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">2</td><td align="left">0</td></tr></tbody></table><p>“部分匹配”的实质是，有时候，字符串头部和尾部会有重复。比如，”ABCDAB”之中有两个”AB”，那么它的”部分匹配值”就是<code>2</code>（”AB”的长度）。搜索词移动的时候，第一个”AB”向后移动<code>4</code>位（字符串长度-部分匹配值），就可以来到第二个”AB”的位置。<br>所以<code>KMP 算法</code>的后移规律：</p><blockquote><p>移动位数 &#x3D; 已匹配的字符数 - 对应的部分匹配值</p></blockquote><p>根据这个规律，我们以模式串”ABCDABD”来匹配字符串”BBC ABCDAB ABCDABCDABDE”。<code>KMP 算法</code>的匹配顺序是按照模式串下标从小到大。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_07.png"></p><p>逐位比较，不匹配就移一位；直到主串有一个字符与模式串的第一个字符相同为止。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_08.png"></p><p>已知空格与”D”不匹配时，前面<code>6</code>个字符”ABCDAB”是匹配的。查表可知，最后一个匹配字符”B”对应的”部分匹配值”为<code>2</code>，因此按照规律<code>移动位数 = 已匹配的字符数 - 对应的部分匹配值</code>算出向后移动的位数：<code>6 - 2</code> 等于<code>4</code>，所以将搜索词向后移动<code>4</code>位。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_09.png"></p><p>因为空格与”C”不匹配，搜索词还要继续往后移。这时，已匹配的字符数为<code>2</code>（”AB”），对应的”部分匹配值”为<code>0</code>。所以，<code>移动位数 = 2 - 0</code>，于是将搜索词向后移<code>2</code>位。<br>按照规律<code>移动位数 = 已匹配的字符数 - 对应的部分匹配值</code>算出向后移动的位数：<code>2 - 0</code> 等于<code>2</code>，所以将搜索词向后移动<code>2</code>位。<br>继续逐位比较，因为空格与”A”不匹配，继续后移<code>1</code>位。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_10.png"></p><p>逐位比较，直到发现”C”与”D”不匹配。于是，<code>移动位数 = 6 - 2</code>，继续将搜索词向后移动<code>4</code>位。<br>逐位比较，直到搜索词的最后一位，发现完全匹配，于是搜索完成。</p><h4 id="3-1-KMP-算法总结"><a href="#3-1-KMP-算法总结" class="headerlink" title="3.1 KMP 算法总结"></a>3.1 KMP 算法总结</h4><p><code>KMP 算法</code>（Knuth Morris Pratt）的核心是利用匹配失败后的信息，尽量减少模式串与主串的匹配次数以达到快速匹配的目的。具体实现就是通过一个<code>next()</code>函数实现，函数本身包含了模式串的局部匹配信息。<code>KMP 算法</code>的时间复杂度<code>O(m+n)</code>。</p><h4 id="3-2-KMP-算法的JAVA-代码实现"><a href="#3-2-KMP-算法的JAVA-代码实现" class="headerlink" title="3.2 KMP 算法的JAVA 代码实现"></a>3.2 KMP 算法的JAVA 代码实现</h4><p><strong>部分匹配值</strong>是模式串中子串”前缀”和”后缀”的<strong>最长</strong>的共有元素的长度。<br>《部分匹配表》在代码中定义为 <strong>next 数组</strong>，很多书中也叫<strong>失效函数</strong>（failure function）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现next()函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern 模式串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] kmpNext(String pattern)&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length();</span><br><span class="line">    <span class="comment">// 声明部分匹配表数组 next，用于存储部分匹配值</span></span><br><span class="line">    <span class="type">int</span>[] next = <span class="keyword">new</span> <span class="title class_">int</span>[m];</span><br><span class="line">    <span class="comment">// 第一个字符没有前后缀，最长匹配值为 0</span></span><br><span class="line">    next[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 循环模式串，计算部分匹配表，i初始化为 1</span></span><br><span class="line">    <span class="comment">// j用于记录部分匹配值</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>,j = <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">        <span class="comment">// ④ 在0~i中，j&gt;0 并且 pattern.charAt(j) != pattern.charAt(i)时，</span></span><br><span class="line">        <span class="comment">//   表示上一轮比较，前后缀部分匹配值为j。</span></span><br><span class="line">        <span class="comment">//   上一轮比较时，下标[0~j-1]是前后缀最长相同字符串。</span></span><br><span class="line">        <span class="comment">//   下标[j-1]的部分匹配值表示为next[j-1]，即j=next[j-1];</span></span><br><span class="line">        <span class="keyword">while</span>(j &gt; <span class="number">0</span> &amp;&amp; pattern.charAt(j) != pattern.charAt(i))&#123;</span><br><span class="line">            j = next[j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ① 在0~i中，j=0 并且 pattern.charAt(j) != pattern.charAt(i)时，</span></span><br><span class="line">        <span class="comment">//   表示前后缀字符串集合中没有相同字符串，next[i]=j（同next[i]=0）</span></span><br><span class="line">        <span class="comment">// ② 在0~i中，j=0 并且 pattern.charAt(j) == pattern.charAt(i)时，</span></span><br><span class="line">        <span class="comment">//   表示前后缀字符串集合中有 1 个相同字符串，j++;next[i]=j;（同next[i]=1）</span></span><br><span class="line">        <span class="comment">// ③ 在0~i中，j&gt;0 并且 pattern.charAt(j) == pattern.charAt(i)时，</span></span><br><span class="line">        <span class="comment">//   表示上一轮比较，前后缀部分匹配值为j。这轮为j+1。因此j++;next[i]=j;</span></span><br><span class="line">        <span class="keyword">if</span>(pattern.charAt(i) == pattern.charAt(j))&#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        next[i] = j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>KMP 算法</code>的框架代码，比较模式串和主串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">kmp</span><span class="params">(String text, String pattern)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> text.length();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length();</span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span><br><span class="line">    <span class="comment">// 计算出部分匹配表</span></span><br><span class="line">    <span class="type">int</span>[] next = kmpNext(pattern);</span><br><span class="line">    <span class="comment">// i表示主串与模式串对齐的第一个字符</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= n - m) &#123;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        <span class="comment">// 模式串从后往前匹配</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= m-<span class="number">1</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (text.charAt(i+j) != pattern.charAt(j))&#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// j为已匹配的字符串下一个字符的下标</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == m) &#123;</span><br><span class="line">            <span class="keyword">return</span> i; <span class="comment">// 匹配成功，返回主串与模式串第一个匹配的字符的位置</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (j &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 后移位数 = 已匹配的字符数j - 对应的部分匹配值next[j-1]</span></span><br><span class="line">            s = j - next[j-<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        i += s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-BM-算法"><a href="#4-BM-算法" class="headerlink" title="4. BM 算法"></a>4. BM 算法</h3><p>BM（Boyer-Moore）算法，也是以两位发明者名字命名的字符串匹配算法。<code>BM 算法</code>不仅效率高，而且构思巧妙，容易理解。</p><p><code>BM 算法</code>的核心思想：<br>我们把模式串和主串的匹配过程，看作模式串在主串中不停地往后滑动。当模式串和主串某个字符不匹配的时候，能够跳过一些肯定不会匹配的情况，将模式串往后多滑动几位。</p><p>BM 算法包含两部分，分别是<strong>坏字符</strong>规则（bad character rule）和<strong>好后缀</strong>规则（good suffix shift）。</p><h4 id="4-1-坏字符规则"><a href="#4-1-坏字符规则" class="headerlink" title="4.1 坏字符规则"></a>4.1 坏字符规则</h4><p><code>BM 算法</code>的匹配顺序比较特别，它是按照模式串下标从大到小的顺序，倒着匹配的。<br>当发现某个字符没法匹配的时候，我们把这个没有匹配的字符叫作”<strong>坏字符</strong>“（bad character）。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_03.png"><br>如上图，从尾部开始比较，发现”S”与”E”不匹配，所以”S”就是”坏字符”。<br>并且，”S”不包含在模式串”EXAMPLE”之中，也就是说，可以把模式串直接移到”S”的后一位。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_04.png"><br>如上图，依然从尾部开始比较，发现”P”与”E”不匹配，所以”P”是”坏字符”。<br>但是，”P”包含在模式串”EXAMPLE”之中。所以，将模式串后移两位，两个”P”对齐。</p><p>由此我们总结出<strong>坏字符规则</strong>：</p><blockquote><p>后移位数 &#x3D; 坏字符(对应模式串)的位置 - 模式串中的上一次出现位置</p><p>（如果”坏字符”不包含在模式串中，则上一次出现位置为 <code>-1</code>）</p></blockquote><p>如上图，”P”作为”坏字符”为例，出现在模式串的第6位（从0开始编号），在模式串中的上一次出现位置为4，所以后移<code>6 - 4 = 2</code> 位。<br>再以前面”坏字符”的”S”为例，它出现在第6位，上一次出现位置是 -1（即未出现），则整个模式串后移 <code>6 - (-1) = 7</code> 位。</p><h4 id="4-2-好后缀规则"><a href="#4-2-好后缀规则" class="headerlink" title="4.2 好后缀规则"></a>4.2 好后缀规则</h4><p>好后缀规则实际上跟坏字符规则的思路很类似。<br>从尾部开始比较，我们把所有尾部匹配的字符串称为”<strong>好后缀</strong>“（good suffix）。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_05.png"><br>如上图，从尾部开始比较，”E”与”E”匹配；”LE”与”LE”匹配；”PLE”与”PLE”匹配；”MPLE”与”MPLE”匹配。<br>所以，”MPLE”、”PLE”、”LE”、”E”都是好后缀。<br>比较前一位，发现”I”与”A”不匹配。所以，”I”是”坏字符”。</p><p><strong>好后缀规则</strong>：</p><blockquote><p>后移位数 &#x3D; 好后缀的位置 - 模式串中的上一次出现位置</p></blockquote><p>举例来说，<br>如果模式串”ABCDAB”的后一个”AB”是”好后缀”。那么<em>好后缀的位置</em>是 <code>5</code>（取最后的”B”的值），<em>模式串中的上一次出现位置</em>是 <code>1</code>（第一个”B”的位置），所以后移<code>5 - 1 = 4</code>位。<br>如果模式串”ABCDEF”的”EF”是好后缀，则<em>好后缀的位置</em>是<code>5</code> ，<em>上一次出现的位置</em>是<code>-1</code>（即未出现），所以后移<code>5 - (-1) = 6</code>位。</p><ul><li>好后缀规则三个注意点：<ol><li>“好后缀”的位置以最后一个字符为准。<ul><li>假定”ABCDEF”的”EF”是好后缀，则它的位置以”F”为准，即5。</li></ul></li><li>如果”好后缀”在搜索词中只出现一次，则它的上一次出现位置为 -1。<ul><li>比如，”EF”在”ABCDEF”之中只出现一次，则它的上一次出现位置为-1（即未出现）。</li></ul></li><li>如果”好后缀”有多个，则除了最长的那个”好后缀”，其他”好后缀”的上一次出现位置必须在头部。<ul><li>比如，假定”BABCDAB”的”好后缀”是”DAB”、”AB”、”B”，此时计算上一次出现位置是第0位，采用好后缀”B”计算。这个规则也可以这样表达：如果最长的那个”好后缀”只出现一次，则可以把搜索词改写成如下形式进行位置计算”(DA)BABCDAB”，即虚拟加入最前面的”DA”。</li></ul></li></ol></li></ul><p>回到上图的例子。此时，所有的”好后缀”（MPLE、PLE、LE、E）之中，只有”E”在”EXAMPLE”还出现在头部，所以好后缀规则是后移<code>6 - 0 = 6</code>位。<br>而”I”是”坏字符”，坏字符规则后移<code>2 - (-1) = 3</code>位。<br>可以看到，”坏字符规则”只能移3位，”好后缀规则”可以移6位。所以，<code>BM 算法</code>的基本思想是，<strong>每次后移这两个规则之中的较大值</strong>。</p><p>更巧妙的是，这两个规则的移动位数，只与搜索词有关，与原字符串无关。因此，可以预先计算生成《坏字符规则表》和《好后缀规则表》。使用时，只要查表比较一下就可以了。</p><p><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_06.png"><br>继续从尾部开始比较，”P”与”E”不匹配，因此”P”是”坏字符”。根据”坏字符规则”，后移 <code>6 - 4 = 2</code>位；<br>从尾部开始逐位比较，发现全部匹配，于是搜索结束。</p><h4 id="4-3-BM-算法总结"><a href="#4-3-BM-算法总结" class="headerlink" title="4.3 BM 算法总结"></a>4.3 BM 算法总结</h4><p><code>BM 算法</code>（Boyer-Moore）核心思想是，利用模式串本身的特点，在模式串中某个字符与主串不能匹配的时候，将模式串往后多滑动几位，以此来减少不必要的字符比较，提高匹配的效率。<code>BM 算法</code>构建的规则有两类，坏字符规则和好后缀规则。</p><h4 id="4-4-BM-算法的JAVA-代码实现"><a href="#4-4-BM-算法的JAVA-代码实现" class="headerlink" title="4.4 BM 算法的JAVA 代码实现"></a>4.4 BM 算法的JAVA 代码实现</h4><p><code>BM 算法</code>的框架代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">bm</span><span class="params">(String text, String pattern)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> text.length();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length();</span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) &#123; <span class="keyword">return</span> -<span class="number">1</span>; &#125;</span><br><span class="line">    <span class="comment">// 计算 坏字符规则表，记录模式串中每个字符最后出现的位置</span></span><br><span class="line">    Map&lt;Character, Integer&gt; badCharRules = generateBadCharRules(pattern);</span><br><span class="line">    <span class="comment">// 计算 好后缀规则表，记录好后缀位置对应后移的位数</span></span><br><span class="line">    <span class="type">int</span>[] goodSuffixRules = generateGoodSuffix(pattern.toCharArray());</span><br><span class="line">    <span class="comment">// i表示主串与模式串对齐的第一个字符</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= n - m) &#123;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        <span class="comment">// 模式串从后往前匹配</span></span><br><span class="line">        <span class="keyword">for</span> (j = m - <span class="number">1</span>; j &gt;= <span class="number">0</span>; --j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (text.charAt(i+j) != pattern.charAt(j))&#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// 坏字符对应模式串中的下标是j</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 匹配成功，返回主串与模式串第一个匹配的字符的位置</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 后移位数 = 坏字符(对应模式串)的位置 - 坏字符在模式串中最后出现位置</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s1</span> <span class="operator">=</span> j - getBadCharPosition(badCharRules, text.charAt(i + j));</span><br><span class="line">        <span class="comment">// 好后缀后移位数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s2</span> <span class="operator">=</span> goodSuffixRules[j];</span><br><span class="line">        <span class="comment">//后移这两个规则之中的较大值</span></span><br><span class="line">        i += Math.max(s1, s2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-4-1-坏字符规则表"><a href="#4-4-1-坏字符规则表" class="headerlink" title="4.4.1 坏字符规则表"></a>4.4.1 坏字符规则表</h5><p>计算模式串中每个字符最后出现的位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 坏字符规则表</span></span><br><span class="line"><span class="comment"> * 记录模式串中每个字符最后出现的位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Character, Integer&gt; <span class="title function_">generateBadCharRules</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">    Map&lt;Character, Integer&gt; bmBc = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(pattern.length());</span><br><span class="line">    <span class="comment">// 选择最靠后的那个，因为这样不会让模式串滑动过多，导致本来可能匹配的情况被滑动略过</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; pattern.length(); j++) &#123;</span><br><span class="line">        bmBc.put(pattern.charAt(j), j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bmBc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取坏字符在模式串中最后出现位置</span></span><br><span class="line"><span class="comment"> * 未出现返回 -1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getBadCharPosition</span><span class="params">(Map&lt;Character, Integer&gt; badChar, Character c)</span>&#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> badChar.get(c);</span><br><span class="line">    <span class="keyword">return</span> a == <span class="literal">null</span> ? -<span class="number">1</span> : a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-4-2-好后缀规则表"><a href="#4-4-2-好后缀规则表" class="headerlink" title="4.4.2 好后缀规则表"></a>4.4.2 好后缀规则表</h5><p>好后缀规则表，用来记录好后缀位置对应后移的位数。<br>为了实现好后缀规则，需要定义一个<code>suffix</code>数组，用来记录模式串中匹配上好后缀的子串长度。<br>其中，<code>suffix[i] = s</code>满足<code>pattern[i-s,i] == pattern[m-1-s,m-1]</code>，<code>m</code>是模式串的长度。如下图：<code>pattern[i-4,i]</code>和<code>pattern[m-5,m-1]</code>字符相同。<br><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_11.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算后缀长度数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern 模式串字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] getSuffix(<span class="type">char</span>[] pattern)&#123;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length;</span><br><span class="line">    <span class="type">int</span>[] suffix = <span class="keyword">new</span> <span class="title class_">int</span>[m];</span><br><span class="line">    <span class="comment">// 计算</span></span><br><span class="line">    suffix[m-<span class="number">1</span>] = m;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> m-<span class="number">2</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="keyword">while</span> (q &gt;= <span class="number">0</span> &amp;&amp; pattern[q] == pattern[q+m-<span class="number">1</span>-i])&#123;</span><br><span class="line">            q--;</span><br><span class="line">        &#125;</span><br><span class="line">        suffix[i] = i-q;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回后缀长度数组</span></span><br><span class="line">    <span class="keyword">return</span> suffix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有了<code>suffix</code>数组，就可以定义好后缀忽略映射<code>bmgs</code>数组。<br><code>suffix[i]</code>表示模式串中匹配上好后缀的子串长度（<code>i</code>表示子串的末位置）；<br><code>bmgs[j]</code>表示好后缀位置对应后移的位数（<code>j</code>表示好后缀前一个字符的位置，即坏字符的位置）。<br>根据<strong>好后缀规则</strong>：<code>后移位数 = 好后缀的位置 - 模式串中的上一次出现位置</code>，构建<code>bmgs</code>数组分为三种情况：</p><ul><li>①模式串没有子串匹配上好后缀，也没有最大前缀。<ul><li>后移位数为<code>m-1-(-1)</code>，即<code>bmgs[j]=m</code>。</li></ul></li><li>②模式串没有子串匹配上好后缀，但有最大前缀。<ul><li>后移位数为<code>m-1-i</code>，即<code>bmgs[j] = m-1-i</code>。<br><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_13.png"></li></ul></li><li>③模式串有子串匹配上好后缀。<ul><li>后移位数为<code>m-1-i</code>，即<code>bmgs[j] = m-1-i; j=m-1-suffix[i]</code>。<br><img src="/2022/06/25/data-structure-text-pattern-algorithm/01_12.png"></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 好后缀忽略映射（后移位数数组）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern 模式串字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] generateGoodSuffix(<span class="type">char</span>[] pattern)&#123;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> pattern.length;</span><br><span class="line">    <span class="type">int</span>[] bmgs = <span class="keyword">new</span> <span class="title class_">int</span>[m];</span><br><span class="line">    <span class="comment">// 获取后缀长度数组</span></span><br><span class="line">    <span class="type">int</span>[] suffix = getSuffix(pattern);</span><br><span class="line">    <span class="comment">// 赋值默认值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; m; ++j) &#123;</span><br><span class="line">        bmgs[j] = m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 模式串没有没有子串匹配上好后缀，但有最大前缀</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> m-<span class="number">1</span>, j = <span class="number">0</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (suffix[i] == i+<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (; j &lt; m-<span class="number">1</span>-i; ++j) &#123;</span><br><span class="line">                <span class="keyword">if</span>(bmgs[j] == m)&#123;</span><br><span class="line">                    bmgs[j] = m-<span class="number">1</span>-i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 模式串有子串匹配上好后缀（多个取最左）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m-<span class="number">1</span>; ++i) &#123;</span><br><span class="line">        bmgs[m-<span class="number">1</span>-suffix[i]] = m-<span class="number">1</span>-i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回忽略数组</span></span><br><span class="line">    <span class="keyword">return</span> bmgs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;介绍字符串匹配算法之前，先定义几个概念：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;主串&lt;/strong&gt;&lt;code&gt;Text&lt;/code&gt;: 长度记作 &lt;code&gt;n&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;模式串&lt;/strong&gt;&lt;code&gt;Pattern&lt;/</summary>
      
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」二分查找</title>
    <link href="http://chaooo.github.io/2022/06/02/data-structure-binary-search.html"/>
    <id>http://chaooo.github.io/2022/06/02/data-structure-binary-search.html</id>
    <published>2022-06-02T10:02:00.000Z</published>
    <updated>2022-09-02T09:49:46.264Z</updated>
    
    <content type="html"><![CDATA[<p>二分查找（Binary Search）又称折半查找、二分搜索、折半搜索等，查找思想有点类似<strong>分治思想</strong>，对应的时间复杂度为<code>O(logn)</code>。<br>二分查找算法仅适用于<strong>有序</strong>且使用<strong>顺序存储结构</strong>的序列（比如有序数组）。<br>核心思想是：不断地缩小搜索区域，降低查找目标元素的难度。（每次都通过跟区间的中间元素对比，将待查找的区间缩小为之前的一半，直到找到要查找的元素，或者区间被缩小为 0。）</p><ul><li>以在升序序列中查找目标元素为例，二分查找算法的<strong>实现思路</strong>是：<ol><li>初始状态下，将整个序列作为搜索区域（假设为 [B, E]）；</li><li>找到搜索区域内的中间元素（假设所在位置为 M），和目标元素进行比对。如果相等，则搜索成功；如果中间元素大于目标元素，将左侧 [B, M-1] 作为新的搜素区域；反之，若中间元素小于目标元素，将右侧 [M+1, E] 作为新的搜素区域；</li><li>重复执行第二步，直至找到目标元素。如果搜索区域无法再缩小，且区域内不包含任何元素，表明整个序列中没有目标元素，查找失败。<span id="more"></span></li></ol></li></ul><h3 id="1-标准二分查找"><a href="#1-标准二分查找" class="headerlink" title="1. 标准二分查找"></a>1. 标准二分查找</h3><p>二分查找递归实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二分查找</span></span><br><span class="line"><span class="comment"> * 如果存在，返回其索引，否则返回 -1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> searchRecursion(nums, <span class="number">0</span>, nums.length - <span class="number">1</span>, target);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 递归实现</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">searchRecursion</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> left, <span class="type">int</span> right, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (left &gt; right) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// mid = left + (right - left) / 2;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>  left + ((right - left) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">        <span class="keyword">return</span> mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">        <span class="keyword">return</span> searchRecursion(nums, mid+<span class="number">1</span>, right, target);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> searchRecursion(nums, left, mid-<span class="number">1</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>二分查找循环实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二分查找循环实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">high</span> <span class="operator">=</span> arr.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>  low + ((high - low) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (arr[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] &lt; target) &#123;</span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            high = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>二分查找虽然性能比较优秀，但应用场景也比较有限。<br>底层必须依赖<strong>数组</strong>，并且还要求数据是<strong>有序</strong>的。<br>对于较小规模的数据查找，我们直接使用顺序遍历就可以了，二分查找的优势并不明显。<br>二分查找更适合处理静态数据，也就是没有频繁的数据插入、删除操作。</p><h3 id="2-二分查找左边界"><a href="#2-二分查找左边界" class="headerlink" title="2. 二分查找左边界"></a>2. 二分查找左边界</h3><p>查找第一个值等于给定值的元素</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">leftSearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> nums.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>  left + ((right - left) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mid == <span class="number">0</span>) || (nums[mid - <span class="number">1</span>] != target)) <span class="keyword">return</span> mid;</span><br><span class="line">            <span class="comment">// 即使我们找到了nums[mid] == target, 这个mid的位置也不一定就是最左侧的那个边界，</span></span><br><span class="line">            <span class="comment">// nums[mid - 1] == target，继续收缩右边界</span></span><br><span class="line">            <span class="keyword">else</span> right = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">            left = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &gt; target) &#123;</span><br><span class="line">            right = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-二分查找右边界"><a href="#3-二分查找右边界" class="headerlink" title="3. 二分查找右边界"></a>3. 二分查找右边界</h3><p>查找最后一个值等于给定值的元素</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">rightSearch</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> nums.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>  left + ((right - left) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mid == nums.length - <span class="number">1</span>) || (nums[mid + <span class="number">1</span>] != target)) <span class="keyword">return</span> mid;</span><br><span class="line">            <span class="comment">// 即使我们找到了nums[mid] == target, 这个mid的位置也不一定就是最右侧的那个边界，</span></span><br><span class="line">            <span class="comment">// nums[mid + 1] == target，继续收缩左边界</span></span><br><span class="line">            <span class="keyword">else</span> left = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">            left = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[mid] &gt; target) &#123;</span><br><span class="line">            right = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;二分查找（Binary Search）又称折半查找、二分搜索、折半搜索等，查找思想有点类似&lt;strong&gt;分治思想&lt;/strong&gt;，对应的时间复杂度为&lt;code&gt;O(logn)&lt;/code&gt;。&lt;br&gt;二分查找算法仅适用于&lt;strong&gt;有序&lt;/strong&gt;且使用&lt;strong&gt;顺序存储结构&lt;/strong&gt;的序列（比如有序数组）。&lt;br&gt;核心思想是：不断地缩小搜索区域，降低查找目标元素的难度。（每次都通过跟区间的中间元素对比，将待查找的区间缩小为之前的一半，直到找到要查找的元素，或者区间被缩小为 0。）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;以在升序序列中查找目标元素为例，二分查找算法的&lt;strong&gt;实现思路&lt;/strong&gt;是：&lt;ol&gt;
&lt;li&gt;初始状态下，将整个序列作为搜索区域（假设为 [B, E]）；&lt;/li&gt;
&lt;li&gt;找到搜索区域内的中间元素（假设所在位置为 M），和目标元素进行比对。如果相等，则搜索成功；如果中间元素大于目标元素，将左侧 [B, M-1] 作为新的搜素区域；反之，若中间元素小于目标元素，将右侧 [M+1, E] 作为新的搜素区域；&lt;/li&gt;
&lt;li&gt;重复执行第二步，直至找到目标元素。如果搜索区域无法再缩小，且区域内不包含任何元素，表明整个序列中没有目标元素，查找失败。</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」排序算法</title>
    <link href="http://chaooo.github.io/2022/05/25/data-structure-sort.html"/>
    <id>http://chaooo.github.io/2022/05/25/data-structure-sort.html</id>
    <published>2022-05-25T12:02:00.000Z</published>
    <updated>2022-08-27T08:37:48.462Z</updated>
    
    <content type="html"><![CDATA[<p>排序算法可以分为内部排序和外部排序，内部排序是数据记录在内存中进行排序，而外部排序是因排序的数据很大，一次不能容纳全部的排序记录，在排序过程中需要访问外存。常见的内部排序算法有：插入排序、希尔排序、选择排序、冒泡排序、归并排序、快速排序、堆排序、基数排序等。</p><span id="more"></span><p>用一张图概括：</p><p><img src="/2022/05/25/data-structure-sort/12_01.png"></p><p>名词解释：</p><ul><li><code>n</code>：数据规模</li><li><code>k</code>：”桶”的个数</li><li><code>In-place</code>：占用常数内存，不占用额外内存</li><li><code>Out-place</code>：占用额外内存</li><li><code>稳定性</code>：排序后 2 个相等键值的顺序和排序之前它们的顺序相同</li></ul><table><thead><tr><th align="left">内部排序</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">冒泡排序</td><td align="left">（无序区，有序区）<br> 从无序区通过交换找出最大元素放到有序区最前端。</td></tr><tr><td align="left">选择排序</td><td align="left">（无序区，有序区）<br> 从无序区选择一个最小的元素放到有序区的末尾。比较多，交换少</td></tr><tr><td align="left">插入排序</td><td align="left">（无序区，有序区）<br> 把无序区的第一个元素插入到有序区合适的位置。比较少，交换多</td></tr><tr><td align="left">希尔排序</td><td align="left">通过比较相距一定间隔的元素来进行（每一定间隔取一个元素组成子序列），各趟比较所用的距离随着算法的进行而减小，直到只比较相邻元素的最后一趟排序为止。</td></tr><tr><td align="left">归并排序</td><td align="left">把数组从中间分成前后两部分，分别排序，再将排好序的两部分合并。</td></tr><tr><td align="left">快速排序</td><td align="left">（小数，基准，大数）<br> 随机一个元素作为基准数，将小于基准的元素放在基准之前，大于基准的放在基准之后，再分别对小数区与大数区进行排序。</td></tr><tr><td align="left">堆排序</td><td align="left">（大顶堆，有序区）<br> 取出堆顶元素放在有序区，再恢复堆。</td></tr><tr><td align="left">计数排序</td><td align="left">统计小于等于该元素值的元素个数i,于是该元素就放在目标数组的索引i位（i&gt;&#x3D;0）。</td></tr><tr><td align="left">桶排序</td><td align="left">将值为i的元素放在i号桶，最后依次把桶里元素倒出来。</td></tr><tr><td align="left">基数排序</td><td align="left">一种多关键字的排序算法，可用桶排序实现。</td></tr></tbody></table><h3 id="1-冒泡排序（Bubble-Sort）"><a href="#1-冒泡排序（Bubble-Sort）" class="headerlink" title="1. 冒泡排序（Bubble Sort）"></a>1. 冒泡排序（Bubble Sort）</h3><p><code>冒泡排序（Bubble Sort）</code>是一种简单直观的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果他们的顺序错误就把他们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。</p><ul><li>冒泡排序步骤：<ol><li>比较相邻的元素。如果第一个比第二个大，就交换他们两个。</li><li>对每一对相邻元素作同样的工作，从开始第一对到结尾的最后一对。这步做完后，最后的元素会是最大的数。</li><li>针对所有的元素重复以上的步骤，除了最后一个。</li><li>持续每次对越来越少的元素重复上面的步骤，直到没有任何一对数字需要比较。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_bubble.gif"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 冒泡排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bubbleSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="comment">// 若已有序，提前退出标志位</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(arr[j] &gt; arr[j+<span class="number">1</span>])&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[j];</span><br><span class="line">                arr[j] = arr[j+<span class="number">1</span>];</span><br><span class="line">                arr[j+<span class="number">1</span>] = temp;</span><br><span class="line">                <span class="comment">// 发生交换</span></span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">            <span class="comment">// 若已有序,未发生交换，提前退出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-选择排序（Selection-sort）"><a href="#2-选择排序（Selection-sort）" class="headerlink" title="2. 选择排序（Selection sort）"></a>2. 选择排序（Selection sort）</h3><p><code>选择排序（Selection sort）</code>是一种简单直观的排序算法。 它的工作原理是：第一次从待排序的数据元素中选出最小（或最大）的一个元素，存放在序列的起始位置，然后再从剩余的未排序元素中寻找到最小（大）元素，然后放到已排序的序列的末尾。 以此类推，直到全部待排序的数据元素的个数为零。 选择排序是不稳定的排序方法。</p><ul><li>冒泡排序步骤：<ol><li>首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置。</li><li>再从剩余未排序元素中继续寻找最小（大）元素，然后放到已排序序列的末尾。</li><li>重复第二步，直到所有元素均排序完毕。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_selection.gif"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选择排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectionSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len-<span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> min=i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i+<span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(arr[j] &lt; arr[min])&#123;</span><br><span class="line">                min = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i != min)&#123;</span><br><span class="line">            <span class="comment">// 交换</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">            arr[i] = arr[min];</span><br><span class="line">            arr[min] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-插入排序（Insertion-Sort）"><a href="#3-插入排序（Insertion-Sort）" class="headerlink" title="3. 插入排序（Insertion Sort）"></a>3. 插入排序（Insertion Sort）</h3><p><code>插入排序（Insertion Sort）</code>是一种最简单直观的排序算法，一般也被称为直接插入排序。<br>通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p><ul><li>插入排序步骤：<ol><li>将第一待排序序列第一个元素看做一个有序序列，把第二个元素到最后一个元素当成是未排序序列。</li><li>从头到尾依次扫描未排序序列，将扫描到的每个元素插入有序序列的适当位置。（如果待插入的元素与有序序列中的某个元素相等，则将待插入元素插入到相等元素的后面。）</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_insertion.gif"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertionSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (; j &gt;=<span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &gt; temp)&#123;</span><br><span class="line">                arr[j+<span class="number">1</span>] = arr[j];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        arr[j+<span class="number">1</span>] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-希尔排序（Shell-Sort）"><a href="#4-希尔排序（Shell-Sort）" class="headerlink" title="4. 希尔排序（Shell Sort）"></a>4. 希尔排序（Shell Sort）</h3><p><code>希尔排序（Shell Sort）</code>是插入排序的一种更高效的改进版本；又称缩小增量排序，因 DL.Shell 于 1959 年提出而得名。<br>通过比较相距一定间隔的元素来进行（每一定间隔取一个元素组成子序列），各趟比较所用的距离随着算法的进行而减小，直到只比较相邻元素的最后一趟排序为止。</p><ul><li>希尔排序步骤：<ol><li>将 len 个元素的数组序列 分割为间隔 gap (gap &#x3D; len&#x2F;2) 的子序列（每间隔 gap 取一个元素）</li><li>在每一个子序列中分别采用直接插入排序。</li><li>然后缩小间隔 gap，将 gap &#x3D; gap&#x2F;2。</li><li>重复上述的子序列划分和排序工作，随着序列减少最后变为一个，也就完成了整个排序。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_shell.png"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 希尔排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shellSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">gap</span> <span class="operator">=</span> len/<span class="number">2</span>; gap &gt; <span class="number">0</span>; gap = gap/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> gap; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i-gap;</span><br><span class="line">            <span class="keyword">for</span> (; j &gt;=<span class="number">0</span>; j = j-gap) &#123;</span><br><span class="line">                <span class="keyword">if</span> (arr[j] &gt; temp)&#123;</span><br><span class="line">                    arr[j+gap] = arr[j];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[j+gap] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-归并排序（Merge-sort）"><a href="#5-归并排序（Merge-sort）" class="headerlink" title="5. 归并排序（Merge sort）"></a>5. 归并排序（Merge sort）</h3><p>归并排序（Merge sort）是建立在归并操作上的一种有效、稳定的排序算法，该算法是采用分治法(Divide and Conquer）的一个非常典型的应用。<br>将已有序的子序列合并，得到完全有序的序列；即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为二路归并。<br>归并排序使用的就是分治思想。分治算法一般都是用递归来实现的。分治是一种解决问题的处理思想，递归是一种编程技巧，这两者并不冲突。</p><ul><li>归并排序步骤：<ol><li>先把数组从中间分成前后两部分子序列，然后对前后两部分分别排序，然后再合并。</li><li>前后两部分子序列递归重复上述步骤。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_merge.png"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 归并排序（稳定的排序算法）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mergeSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    mergeSortRecursion(arr, <span class="number">0</span>, len-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 归并排序递归调用函数</span></span><br><span class="line"><span class="comment"> * 给下标从 p 到 r 之间的数组排序。我们将这个排序问题转化为了两个子问题，</span></span><br><span class="line"><span class="comment"> * 分割点下标 q 等于 p 和 r 的中间位置，也就是 (p+r)/2。当下标从 p 到 q 和从 q+1 到 r 这两个子数组都排好序之后，我们再将两个有序的子数组合并在一起，这样下标从 p 到 r 之间的数据就也排好序了。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mergeSortRecursion</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> p, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p == r) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 分割点下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> p + (r-p)/<span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 递归左边排序</span></span><br><span class="line">    mergeSortRecursion(arr, p, q);</span><br><span class="line">    <span class="comment">// 递归右边排序</span></span><br><span class="line">    mergeSortRecursion(arr, q+<span class="number">1</span>, r);</span><br><span class="line">    <span class="comment">// 合并左右</span></span><br><span class="line">    mergeResult(arr, p, q, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 合并</span></span><br><span class="line"><span class="comment"> * 将已经有序的 A[p...q]和 A[q+1....r]合并成一个有序的数组，并且放入 A[p....r]。</span></span><br><span class="line"><span class="comment"> * 具体我们申请一个临时数组 tmp，大小与 A[p...r]相同。我们用两个游标 i 和 j，分别指向 A[p...q]和 A[q+1...r]的第一个元素。比较这两个元素 A[i]和 A[j]，如果 A[i]&lt;=A[j]，我们就把 A[i]放入到临时数组 tmp，并且 i 后移一位，否则将 A[j]放入到数组 tmp，j 后移一位。</span></span><br><span class="line"><span class="comment"> * 继续上述比较过程，直到其中一个子数组中的所有数据都放入临时数组中，再把另一个数组中剩余的数据依次加入到临时数组的末尾，这个时候，临时数组中存储的就是两个子数组合并之后的结果了。最后再把临时数组 tmp 中的数据拷贝到原数组 A[p...r]中。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mergeResult</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> p, <span class="type">int</span> q, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] temp = <span class="keyword">new</span> <span class="title class_">int</span>[r-p+<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// i是arr前半部分下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> p;</span><br><span class="line">    <span class="comment">// j是arr后半部分下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> q +<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// k是临时新数组temp下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 当arr数组两边都还有数时,依次从小到大拷贝到临时新数组temp</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= q &amp;&amp; j &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt;= arr[j]) &#123;</span><br><span class="line">            temp[k] = arr[i];</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp[k] = arr[j];</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        k++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断哪个子数组中有剩余的数据</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> i, end = q;</span><br><span class="line">    <span class="keyword">if</span> (j &lt;= r) &#123;</span><br><span class="line">        <span class="comment">// arr后半部分还有剩余(初始化时默认前半部分还有剩余)</span></span><br><span class="line">        start = j;</span><br><span class="line">        end = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将剩余的数据拷贝到临时数组temp</span></span><br><span class="line">    <span class="keyword">while</span> (start &lt;= end) &#123;</span><br><span class="line">        temp[k++] = arr[start++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将排好序的temp数组拷贝回arr[p...r]</span></span><br><span class="line">    System.arraycopy(temp, <span class="number">0</span>, arr, p, temp.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-快速排序（Quick-Sort）"><a href="#6-快速排序（Quick-Sort）" class="headerlink" title="6. 快速排序（Quick Sort）"></a>6. 快速排序（Quick Sort）</h3><p>快速排序使用分治法（Divide and conquer）策略来把一个序列（list）分为两个子序列（sub-lists）。快速排序又是一种分而治之思想在排序算法上的典型应用。本质上来看，快速排序应该算是在冒泡排序基础上的递归分治法。</p><p>通过一趟排序将要排序的数据分割成独立的两部分，其中一部分的所有数据都比另外一部分的所有数据都要小，然后再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。</p><p>排序算法的思想非常简单，在待排序的数列中，我们首先要找一个数字作为基准数。把小于基准数的元素移动到待排序的数列的左边，把大于基准数的元素移动到待排序的数列的右边。这时，左右两个分区的元素就相对有序了；接着把两个分区的元素分别按照上面两种方法继续对每个分区找出基准数，然后移动，直到各个分区只有一个数时为止。</p><ul><li>快速排序步骤：<ol><li>从数列中挑出一个元素，称为 “基准”（pivot）。</li><li>将小于基准的元素放在基准之前，大于基准的放在基准之后，再分别对小数区与大数区进行快速排序。</li><li>小数区与大数区子序列递归地重复上述步骤（直到分区子序列的大小是0或1）。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_quick.png"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    quickSortRecursion(arr, <span class="number">0</span>, len-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速排序递归函数，p,r为下标</span></span><br><span class="line"><span class="comment"> * 根据分治、递归的处理思想，我们可以用递归排序下标从 p 到 q-1 之间的数据和下标从 q+1 到 r 之间的数据，直到区间缩小为 1，就说明所有的数据都有序了。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">quickSortRecursion</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> p, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p &gt;= r) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 获取分区点下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> getPartitionIndex(arr, p, r);</span><br><span class="line">    System.out.println(<span class="string">&quot;pivotIndex=: &quot;</span> + q + <span class="string">&quot;,pivot=&quot;</span> + arr[q]);</span><br><span class="line">    System.out.println(Arrays.toString(Arrays.copyOfRange(arr, p, r+<span class="number">1</span>)));</span><br><span class="line">    <span class="comment">// 用递归排序下标从 p 到 q-1 之间的数据</span></span><br><span class="line">    quickSortRecursion(arr, p, q-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 用递归排序下标从 q+1 到 r 之间的数据</span></span><br><span class="line">    quickSortRecursion(arr, q+<span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取分区点</span></span><br><span class="line"><span class="comment"> * 随机选择一个元素作为分区点 pivot（一般情况下，可以选择 p 到 r 区间的最后一个元素），然后对 A[p...r]分区，返回 pivot 的下标。</span></span><br><span class="line"><span class="comment"> * 遍历 p 到 r 之间的数据，将小于 pivot 的放到左边，将大于 pivot 的放到右边，将 pivot 放到中间。经过这一步骤之后，数组 p 到 r 之间的数据就被分成了三个部分，前面 p 到 q-1 之间都是小于 pivot 的，中间是 pivot，后面的 q+1 到 r 之间是大于 pivot 的。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getPartitionIndex</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> p, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pivot</span> <span class="operator">=</span> arr[r];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> p;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> p; j &lt; r; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[j] &lt; pivot) &#123;</span><br><span class="line">            swapArr(arr, i, j);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    swapArr(arr, i, r);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swapArr</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[a];</span><br><span class="line">    arr[a] = arr[b];</span><br><span class="line">    arr[b] = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-堆排序（Heap-Sort）"><a href="#7-堆排序（Heap-Sort）" class="headerlink" title="7. 堆排序（Heap Sort）"></a>7. 堆排序（Heap Sort）</h3><p>堆排序（Heap Sort）是指利用堆这种数据结构所设计的一种排序算法。<br>堆积是一个近似完全二叉树的结构，并同时满足堆积的性质：即子结点的键值或索引总是小于（或者大于）它的父节点。<br>堆排序可以说是一种利用堆的概念来排序的选择排序。分为两种方法：</p><ul><li><p>大顶堆：每个节点的值都大于或等于其子节点的值，在堆排序算法中用于升序排列；</p></li><li><p>小顶堆：每个节点的值都小于或等于其子节点的值，在堆排序算法中用于降序排列；</p></li><li><p>堆排序步骤：</p><ol><li>创建一个堆（建堆后数组中的第一个元素就是堆顶，大顶堆的堆顶也就是最大的元素）。</li><li>堆顶（最大值）和堆尾互换（最大元素就放到了下标为 <code>n</code> 的位置）。</li><li>剩下 <code>n-1</code> 个元素重复这个过程(堆化-&gt;取堆顶)。</li><li>直到最后堆中只剩下标为 1 的一个元素，排序完成。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_heap.png"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  堆排序</span></span><br><span class="line"><span class="comment"> *  len 表示数据的个数，数组a中的数据从下标1到n的位置。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">heapSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    buildHeap(arr, len);</span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> len;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        swapArr(arr, <span class="number">1</span>, k);</span><br><span class="line">        --k;</span><br><span class="line">        heapify(arr, k, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建堆</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildHeap</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> len/<span class="number">2</span>; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        heapify(arr, len, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 堆化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxPos</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="keyword">if</span> (i*<span class="number">2</span> &lt;= len &amp;&amp; arr[i] &lt; arr[i*<span class="number">2</span>]) maxPos = i*<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (i*<span class="number">2</span>+<span class="number">1</span> &lt;= len &amp;&amp; arr[maxPos] &lt; arr[i*<span class="number">2</span>+<span class="number">1</span>]) maxPos = i*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (maxPos == i) <span class="keyword">break</span>;</span><br><span class="line">        swapArr(arr, i, maxPos);</span><br><span class="line">        i = maxPos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swapArr</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[a];</span><br><span class="line">    arr[a] = arr[b];</span><br><span class="line">    arr[b] = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-计数排序（Counting-Sort）"><a href="#8-计数排序（Counting-Sort）" class="headerlink" title="8. 计数排序（Counting Sort）"></a>8. 计数排序（Counting Sort）</h3><p>计数排序（Counting Sort）是一种牺牲内存空间来换取低时间复杂度的排序算法，同时它也是一种不基于比较的算法。<br>它的优势在于在对一定范围内的整数排序时，它的复杂度为<code>Ο(n+k)</code>（其中k是整数的范围），快于任何比较排序算法。<br>它适合于最大值和最小值的差值不是不是很大的排序。</p><p>基本思想：就是把数组元素作为数组的下标，然后用一个临时数组统计该元素出现的次数，例如 temp[i] &#x3D; m, 表示元素 i 一共出现了 m 次。最后再把临时数组统计的数据从小到大汇总起来，此时汇总起来是数据是有序的。</p><ul><li>计数排序步骤：<ol><li>找出待排序数组中最大值 <code>max</code> 和最小值 <code>min</code>；</li><li>创建临时数组，大小为 <code>(max - min + 1)</code>；</li><li>统计待排序数组中每个值为<code>i</code>的元素出现的次数，存入临时数组的第<code>i</code>项；</li><li>反向填充目标数组：依次从临时数组中取出放入新数组。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_counting.gif"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计数排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countingSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 寻找数组的最大值与最小值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> getMin(arr);</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> getMax(arr);</span><br><span class="line">    <span class="comment">// 创建大小为(max - min + 1)的临时数组</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">range</span> <span class="operator">=</span> max - min + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span>[] temp = <span class="keyword">new</span> <span class="title class_">int</span>[range];</span><br><span class="line">    <span class="comment">// 统计元素i出现的次数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        temp[arr[i] - min]++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把临时数组统计好的数据汇总到原数组</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; range; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> temp[i]; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">            arr[k++] = i + min;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 寻找数组的最大值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMax</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> value : arr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (max &lt; value) &#123;</span><br><span class="line">            max = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 寻找数组的最小值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMin</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> value : arr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (min &gt; value) &#123;</span><br><span class="line">            min = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> min;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-桶排序（Bucket-Sort）"><a href="#9-桶排序（Bucket-Sort）" class="headerlink" title="9. 桶排序（Bucket Sort）"></a>9. 桶排序（Bucket Sort）</h3><p>桶排序（Bucket sort）是计数排序的升级版。核心思想是将要排序的数据分到几个有序的“桶”里，每个桶里的数据再单独进行排序。<br>桶内排完序之后，再把每个桶里的数据按照顺序依次取出，组成的序列就是有序的了。<br>桶排序的表现取决于数据的分布。当数据在各个桶之间的分布是比较均匀的，排序效率非常高；在极端情况下，如果数据都被划分到一个桶里，那就退化为 O(nlogn) 的排序算法了。</p><p><img src="/2022/05/25/data-structure-sort/12_bucket.png"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 桶排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bucketSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 寻找数组的最大值与最小值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> getMin(arr);</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> getMax(arr);</span><br><span class="line">    <span class="comment">// 创建 (max - min) / 5 + 1 个桶，第 i 桶存放  5*i ~ 5*i+5-1范围的数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">range</span> <span class="operator">=</span> max - min;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bucketNum</span> <span class="operator">=</span> range / <span class="number">5</span> + <span class="number">1</span>;</span><br><span class="line">    ArrayList&lt;LinkedList&lt;Integer&gt;&gt; bucketList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(bucketNum);</span><br><span class="line">    <span class="comment">// 初始化桶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        bucketList.add(<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Integer&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历原数组，将每个元素放入桶中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> a : arr) &#123;</span><br><span class="line">        bucketList.get((a - min) / range).add(a - min);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对桶内的元素进行排序，我这里采用系统自带的排序工具</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        Collections.sort(bucketList.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//把每个桶排序好的数据进行合并汇总放回原数组</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer t : bucketList.get(i)) &#123;</span><br><span class="line">            arr[k++] = t + min;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-基数排序（Radix-Sort）"><a href="#10-基数排序（Radix-Sort）" class="headerlink" title="10. 基数排序（Radix Sort）"></a>10. 基数排序（Radix Sort）</h3><p>基数排序（Radix Sort）要求数据可以划分成高低位，位之间有递进关系。比较两个数，我们只需要比较高位，高位相同的再比较低位。<br>而且每一位的数据范围不能太大，因为基数排序算法需要借助桶排序或者计数排序来完成每一个位的排序工作。<br>基数排序的方式可以采用最低位优先LSD（Least sgnificant digital）法或最高位优先MSD（Most sgnificant digital）法，LSD的排序方式由键值的最右边开始，而MSD则相反，由键值的最左边开始。</p><ul><li>基数排序步骤：<ol><li>将所有待比较数值统一为同样的数位长度，数位较短的数前面补零。</li><li>然后，从最低位开始，依次进行一次排序。</li><li>这样从最低位排序一直到最高位排序完成以后, 数列就变成一个有序序列。</li></ol></li></ul><p><img src="/2022/05/25/data-structure-sort/12_radix.gif"></p><p>Java代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基数排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">radixSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">1</span> ) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 计算最大值是几位数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> getMaxNum(arr);</span><br><span class="line">    <span class="comment">// 创建10个桶</span></span><br><span class="line">    ArrayList&lt;LinkedList&lt;Integer&gt;&gt; bucketList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// 初始化桶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        bucketList.add(<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Integer&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行每一趟的排序，从个位数开始排</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= num; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">            <span class="comment">// 获取每个数最后第 i 位是数组</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">radio</span> <span class="operator">=</span> (arr[j] / (<span class="type">int</span>)Math.pow(<span class="number">10</span>,i-<span class="number">1</span>)) % <span class="number">10</span>;</span><br><span class="line">            <span class="comment">// 放进对应的桶里</span></span><br><span class="line">            bucketList.get(radio).add(arr[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 合并放回原数组</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Integer t : bucketList.get(j)) &#123;</span><br><span class="line">                arr[k++] = t;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取出来合并了之后把桶清光数据</span></span><br><span class="line">            bucketList.get(j).clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算最大值是几位数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMaxNum</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> arr[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 寻找数组的最大值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> value : arr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (max &lt; value) &#123;</span><br><span class="line">            max = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算最大值是几位数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (max / <span class="number">10</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        num++;</span><br><span class="line">        max = max / <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;排序算法可以分为内部排序和外部排序，内部排序是数据记录在内存中进行排序，而外部排序是因排序的数据很大，一次不能容纳全部的排序记录，在排序过程中需要访问外存。常见的内部排序算法有：插入排序、希尔排序、选择排序、冒泡排序、归并排序、快速排序、堆排序、基数排序等。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」图（Graph）</title>
    <link href="http://chaooo.github.io/2022/05/10/data-structure-graph.html"/>
    <id>http://chaooo.github.io/2022/05/10/data-structure-graph.html</id>
    <published>2022-05-10T11:02:00.000Z</published>
    <updated>2022-08-23T08:26:55.421Z</updated>
    
    <content type="html"><![CDATA[<p><strong>图（Graph）</strong>。和树比起来，这是一种<strong>更加复杂的非线性表结构</strong>，由顶点和连接每对顶点的边所构成的抽象网络就是图。</p><p>图的定义：图是由顶点的有穷非空集合和顶点之间边的集合组成，通常表示为：<code>G(V,E)</code>，其中，<code>G</code>表示一个图，<code>V</code>是顶点的集合，<code>E</code>是边的集合。</p><p>图中的元素叫做<code>顶点（vertex）</code>。顶点与其他顶点建立的连接关系叫做<code>边（edge）</code>。跟顶点相连接的边的条数叫做顶点的<code>度（degree）</code>。</p><p>如果图中任意两个顶点之间的边都是无向边（边没有方向），则称该图为<code>无向图（Undirected graphs）</code>。<br>以此类推，把边有方向的图称为<code>有向图（Directed graphs）</code>。</p><ul><li>完全图：<ul><li>①无向完全图：在无向图中，如果任意两个顶点之间都存在边，则称该图为无向完全图。</li><li>②有向完全图：在有向图中，如果任意两个顶点之间都存在方向互为相反的两条弧，则称该图为有向完全图。</li></ul></li><li>当一个图接近完全图时，则称它为<code>稠密图（Dense Graph）</code>，而当一个图含有较少的边时，则称它为<code>稀疏图（Spare Graph）</code>。<span id="more"></span></li></ul><h3 id="1-图的存储方式"><a href="#1-图的存储方式" class="headerlink" title="1. 图的存储方式"></a>1. 图的存储方式</h3><p>图的两个主要的存储方式：<strong>邻接矩阵</strong>和<strong>邻接表</strong>。<br>邻接矩阵存储方法的缺点是比较浪费空间，但是优点是查询效率高，而且方便矩阵运算。<br>邻接表存储方法中每个顶点都对应一个链表，存储与其相连接的其他顶点。尽管邻接表的存储方式比较节省存储空间，但链表不方便查找，所以查询效率没有邻接矩阵存储方式高。针对这个问题，邻接表还有改进升级版，即将链表换成更加高效的动态数据结构，比如平衡二叉查找树、跳表、散列表等。</p><h4 id="邻接矩阵（Adjacency-Matrix）"><a href="#邻接矩阵（Adjacency-Matrix）" class="headerlink" title="邻接矩阵（Adjacency Matrix）"></a>邻接矩阵（Adjacency Matrix）</h4><p>邻接矩阵的底层依赖一个二维数组。<br>对于无向图来说，如果顶点 <code>i</code> 与顶点 <code>j</code> 之间有边，我们就将 <code>A[i][j]</code>和 <code>A[j][i]</code>标记为 <code>1</code>；<br>对于有向图来说，如果顶点 <code>i</code> 到顶点 <code>j</code> 之间，有一条箭头从顶点 <code>i</code> 指向顶点 <code>j</code> 的边，那我们就将 <code>A[i][j]</code>标记为 <code>1</code>；<br>对于带权图，数组中就存储相应的权重。</p><p><img src="/2022/05/10/data-structure-graph/11_01.webp"><br>用邻接矩阵来表示一个图，虽然简单、直观，但是比较浪费存储空间。</p><h4 id="邻接表（Adjacency-List）"><a href="#邻接表（Adjacency-List）" class="headerlink" title="邻接表（Adjacency List）"></a>邻接表（Adjacency List）</h4><p>图中画的是一个有向图的邻接表存储方式，每个顶点对应的链表里面，存储的是指向的顶点。<br>对于无向图来说，也是类似的，不过，每个顶点的链表中存储的，是跟这个顶点有边相连的顶点。</p><p><img src="/2022/05/10/data-structure-graph/11_02.webp"><br>邻接矩阵存储起来比较浪费空间，但是使用起来比较节省时间。相反，邻接表存储起来比较节省空间，但是使用起来就比较耗时间。</p><p>可以将邻接表中的链表改成更加高效的动态数据结构，比如平衡二叉查找树、跳表、散列表、有序动态数组等。</p><h3 id="2-深度和广度优先搜索"><a href="#2-深度和广度优先搜索" class="headerlink" title="2. 深度和广度优先搜索"></a>2. 深度和广度优先搜索</h3><p>算法是作用于具体数据结构之上的，深度优先搜索算法和广度优先搜索算法都是基于“图”这种数据结构的。<br>这是因为，图这种数据结构的表达能力很强，大部分涉及搜索的场景都可以抽象成“图”。</p><h4 id="2-1-广度优先搜索（BFS）"><a href="#2-1-广度优先搜索（BFS）" class="headerlink" title="2.1 广度优先搜索（BFS）"></a>2.1 广度优先搜索（BFS）</h4><p><code>广度优先搜索（Breadth-First-Search）</code>，我们平常都简称 <code>BFS</code>。直观地讲，它其实就是一种“地毯式”层层推进的搜索策略，即先查找离起始顶点最近的，然后是次近的，依次往外搜索。</p><p><img src="/2022/05/10/data-structure-graph/11_03.webp"></p><p>尽管广度优先搜索的原理挺简单，但代码实现还是稍微有点复杂度。</p><p>代码里面，<code>bfs()</code> 函数就是基于之前定义的，图的广度优先搜索的代码实现。其中 <code>s</code> 表示起始顶点，<code>t</code> 表示终止顶点。我们搜索一条从 <code>s</code> 到 <code>t</code> 的路径。实际上，这样求得的路径就是从 <code>s</code> 到 <code>t</code> 的最短路径。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 广度优先搜索</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int s 起始顶点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int t 终止顶点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bfs</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> t)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (s == t) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// visited 是用来记录已经被访问的顶点，用来避免顶点被重复访问。</span></span><br><span class="line">  <span class="comment">// 如果顶点 q 被访问，那相应的 visited[q]会被设置为 true</span></span><br><span class="line">  <span class="type">boolean</span>[] visited = <span class="keyword">new</span> <span class="title class_">boolean</span>[v];</span><br><span class="line">  visited[s]=<span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// queue 是一个队列，用来存储已经被访问、但相连的顶点还没有被访问的顶点。</span></span><br><span class="line">  <span class="comment">// 因为广度优先搜索是逐层访问的，也就是说，我们只有把第 k 层的顶点都访问完成之后，才能访问第 k+1 层的顶点。</span></span><br><span class="line">  <span class="comment">// 当我们访问到第 k 层的顶点的时候，我们需要把第 k 层的顶点记录下来，稍后才能通过第 k 层的顶点来找第 k+1 层的顶点。</span></span><br><span class="line">  <span class="comment">// 所以，我们用这个队列来实现记录的功能。</span></span><br><span class="line">  Queue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">  queue.add(s);</span><br><span class="line">  <span class="comment">// prev 用来记录搜索路径。</span></span><br><span class="line">  <span class="comment">// 当我们从顶点 s 开始，广度优先搜索到顶点 t 后，prev 数组中存储的就是搜索的路径。</span></span><br><span class="line">  <span class="comment">// 不过，这个路径是反向存储的。prev[w]存储的是，顶点 w 是从哪个前驱顶点遍历过来的。</span></span><br><span class="line">  <span class="comment">// 比如，我们通过顶点 2 的邻接表访问到顶点 3，那 prev[3]就等于 2。</span></span><br><span class="line">  <span class="comment">// 为了正向打印出路径，我们需要递归地来打印。</span></span><br><span class="line">  <span class="type">int</span>[] prev = <span class="keyword">new</span> <span class="title class_">int</span>[v];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; v; ++i) &#123;</span><br><span class="line">    prev[i] = -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (queue.size() != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; adj[w].size(); ++i) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> adj[w].get(i);</span><br><span class="line">      <span class="keyword">if</span> (!visited[q]) &#123;</span><br><span class="line">        prev[q] = w;</span><br><span class="line">        <span class="keyword">if</span> (q == t) &#123;</span><br><span class="line">          print(prev, s, t);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        visited[q] = <span class="literal">true</span>;</span><br><span class="line">        queue.add(q);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归打印s-&gt;t的路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">int</span>[] prev, <span class="type">int</span> s, <span class="type">int</span> t)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (prev[t] != -<span class="number">1</span> &amp;&amp; t != s) &#123;</span><br><span class="line">    print(prev, s, prev[t]);</span><br><span class="line">  &#125;</span><br><span class="line">  System.out.print(t + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>广度优先搜索的分解图：</p><p><img src="/2022/05/10/data-structure-graph/11_04.webp"><br><img src="/2022/05/10/data-structure-graph/11_05.webp"><br><img src="/2022/05/10/data-structure-graph/11_06.webp"></p><p>最坏情况下，终止顶点 <code>t</code> 离起始顶点 <code>s</code> 很远，需要遍历完整个图才能找到。<br>这个时候，每个顶点都要进出一遍队列，每个边也都会被访问一次，所以，广度优先搜索的时间复杂度是 <code>O(V+E)</code>，其中，<code>V</code> 表示顶点的个数，<code>E</code> 表示边的个数。<br>当然，对于一个连通图来说，也就是说一个图中的所有顶点都是连通的，<code>E</code> 肯定要大于等于 <code>V-1</code>，所以，广度优先搜索的<strong>时间复杂度</strong>也可以简写为 <code>O(E)</code>。</p><p>广度优先搜索的空间消耗主要在几个辅助变量 <code>visited</code> 数组、<code>queue</code> 队列、<code>prev</code> 数组上。这三个存储空间的大小都不会超过顶点的个数，所以<strong>空间复杂度</strong>是 <code>O(V)</code>。</p><h4 id="2-2-深度优先搜索（DFS）"><a href="#2-2-深度优先搜索（DFS）" class="headerlink" title="2.2 深度优先搜索（DFS）"></a>2.2 深度优先搜索（DFS）</h4><p><code>深度优先搜索（Depth-First-Search）</code>，简称 <code>DFS</code>。最直观的例子就是“走迷宫”。<br>假设你站在迷宫的某个岔路口，然后想找到出口。你随意选择一个岔路口来走，走着走着发现走不通的时候，你就回退到上一个岔路口，重新选择一条路继续走，直到最终找到出口。这种走法就是一种深度优先搜索策略。</p><p>如下图。用深度递归算法搜索一条从 <code>s</code> 到 <code>t</code> 的路径，实线箭头表示遍历，虚线箭头表示回退。从图中我们可以看出，深度优先搜索找出来的路径，并不是顶点 <code>s</code> 到顶点 <code>t</code> 的最短路径。</p><p><img src="/2022/05/10/data-structure-graph/11_07.webp"></p><p>深度优先搜索用的是一种比较著名的算法思想，回溯思想。这种思想解决问题的过程，非常适合用递归来实现。</p><p>深度优先搜索代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 全局变量或者类成员变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> t)</span> &#123;</span><br><span class="line">  <span class="comment">// found，的作用是，当我们已经找到终止顶点 t 之后，我们就不再递归地继续查找了。</span></span><br><span class="line">  found = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">boolean</span>[] visited = <span class="keyword">new</span> <span class="title class_">boolean</span>[v];</span><br><span class="line">  <span class="type">int</span>[] prev = <span class="keyword">new</span> <span class="title class_">int</span>[v];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; v; ++i) &#123;</span><br><span class="line">    prev[i] = -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  recurDfs(s, t, visited, prev);</span><br><span class="line">  print(prev, s, t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recurDfs</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> t, <span class="type">boolean</span>[] visited, <span class="type">int</span>[] prev)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (found == <span class="literal">true</span>) <span class="keyword">return</span>;</span><br><span class="line">  visited[w] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (w == t) &#123;</span><br><span class="line">    found = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; adj[w].size(); ++i) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> adj[w].get(i);</span><br><span class="line">    <span class="keyword">if</span> (!visited[q]) &#123;</span><br><span class="line">      prev[q] = w;</span><br><span class="line">      recurDfs(q, t, visited, prev);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上图可以看出，每条边最多会被访问两次，一次是遍历，一次是回退。所以，图上的深度优先搜索算法的<strong>时间复杂度</strong>是 <code>O(E)</code>，<code>E</code> 表示边的个数。<br>深度优先搜索算法的消耗内存主要是 <code>visited</code>、<code>prev</code> 数组和递归调用栈。<code>visited</code>、<code>prev</code> 数组的大小跟顶点的个数 <code>V</code> 成正比，递归调用栈的最大深度不会超过顶点的个数，所以总的<strong>空间复杂度</strong>就是 <code>O(V)</code>。</p><h4 id="2-3-深度和广度优先搜索总结"><a href="#2-3-深度和广度优先搜索总结" class="headerlink" title="2.3 深度和广度优先搜索总结"></a>2.3 深度和广度优先搜索总结</h4><p>广度优先搜索和深度优先搜索是图上的两种最常用、最基本的搜索算法。广度优先搜索（BFS）和 深度优先搜索（DFS）搜索统称<strong>暴力搜索算法</strong>，适用于<strong>图不大的搜索</strong>。<br>广度优先搜索，通俗的理解就是，地毯式层层推进，从起始顶点开始，依次往外遍历。广度优先搜索需要借助队列来实现，遍历得到的路径就是，起始顶点到终止顶点的最短路径。<br>深度优先搜索用的是回溯思想，非常适合用递归实现。换种说法，深度优先搜索是借助栈来实现的。<br>在执行效率方面，深度优先和广度优先搜索的**时间复杂度都是 O(E)，空间复杂度是 O(V)**。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;图（Graph）&lt;/strong&gt;。和树比起来，这是一种&lt;strong&gt;更加复杂的非线性表结构&lt;/strong&gt;，由顶点和连接每对顶点的边所构成的抽象网络就是图。&lt;/p&gt;
&lt;p&gt;图的定义：图是由顶点的有穷非空集合和顶点之间边的集合组成，通常表示为：&lt;code&gt;G(V,E)&lt;/code&gt;，其中，&lt;code&gt;G&lt;/code&gt;表示一个图，&lt;code&gt;V&lt;/code&gt;是顶点的集合，&lt;code&gt;E&lt;/code&gt;是边的集合。&lt;/p&gt;
&lt;p&gt;图中的元素叫做&lt;code&gt;顶点（vertex）&lt;/code&gt;。顶点与其他顶点建立的连接关系叫做&lt;code&gt;边（edge）&lt;/code&gt;。跟顶点相连接的边的条数叫做顶点的&lt;code&gt;度（degree）&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;如果图中任意两个顶点之间的边都是无向边（边没有方向），则称该图为&lt;code&gt;无向图（Undirected graphs）&lt;/code&gt;。&lt;br&gt;以此类推，把边有方向的图称为&lt;code&gt;有向图（Directed graphs）&lt;/code&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;完全图：&lt;ul&gt;
&lt;li&gt;①无向完全图：在无向图中，如果任意两个顶点之间都存在边，则称该图为无向完全图。&lt;/li&gt;
&lt;li&gt;②有向完全图：在有向图中，如果任意两个顶点之间都存在方向互为相反的两条弧，则称该图为有向完全图。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;当一个图接近完全图时，则称它为&lt;code&gt;稠密图（Dense Graph）&lt;/code&gt;，而当一个图含有较少的边时，则称它为&lt;code&gt;稀疏图（Spare Graph）&lt;/code&gt;。</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」堆（Heap）</title>
    <link href="http://chaooo.github.io/2022/05/02/data-structure-heap.html"/>
    <id>http://chaooo.github.io/2022/05/02/data-structure-heap.html</id>
    <published>2022-05-02T14:10:01.000Z</published>
    <updated>2022-08-23T08:26:40.617Z</updated>
    
    <content type="html"><![CDATA[<p>堆的两点要求：</p><ul><li>堆是一个完全二叉树；</li><li>堆中每一个节点的值都必须大于等于（或小于等于）其子树中每个节点的值。<ul><li>对于每个节点的值都大于等于子树中每个节点值的堆，我们叫做<strong>大顶堆</strong>。</li><li>对于每个节点的值都小于等于子树中每个节点值的堆，我们叫做<strong>小顶堆</strong>。<span id="more"></span></li></ul></li></ul><blockquote><ul><li><strong>完全二叉树</strong>：除最后一层外，其他层的节点都满；并且最后一层的节点从左到右是连续排列，中间没有断开，空位都在右边。</li><li>在构建完全二叉树的时候，新加入的节点在最后一层从左往右依次排列，直到排满为止。</li></ul></blockquote><p>有两种方法存储一棵二叉树，一种是基于指针或者引用的<strong>二叉链式存储法</strong>，一种是基于<code>数组</code>的<strong>顺序存储法</strong>。<br><strong>堆</strong>是一种<strong>完全二叉树</strong>，最常用的存储方式就是基于<strong>数组</strong>的顺序存储法。</p><h3 id="1-基于数组的顺序存储法。"><a href="#1-基于数组的顺序存储法。" class="headerlink" title="1. 基于数组的顺序存储法。"></a>1. 基于数组的顺序存储法。</h3><p>如下图，我们把根节点存储在数组下标 <code>i=1</code> 的位置，那左子节点存储在下标 <code>2*i = 2</code> 的位置，右子节点存储在 <code>2*i+1 = 3</code> 的位置。以此类推，<code>B</code>节点的左子节点存储在 <code>2*i = 2*2 = 4</code> 的位置，右子节点存储在 <code>2*i+1 = 2*2+1 = 5</code> 的位置。</p><p><img src="/2022/05/02/data-structure-heap/10_01.webp"></p><p>如果节点<code>X</code>存储在数组中下标为 <code>i</code> 的位置，下标为 <code>2*i</code> 的位置存储的就是左子节点，下标为<code> 2*i+1</code> 的位置存储的就是右子节点。<br>反过来，下标为 <code>i/2</code> 的位置存储就是它的父节点。<br>通过这种方式，我们只要知道根节点存储的位置（通常根节点会存储在下标为<code>1</code>的位置），这样就可以通过下标计算，把整棵树都串起来。</p><h3 id="2-堆化（heapify）"><a href="#2-堆化（heapify）" class="headerlink" title="2. 堆化（heapify）"></a>2. 堆化（heapify）</h3><p>往堆中插入或者删除一个元素后，需要继续满足堆的两个特性，而这个<strong>重新维持堆特性的过程</strong>称为<code>堆化（heapify）</code>。</p><p>堆化非常简单，就是顺着节点所在的路径，向上或者向下，比较，然后交换。<br>堆化实际上有两种：从下往上、从上往下。</p><ul><li>插入元素时涉及的是<code>从下往上</code>的堆化方法。</li><li>删除堆顶元素涉及的是<code>从上往下</code>的堆化方法。</li></ul><h3 id="3-往堆中插入一个元素"><a href="#3-往堆中插入一个元素" class="headerlink" title="3. 往堆中插入一个元素"></a>3. 往堆中插入一个元素</h3><p>把新插入的元素放到堆的最后，需要继续满足堆的两个特性。</p><p><img src="/2022/05/02/data-structure-heap/10_02.webp"></p><p>从下往上的堆化：<br>让新插入的节点与父节点对比大小。如果不满足子节点小于等于父节点的大小关系，我们就互换两个节点。<br>一直重复这个过程，直到父子节点之间满足刚说的那种大小关系。</p><p><img src="/2022/05/02/data-structure-heap/10_03.webp"></p><p>往堆中插入数据的过程，翻译成代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Heap</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span>[] a; <span class="comment">// 数组，从下标1开始存储数据</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> n;  <span class="comment">// 堆可以存储的最大数据个数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> count; <span class="comment">// 堆中已经存储的数据个数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Heap</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">    a = <span class="keyword">new</span> <span class="title class_">int</span>[capacity + <span class="number">1</span>];</span><br><span class="line">    n = capacity;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> data)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &gt;= n) <span class="keyword">return</span>; <span class="comment">// 堆满了</span></span><br><span class="line">    ++count;</span><br><span class="line">    a[count] = data;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> count;</span><br><span class="line">    <span class="keyword">while</span> (i/<span class="number">2</span> &gt; <span class="number">0</span> &amp;&amp; a[i] &gt; a[i/<span class="number">2</span>]) &#123; <span class="comment">// 自下往上堆化</span></span><br><span class="line">      swap(a, i, i/<span class="number">2</span>); <span class="comment">// swap()函数作用：交换下标为i和i/2的两个元素</span></span><br><span class="line">      i = i/<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="4-删除堆顶元素"><a href="#4-删除堆顶元素" class="headerlink" title="4. 删除堆顶元素"></a>4. 删除堆顶元素</h3><p>从堆的特性可以看出，堆顶元素存储的就是堆中数据的最大值或者最小值。<br>从上往下的堆化：<br>当我们删除堆顶元素之后，把最后一个节点放到堆顶，然后利用同样的父子节点对比方法。对于不满足父子节点大小关系的，互换两个节点，并且重复进行这个过程，直到父子节点之间满足大小关系为止。</p><p><img src="/2022/05/02/data-structure-heap/10_04.webp"></p><p>堆顶元素删除的过程，翻译成代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeMax</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// 堆中没有数据</span></span><br><span class="line">  a[<span class="number">1</span>] = a[count];</span><br><span class="line">  --count;</span><br><span class="line">  heapify(a, count, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] a, <span class="type">int</span> n, <span class="type">int</span> i)</span> &#123; <span class="comment">// 自上往下堆化</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxPos</span> <span class="operator">=</span> i;</span><br><span class="line">    <span class="keyword">if</span> (i*<span class="number">2</span> &lt;= n &amp;&amp; a[i] &lt; a[i*<span class="number">2</span>]) maxPos = i*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (i*<span class="number">2</span>+<span class="number">1</span> &lt;= n &amp;&amp; a[maxPos] &lt; a[i*<span class="number">2</span>+<span class="number">1</span>]) maxPos = i*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxPos == i) <span class="keyword">break</span>;</span><br><span class="line">    swap(a, i, maxPos);</span><br><span class="line">    i = maxPos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-堆化的时间复杂度"><a href="#2-堆化的时间复杂度" class="headerlink" title="2. 堆化的时间复杂度"></a>2. 堆化的时间复杂度</h3><p>一个包含 <code>n</code> 个节点的完全二叉树，树的高度不会超过 <code>log2​n</code>。<br>堆化的过程是顺着节点所在路径比较交换的，所以堆化的时间复杂度跟树的高度成正比，也就是 <code>O(logn)</code>。<br>插入数据和删除堆顶元素的主要逻辑就是堆化，所以，往堆中插入一个元素和删除堆顶元素的时间复杂度都是 <code>O(logn)</code>。</p><h3 id="3-堆排序（heap-sort）"><a href="#3-堆排序（heap-sort）" class="headerlink" title="3. 堆排序（heap sort）"></a>3. 堆排序（heap sort）</h3><p><code>堆排序（heap sort）</code>是基于堆的一种排序，堆排序的过程大致分为两大步骤：<strong>建堆</strong>和<strong>排序</strong>。</p><p><strong>大顶堆</strong>：每个节点的值都大于等于子树中每个节点值。<br><strong>小顶堆</strong>：每个节点的值都小于等于子树中每个节点值。<br>求升序用大顶堆，求降序用小顶堆。</p><h4 id="3-1-堆的构建"><a href="#3-1-堆的构建" class="headerlink" title="3.1 堆的构建"></a>3.1 堆的构建</h4><p>这里提供一种构建思路：从最后一个非叶子节点开始从后往前处理数组，并且每个数据都是从上往下堆化。</p><p>包含 <code>n</code> 个节点的完全二叉树来说，下标从 <code>2/n​+1</code> 到 <code>n</code> 的节点都是叶子节点；我们对下标从 <code>2/n​</code> 开始到 <code>1</code> 的节点（非叶子节点）开始处理数组。</p><p>如下图，9个节点，从数组下标4开始处理数组，构建大顶堆。</p><p><img src="/2022/05/02/data-structure-heap/10_05.png"></p><p>实现代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">buildHeap</span><span class="params">(<span class="type">int</span>[] a, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n/<span class="number">2</span>; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">    heapify(a, n, i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] a, <span class="type">int</span> n, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxPos</span> <span class="operator">=</span> i;</span><br><span class="line">    <span class="keyword">if</span> (i*<span class="number">2</span> &lt;= n &amp;&amp; a[i] &lt; a[i*<span class="number">2</span>]) maxPos = i*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (i*<span class="number">2</span>+<span class="number">1</span> &lt;= n &amp;&amp; a[maxPos] &lt; a[i*<span class="number">2</span>+<span class="number">1</span>]) maxPos = i*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxPos == i) <span class="keyword">break</span>;</span><br><span class="line">    swap(a, i, maxPos);</span><br><span class="line">    i = maxPos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>堆排序的建堆过程的时间复杂度是 <code>O(n)</code>。</p><p>每个节点堆化的时间复杂度是 <code>O(logn)</code>，因为叶子节点不需要堆化，所以需要堆化的节点从倒数第二层开始。<br>每个节点堆化的过程中，需要比较和交换的节点个数，跟这个节点的高度成正比。通过将每个非叶子节点的高度求和，最终求得建堆的时间复杂度就是 <code>O(n)</code>。</p><h4 id="3-2-排序"><a href="#3-2-排序" class="headerlink" title="3.2 排序"></a>3.2 排序</h4><p>建堆结束之后，数组中的第一个元素就是堆顶，大顶堆的堆顶也就是最大的元素。我们把它跟最后一个元素交换，那最大元素就放到了下标为 <code>n</code> 的位置。剩下 <code>n-1</code> 个元素重复这个过程(堆化-&gt;取堆顶)。一直重复，直到最后堆中只剩下标为 1 的一个元素，排序工作就完成了。</p><p><img src="/2022/05/02/data-structure-heap/10_06.png"></p><p>堆排序的过程代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// n表示数据的个数，数组a中的数据从下标1到n的位置。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(<span class="type">int</span>[] a, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">  buildHeap(a, n);</span><br><span class="line">  <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> n;</span><br><span class="line">  <span class="keyword">while</span> (k &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    swap(a, <span class="number">1</span>, k);</span><br><span class="line">    --k;</span><br><span class="line">    heapify(a, k, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整个堆排序的过程，都只需要极个别临时存储空间，所以堆排序是原地排序算法。<br>堆排序包括建堆和排序两个操作，<br>建堆过程的时间复杂度是 <code>O(n)</code>，<br>排序过程的时间复杂度是 <code>O(nlogn)</code>，<br>所以，堆排序整体的时间复杂度是 <code>O(nlogn)</code>。<br>堆排序不是稳定的排序算法，因为在排序的过程，存在将堆的最后一个节点跟堆顶节点互换的操作，所以就有可能改变值相同数据的原始相对顺序。</p><blockquote><p>在实际开发中，为什么快速排序要比堆排序性能好？</p><ol><li>第一点，堆排序数据访问的方式没有快速排序友好。<ul><li>对于快速排序来说，数据是顺序访问的。而对于堆排序来说，数据是跳着访问的（堆化）。 CPU对于顺序访问的数据更加友好，可以做缓存。</li></ul></li><li>第二点，对于同样的数据，在排序过程中，堆排序算法的数据交换次数要多于快速排序。<ul><li>堆排序的第一步是建堆，建堆的过程会打乱数据原有的相对先后顺序，导致原数据的有序度降低。</li></ul></li></ol></blockquote><h3 id="4-堆的应用"><a href="#4-堆的应用" class="headerlink" title="4. 堆的应用"></a>4. 堆的应用</h3><h4 id="4-1-优先级队列"><a href="#4-1-优先级队列" class="headerlink" title="4.1 优先级队列"></a>4.1 优先级队列</h4><p>在优先级队列中，数据的出队顺序不是先进先出，而是按照优先级来，优先级最高的，最先出队。</p><p>用堆来实现是最直接、最高效的。<br>这是因为，堆和优先级队列非常相似。一个堆就可以看作一个优先级队列。<br>很多时候，它们只是概念上的区分而已。往优先级队列中插入一个元素，就相当于往堆中插入一个元素；从优先级队列中取出优先级最高的元素，就相当于取出堆顶元素。</p><p>优先级队列的应用广泛，如赫夫曼编码，图的最短路径，做小生成树的算法等。</p><h4 id="4-2-利用堆求Top-K"><a href="#4-2-利用堆求Top-K" class="headerlink" title="4.2 利用堆求Top K"></a>4.2 利用堆求Top K</h4><ol><li>针对静态数据：<ul><li>可以维护一个大小为k的小顶堆，顺序遍历数组，从数组中取出数据与堆顶元素比较。如果堆顶元素大，就将堆顶元素删除，并且将这个元素插入到堆中；如果比堆顶元素小则不做处理，继续遍历数组。这样等数组中的数据都遍历完之后，堆中的数据就是前k大数据了。</li><li>遍历数据需要<code>O(n)</code>的时间复杂度，一次堆化操作需要<code>O(logk)</code>的时间复杂度，最坏情况下，<code>n</code>个元素都入堆一次，时间复杂度就是<code>O(nlogk)</code>。</li></ul></li><li>针对动态数据：求得Topk就是实时Topk。<ul><li>一个数据集合有两个操作，一个是添加数据，另一个询问当前的前k大数据。</li><li>可以维护一直都维护一个k大小的小顶堆，当有数据被添加到集合时，就那它与堆顶的元素对对比。如果比堆顶元素大，就把堆顶元素删除，并将这个元素插入到堆中，如果比堆顶元素小，这不处理。这样，无论任何时候需要查询当前的前k大数据，就都可以 立刻返回给他。</li></ul></li></ol><h4 id="4-2-利用堆求中位数"><a href="#4-2-利用堆求中位数" class="headerlink" title="4.2 利用堆求中位数"></a>4.2 利用堆求中位数</h4><ol><li>对于一组静态数据，中位数是固定的，可以先排序，第<code>n/2</code>个数据就是中位数。</li><li>对于动态数据集合，就无法先排序了，需要借助堆这种数据结构，我们不用排序，就可以非常高效的实现求中位数操作。</li></ol><ul><li>实现思路：<ol><li>需要维护两个堆，大顶堆中存储前半部分数据，小顶堆中存储后半部分数据，且小顶堆中的数据都大于大顶堆中的数据。</li><li>如果新加入的数据小于等于大顶堆的堆顶元素，就将这个数据插入到大顶堆；否则就插入小顶堆。</li><li>当两个堆中的数据量不服和中位数的约定时，就从一个堆中不停的将堆顶的元素移动到另一个堆，重新让两个堆中数据满足上面的约定。</li></ol></li></ul><p>可以利用两个堆实现动态数据集合中求中位数的操作，插入数据因为涉及堆化，所以时间复杂度变成了<code>O(logn)</code>，但求中位数只需要返回大顶堆的堆顶元素就可以了，所以时间复杂度就是<code>O(1)</code>。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;堆的两点要求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;堆是一个完全二叉树；&lt;/li&gt;
&lt;li&gt;堆中每一个节点的值都必须大于等于（或小于等于）其子树中每个节点的值。&lt;ul&gt;
&lt;li&gt;对于每个节点的值都大于等于子树中每个节点值的堆，我们叫做&lt;strong&gt;大顶堆&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;对于每个节点的值都小于等于子树中每个节点值的堆，我们叫做&lt;strong&gt;小顶堆&lt;/strong&gt;。</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」红黑树（Red-Black Tree）</title>
    <link href="http://chaooo.github.io/2022/04/25/data-structure-redblacktree.html"/>
    <id>http://chaooo.github.io/2022/04/25/data-structure-redblacktree.html</id>
    <published>2022-04-25T11:05:10.000Z</published>
    <updated>2022-08-25T08:25:39.630Z</updated>
    
    <content type="html"><![CDATA[<p>平衡二叉查找树其实有很多，比如，红黑树（Red-Black Tree，简称 R-B Tree）、伸展树（Splay Tree）、树堆（Treap）等，但是我们提到平衡二叉查找树，听到的基本都是红黑树，它是一种不严格的平衡二叉查找树。<br>红黑树是一种含有红黑节点并能自平衡的二叉查找树。它必须满足下面性质：</p><ol><li>每个节点要么是红色，要么是黑色；</li><li>根节点是黑色的；</li><li>每个叶子节点都是黑色的空节点（NIL），也就是说，叶子节点不存储数据；</li><li>任何相邻的节点都不能同时为红色，也就是说，红色节点是被黑色节点隔开的；</li><li>任意一节点到每个叶子节点的路径，都包含相同数目的黑色节点；<span id="more"></span></li></ol><h3 id="1-红黑树的平衡特征"><a href="#1-红黑树的平衡特征" class="headerlink" title="1. 红黑树的平衡特征"></a>1. 红黑树的平衡特征</h3><p>红黑树与<code>AVL</code>树类似，都在添加和删除的时候通过旋转操作保持二叉树的平衡，以求更高效的查询性能。</p><p><strong>红黑树牺牲了部分平衡性</strong>，以换取插入&#x2F;删除操作时较少的旋转操作，整体来说性能要优于<code>AVL</code>树。</p><p>红黑树的黑色属性（即性质第五点）：任意一节点到每个叶子节点的路径，都包含相同数目的黑色节点。<br>黑色属性，可以理解为<strong>平衡特征</strong>， 如果满足不了平衡特征，就要进行平衡操作（变色、左旋、右旋）。</p><p>红黑树的平衡条件，是以<strong>黑色节点的高度</strong>来约束的，所以称红黑树这种平衡为<strong>黑色完美平衡</strong>。</p><p>如下图，去掉红色节点，会得到一个四叉树， 从根节点到每一个叶子节点高度相同，就是红黑树的根节点到叶子的黑色路径长度。<br><img src="/2022/04/25/data-structure-redblacktree/09_01.png"></p><h3 id="2-红黑树的平衡调整"><a href="#2-红黑树的平衡调整" class="headerlink" title="2. 红黑树的平衡调整"></a>2. 红黑树的平衡调整</h3><p>三种操作：左旋（rotate left）、右旋（rotate right）和 变色。</p><ul><li><p>左旋，即是<strong>逆时针</strong>旋转，以某个节点作为旋转点，其右子节点变为旋转节点的父节点，右子节点的左子节点变为旋转节点的右子节点，左子节点保持不变；<br><img src="/2022/04/25/data-structure-redblacktree/rotate_left.gif"></p></li><li><p>右旋，即是<strong>顺时针</strong>旋转，以某个节点作为旋转点，其左子节点变为旋转节点的父节点，左子节点的右子节点变为旋转节点的左子节点，右子节点保持不变。<br><img src="/2022/04/25/data-structure-redblacktree/rotate_right.gif"></p></li><li><p>变色，节点的颜色由红变黑或由黑变红；</p></li></ul><h3 id="3-插入操作的平衡调整"><a href="#3-插入操作的平衡调整" class="headerlink" title="3. 插入操作的平衡调整"></a>3. 插入操作的平衡调整</h3><p>红黑树规定，<strong>插入的节点一定是红色的</strong>。而且，<strong>二叉查找树中新插入的节点都是放在叶子节点上</strong>。</p><p>红黑树的平衡调整过程是一个迭代的过程。<br>我们把正在处理的节点叫做<strong>关注节点</strong>。关注节点会随着不停地迭代处理，而不断发生变化。<strong>最开始的关注节点就是新插入的节点</strong>。</p><ol><li><p>新插入节点的父节点是黑色的，红黑树不需要调整。</p></li><li><p>新插入节点是根节点，<strong>根节点变黑</strong>即可。</p></li><li><p>新插入节点的父节点和它的叔叔都是红色，红黑树只需要<strong>变色</strong>，不需要旋转。<br><img src="/2022/04/25/data-structure-redblacktree/09_02.png"></p></li><li><p>新插入节点的父节点是红色，但它叔叔是黑色（可能为null的黑色空节点），红黑树需要<strong>变色+旋转</strong>。</p></li></ol><p>需要红黑树<strong>变色+旋转</strong>（父节点红色，叔节点黑色）的四种情形：</p><ul><li><p>一、<strong>LL型</strong>（左左插），即父节点和插入的节点都是左节点：</p><ul><li>①父节点变黑色，爷节点变红色</li><li>②爷节点右旋<br><img src="/2022/04/25/data-structure-redblacktree/09_03.png"></li></ul></li><li><p>二、<strong>LR型</strong>（左右插），即父节点是左节点，插入节点是右节点：</p><ul><li>①父节点左旋，父子交换变成了【情形一·LL】</li><li>②跳到【LL型】的调整<br><img src="/2022/04/25/data-structure-redblacktree/09_04.png"></li></ul></li><li><p>三、<strong>RR型</strong>（右右插），即父节点和插入的节点都是右节点：</p><ul><li>①父节点变黑色，爷节点变红色</li><li>②爷节点左旋<br><img src="/2022/04/25/data-structure-redblacktree/09_05.png"></li></ul></li><li><p>二、<strong>RL型</strong>（右左插），即父节点是右节点，插入的节点是左节点：</p><ul><li>①父节点右旋，父子交换变成了【情形三·RR】</li><li>②跳到【RR型】的调整<br><img src="/2022/04/25/data-structure-redblacktree/09_06.png"></li></ul></li></ul><h3 id="4-删除操作的平衡调整"><a href="#4-删除操作的平衡调整" class="headerlink" title="4. 删除操作的平衡调整"></a>4. 删除操作的平衡调整</h3><p>红黑树的删除情况相对插入会复杂一些，不过原理都是类似的。</p><h4 id="4-1-二叉查找树的删除操作"><a href="#4-1-二叉查找树的删除操作" class="headerlink" title="4.1 二叉查找树的删除操作"></a>4.1 二叉查找树的删除操作</h4><ol><li>待删除节点没有子节点，将父节点中，指向要删除节点的指针置为<code>null</code>。</li><li>待删除节点只有一个子节点，更新父节点中，指向要删除节点的指针，让它指向要删除节点的子节点。</li><li>待删除节点有两个子节点，用后继节点或者前继节点替换删除节点，然后再删除掉替换节点。<blockquote><ul><li>后继节点：删除节点的右子树中的最小节点，即右子树中最左节点。</li><li>前继节点：删除节点的左子树中最大节点，即左子树中最右节点。</li></ul></blockquote></li></ol><h4 id="4-2-红黑树的删除动作"><a href="#4-2-红黑树的删除动作" class="headerlink" title="4.2 红黑树的删除动作"></a>4.2 红黑树的删除动作</h4><p>红黑树和二叉查找树的删除类似，只不过加上颜色属性（这里的子节点均指<strong>非黑色叶子NULL节点</strong>）：</p><ol><li><p>无子节点时，删除节点可能为红色或者黑色；</p><ul><li>1.1 如果为红色，直接删除即可，不会影响黑色节点的数量；</li><li>1.2 如果为黑色，则需要进行删除平衡的操作（如果是根节点，无需平衡操作）；<br><img src="/2022/04/25/data-structure-redblacktree/09_07.png"></li></ul></li><li><p>只有一个子节点时，删除节点只能是黑色，其子节点是红色（否则无法满足红黑树的性质）。 此时用删除节点的子节点接到父节点，且将子节点颜色涂黑，保证黑色数量。<br><img src="/2022/04/25/data-structure-redblacktree/09_08.png"></p></li><li><p>有两个子节点时，与二叉搜索树一样，使用后继节点作为替换的删除节点，情形转至为【1】或【2】处理。<br><img src="/2022/04/25/data-structure-redblacktree/09_09.png"></p></li></ol><p>删除情形【3】总是会转换为情形【1】或【2】的，<br>而情形【1.2】（删除节点无子节点且是黑色）还需要额外的平衡调整；<br>因为一旦该节点被拿掉，红黑树中通过该节点的路径黑色节点数量将会减1，而且无法像情形【2】那样将子节点涂黑来达到平衡。此时只能自底向上进行平衡操作。</p><h4 id="4-3-红黑树删除后的平衡操作"><a href="#4-3-红黑树删除后的平衡操作" class="headerlink" title="4.3 红黑树删除后的平衡操作"></a>4.3 红黑树删除后的平衡操作</h4><p>为了简化描述，先约定关注节点及相关节点的名称：<br><img src="/2022/04/25/data-structure-redblacktree/09_10.png"></p><h5 id="【情形-1-1】：-兄黑（S-黑），兄子全黑（L-和-R-全黑），父红（P-红）；"><a href="#【情形-1-1】：-兄黑（S-黑），兄子全黑（L-和-R-全黑），父红（P-红）；" class="headerlink" title="【情形 1.1】： 兄黑（S 黑），兄子全黑（L 和 R 全黑），父红（P 红）；"></a>【情形 1.1】： 兄黑（S 黑），兄子全黑（L 和 R 全黑），父红（P 红）；</h5><p>即 兄弟节点为黑色，兄弟节点的子节点全部黑色，父节点为红色。<br><img src="/2022/04/25/data-structure-redblacktree/09_12.png"></p><h5 id="【情形-1-2】：-兄黑（S-黑），兄子全黑（L-和-R-全黑），父黑（P-黑）；"><a href="#【情形-1-2】：-兄黑（S-黑），兄子全黑（L-和-R-全黑），父黑（P-黑）；" class="headerlink" title="【情形 1.2】： 兄黑（S 黑），兄子全黑（L 和 R 全黑），父黑（P 黑）；"></a>【情形 1.2】： 兄黑（S 黑），兄子全黑（L 和 R 全黑），父黑（P 黑）；</h5><p>即 兄弟节点为黑色，兄弟节点的子节点全部黑色，父节点为黑色。<br><img src="/2022/04/25/data-structure-redblacktree/09_13.png"></p><h5 id="【情形-2-1】：-兄黑（S-黑），兄在左（S-左），兄左子红（L-红）；"><a href="#【情形-2-1】：-兄黑（S-黑），兄在左（S-左），兄左子红（L-红）；" class="headerlink" title="【情形 2.1】： 兄黑（S 黑），兄在左（S 左），兄左子红（L 红）；"></a>【情形 2.1】： 兄黑（S 黑），兄在左（S 左），兄左子红（L 红）；</h5><p>即 兄弟节点为黑色，且兄弟节点在左边，兄弟节点的左子节点为红色。<br><img src="/2022/04/25/data-structure-redblacktree/09_14.png"></p><h5 id="【情形-2-2】：-兄黑（S-黑），兄在左（S-左），兄左子黑（L-黑）；"><a href="#【情形-2-2】：-兄黑（S-黑），兄在左（S-左），兄左子黑（L-黑）；" class="headerlink" title="【情形 2.2】： 兄黑（S 黑），兄在左（S 左），兄左子黑（L 黑）；"></a>【情形 2.2】： 兄黑（S 黑），兄在左（S 左），兄左子黑（L 黑）；</h5><p>即 兄弟节点为黑色，且兄弟节点在左边，兄弟节点的左子节点为黑色。<br><img src="/2022/04/25/data-structure-redblacktree/09_15.png"></p><h5 id="【情形-2-3】：-兄黑（S-黑），兄在右（S-右），兄右子红（R-红）；"><a href="#【情形-2-3】：-兄黑（S-黑），兄在右（S-右），兄右子红（R-红）；" class="headerlink" title="【情形 2.3】： 兄黑（S 黑），兄在右（S 右），兄右子红（R 红）；"></a>【情形 2.3】： 兄黑（S 黑），兄在右（S 右），兄右子红（R 红）；</h5><p>即 兄弟节点为黑色，且兄弟节点在右边，兄弟节点的右子节点为红色。<br><img src="/2022/04/25/data-structure-redblacktree/09_16.png"></p><h5 id="【情形-2-4】：-兄黑（S-黑），兄在右（S-右），兄右子黑（R-黑）；"><a href="#【情形-2-4】：-兄黑（S-黑），兄在右（S-右），兄右子黑（R-黑）；" class="headerlink" title="【情形 2.4】： 兄黑（S 黑），兄在右（S 右），兄右子黑（R 黑）；"></a>【情形 2.4】： 兄黑（S 黑），兄在右（S 右），兄右子黑（R 黑）；</h5><p>即 兄弟节点为黑色，且兄弟节点在右边，兄弟节点的右子节点为黑色。<br><img src="/2022/04/25/data-structure-redblacktree/09_17.png"></p><h5 id="【情形-3-1】：-兄红（S-红），兄在左（S-左）；"><a href="#【情形-3-1】：-兄红（S-红），兄在左（S-左）；" class="headerlink" title="【情形 3.1】： 兄红（S 红），兄在左（S 左）；"></a>【情形 3.1】： 兄红（S 红），兄在左（S 左）；</h5><p>即 兄弟节点为红色，且兄弟节点在左边。<br><img src="/2022/04/25/data-structure-redblacktree/09_18.png"></p><h5 id="【情形-3-2】：-兄红（S-红），兄在右（S-右）；"><a href="#【情形-3-2】：-兄红（S-红），兄在右（S-右）；" class="headerlink" title="【情形 3.2】： 兄红（S 红），兄在右（S 右）；"></a>【情形 3.2】： 兄红（S 红），兄在右（S 右）；</h5><p>即 兄弟节点为红色，且兄弟节点在右边。<br><img src="/2022/04/25/data-structure-redblacktree/09_19.png"></p><h4 id="4-4-红黑树删除总结"><a href="#4-4-红黑树删除总结" class="headerlink" title="4.4 红黑树删除总结"></a>4.4 红黑树删除总结</h4><p>删除动作（移除节点）之后，若待平衡节点是黑色的叶子节点：<br>平衡调整情形，主要根据 [兄节点的位置&#x2F;颜色]、[兄的子节点的颜色]、[父节点颜色] 进行分类：<br><img src="/2022/04/25/data-structure-redblacktree/09_11.png"></p><h3 id="5-红黑树的应用场景"><a href="#5-红黑树的应用场景" class="headerlink" title="5. 红黑树的应用场景"></a>5. 红黑树的应用场景</h3><p>二叉查找树的时间复杂度会受到其树深度的影响，而红黑树可以保证在最坏情况下的时间复杂度仍为O(lgn)。<br>当数据量多到一定程度时，使用红黑树比二叉查找树的效率要高。</p><blockquote><p>平衡二叉树的时间复杂度是O(logn)，红黑树的时间复杂度为O(lgn)，两者都表示的都是时间复杂度为对数关系（lg 函数为底是 10 的对数）。</p></blockquote><p>同平衡二叉树相比较，红黑树没有像平衡二叉树对平衡性要求的那么苛刻，虽然两者的时间复杂度相同，但是红黑树在实际测算中的速度要更胜一筹！</p><p>红黑树的使用非常广泛，</p><ul><li>如<code>Java</code>的<code>TreeMap</code>和<code>TreeSet</code>都是基于红黑树实现的（相对与<code>HashMap</code>优势，内部<code>key</code>保持有序，且支持自定义排序比较器）；</li><li>而<code>JDK8</code>中<code>HashMap</code>当链表长度大于<code>8</code>时也会转化为红黑树（时间复杂度从<code>O(n)--&gt;O(lgn)</code> ，且自旋开销比其他树低）。</li><li>其他：如epoll在内核中的实现，用红黑树管理事件块（文件描述符）；linux进程调度Completely Fair Scheduler，用红黑树管理进程控制块；nginx中，用红黑树管理timer等。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;平衡二叉查找树其实有很多，比如，红黑树（Red-Black Tree，简称 R-B Tree）、伸展树（Splay Tree）、树堆（Treap）等，但是我们提到平衡二叉查找树，听到的基本都是红黑树，它是一种不严格的平衡二叉查找树。&lt;br&gt;红黑树是一种含有红黑节点并能自平衡的二叉查找树。它必须满足下面性质：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;每个节点要么是红色，要么是黑色；&lt;/li&gt;
&lt;li&gt;根节点是黑色的；&lt;/li&gt;
&lt;li&gt;每个叶子节点都是黑色的空节点（NIL），也就是说，叶子节点不存储数据；&lt;/li&gt;
&lt;li&gt;任何相邻的节点都不能同时为红色，也就是说，红色节点是被黑色节点隔开的；&lt;/li&gt;
&lt;li&gt;任意一节点到每个叶子节点的路径，都包含相同数目的黑色节点；</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」AVL树</title>
    <link href="http://chaooo.github.io/2022/04/15/data-structure-avltree.html"/>
    <id>http://chaooo.github.io/2022/04/15/data-structure-avltree.html</id>
    <published>2022-04-15T12:05:10.000Z</published>
    <updated>2022-08-17T14:30:22.016Z</updated>
    
    <content type="html"><![CDATA[<p><code>AVL</code>树（得名于发明者G. M. Adelson-Velsky 和 E. M. Landis）本质上是一棵带有平衡条件的二叉搜索树。<br><code>AVL</code>树具有以下<code>2</code>个性质：</p><ol><li>左子树和右子树的深度之差的绝对值不超过<code>1</code>；</li><li>左子树和右子树全都是 <code>AVL</code>树。<span id="more"></span></li></ol><p>其中为了度量左右子树的深度之差，我们引入<code>平衡因子(BF)</code>的概念。</p><blockquote><p>平衡因子： 某个节点的左子树的高度减去右子树的高度得到的差值。</p></blockquote><p>对于一棵 <code>AVL</code>树，里面的所有节点的平衡因子只能取值于<code>-1、0、1</code>，否则，<code>AVL</code>树将是不平衡的并且需要平衡调整。</p><h3 id="1-AVL-树平衡调整"><a href="#1-AVL-树平衡调整" class="headerlink" title="1. AVL 树平衡调整"></a>1. AVL 树平衡调整</h3><p>二叉树的平衡化有两大基础操作： 左旋（rotate left）和右旋（rotate right）。</p><ul><li><p>左旋，即是<strong>逆时针</strong>旋转，以某个节点作为旋转点，其右子节点变为旋转节点的父节点，右子节点的左子节点变为旋转节点的右子节点，左子节点保持不变；<br><img src="/2022/04/15/data-structure-avltree/rotate_left.gif"></p></li><li><p>右旋，即是<strong>顺时针</strong>旋转，以某个节点作为旋转点，其左子节点变为旋转节点的父节点，左子节点的右子节点变为旋转节点的左子节点，右子节点保持不变。<br><img src="/2022/04/15/data-structure-avltree/rotate_right.gif"></p></li></ul><p>这种旋转在整个平衡化过程中可能进行一次或多次，这两种操作都是从失去平衡的最小子树根节点开始的(即离插入节点最近且平衡因子超过1的祖节点)。</p><p>造成失衡一共有 <code>4</code> 种情况：LL型、LR型、RL型、RR型，如下图所示。</p><ul><li><p><code>LL型</code>平衡调整：对节点<code>C</code>右旋即可。<br><img src="/2022/04/15/data-structure-avltree/08_ll.jpg"></p></li><li><p><code>LR型</code>平衡调整：先对<code>A</code>进行一次左旋再对<code>C</code>进行一次右旋。<br><img src="/2022/04/15/data-structure-avltree/08_lr.jpg"></p></li><li><p><code>RL型</code>平衡调整：先对<code>C</code>进行一次右旋再对<code>A</code>进行一次左旋。<br><img src="/2022/04/15/data-structure-avltree/08_rl.jpg"></p></li><li><p><code>RR型</code>平衡调整：对节点<code>A</code>左旋即可。<br><img src="/2022/04/15/data-structure-avltree/08_rr.jpg"></p></li></ul><h3 id="2-模拟建-AVL-树"><a href="#2-模拟建-AVL-树" class="headerlink" title="2. 模拟建 AVL 树"></a>2. 模拟建 AVL 树</h3><p>按照整数序列 {4,5,7,2,1,3,6} 依次插入<code>AVL</code>树。<br><img src="/2022/04/15/data-structure-avltree/08_demo.png"></p><p>由于<code>AVL</code>树必须保证左右子树平衡(左子树和右子树的深度之差的绝对值不超过<code>1</code>)，</p><p>所以在插入的时候很容易出现不平衡的情况，一旦这样，就需要进行旋转以求达到平衡。</p><p>正是由于这种严格的平衡条件，导致<code>AVL</code>需要花大量时间在调整上，故<code>AVL</code>树一般适用于<strong>查询</strong>场景， 而<strong>不</strong>适用于<strong>增删频繁</strong>的场景。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;code&gt;AVL&lt;/code&gt;树（得名于发明者G. M. Adelson-Velsky 和 E. M. Landis）本质上是一棵带有平衡条件的二叉搜索树。&lt;br&gt;&lt;code&gt;AVL&lt;/code&gt;树具有以下&lt;code&gt;2&lt;/code&gt;个性质：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;左子树和右子树的深度之差的绝对值不超过&lt;code&gt;1&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;左子树和右子树全都是 &lt;code&gt;AVL&lt;/code&gt;树。</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」二叉树</title>
    <link href="http://chaooo.github.io/2022/04/08/data-structure-binarytree.html"/>
    <id>http://chaooo.github.io/2022/04/08/data-structure-binarytree.html</id>
    <published>2022-04-08T10:08:18.000Z</published>
    <updated>2022-08-17T14:22:05.436Z</updated>
    
    <content type="html"><![CDATA[<p>树：树是一种非线性的数据结构，一棵树是<code>n</code>（<code>n&gt;=0</code>）个节点的集合。<br>用来连接相邻节点之间的关系，我们叫做“父子关系”。<br>我们把没有父节点的节点叫做<strong>根节点</strong>，节点的上一层节点是其<strong>父节点</strong>，下一层节点是其<strong>子节点</strong>，拥有相同父节点的子节点之间互称为<strong>兄弟节点</strong>。</p><span id="more"></span><ul><li>树的三个比较相似的概念：高度（Height）、深度（Depth）、层（Level）。<ul><li>节点的高度：节点到叶子节点的最长路径（边数）</li><li>节点的深度：根节点到这个节点所经历的路径（边数）</li><li>节点的层数：节点的深度 <code>+1</code></li></ul></li><li>树的高度：根节点的高度。</li></ul><p><img src="/2022/04/08/data-structure-binarytree/07_01.webp"></p><h3 id="1-二叉树"><a href="#1-二叉树" class="headerlink" title="1. 二叉树"></a>1. 二叉树</h3><p>二叉树：每个节点<strong>最多</strong>有两个子节点，分别是<strong>左子节点</strong>和<strong>右子节点</strong>。<br>二叉树的递归定义为：二叉树是一棵空树，或者是一棵由一个根节点和两棵互不相交的，分别称作根的左子树和右子树组成的非空树；左子树和右子树又同样都是二叉树。</p><ul><li>两个比较特殊的二叉树：<ul><li>满二叉树：树中每个分支节点（非叶节点）都有两棵非空子树，并且所有的叶节点都在同一层。</li><li>完全二叉树：除最后一层外，其他层的节点都满；并且最后一层的节点从左到右是连续排列，中间没有断开，空位都在右边。<br><img src="/2022/04/08/data-structure-binarytree/07_02.webp"></li></ul></li></ul><p>有两种方法存储一棵二叉树，一种是基于指针或者引用的<strong>二叉链式存储法</strong>，一种是基于数组的<strong>顺序存储法</strong>。</p><h3 id="2-存储二叉树"><a href="#2-存储二叉树" class="headerlink" title="2. 存储二叉树"></a>2. 存储二叉树</h3><p>基于基于指针的链式存储法。<br>每个节点有三个字段，其中一个存储数据，另外两个是指向左右子节点的指针。<br>从根节点开始，就可以通过左右子节点的指针，把整棵树都串起来。这种存储方式我们比较常用。大部分二叉树代码都是通过这种结构来实现的。<br><img src="/2022/04/08/data-structure-binarytree/07_03.webp"></p><p>基于数组的顺序存储法。<br>如下图，我们把根节点存储在数组下标 <code>i=1</code> 的位置，那左子节点存储在下标 <code>2*i = 2</code> 的位置，右子节点存储在 <code>2*i+1 = 3</code> 的位置。以此类推，<code>B</code>节点的左子节点存储在 <code>2*i = 2*2 = 4</code> 的位置，右子节点存储在 <code>2*i+1 = 2*2+1 = 5</code> 的位置。<br><img src="/2022/04/08/data-structure-binarytree/07_04.webp"></p><p>如果节点<code>X</code>存储在数组中下标为 <code>i</code> 的位置，下标为 <code>2*i</code> 的位置存储的就是左子节点，下标为<code> 2*i+1</code> 的位置存储的就是右子节点。<br>反过来，下标为 <code>i/2</code> 的位置存储就是它的父节点。<br>通过这种方式，我们只要知道根节点存储的位置（通常根节点会存储在下标为<code>1</code>的位置），这样就可以通过下标计算，把整棵树都串起来。</p><p><strong>堆</strong>其实就是一种<strong>完全二叉树</strong>，最常用的存储方式就是<strong>数组</strong>。</p><h3 id="3-遍历二叉树"><a href="#3-遍历二叉树" class="headerlink" title="3. 遍历二叉树"></a>3. 遍历二叉树</h3><p>经典的方法有三种，<strong>前序遍历</strong>、<strong>中序遍历</strong>和<strong>后序遍历</strong>。</p><ul><li>前序遍历：对于树中的任意节点来说，先打印这个节点，然后再打印它的左子树，最后打印它的右子树。</li><li>中序遍历：对于树中的任意节点来说，先打印它的左子树，然后再打印它本身，最后打印它的右子树。</li><li>后序遍历：对于树中的任意节点来说，先打印它的左子树，然后再打印它的右子树，最后打印这个节点本身。<br><img src="/2022/04/08/data-structure-binarytree/07_05.webp"></li></ul><p>实际上，二叉树的前、中、后序遍历就是一个<strong>递归的过程</strong>。<br>比如，前序遍历，其实就是先打印根节点，然后再递归地打印左子树，最后递归地打印右子树。</p><h3 id="4-二叉查找树（Binary-Search-Tree）"><a href="#4-二叉查找树（Binary-Search-Tree）" class="headerlink" title="4. 二叉查找树（Binary Search Tree）"></a>4. 二叉查找树（Binary Search Tree）</h3><p>二叉查找树，也叫二叉搜索树。<br>顾名思义，二叉查找树是为了实现<strong>快速查找</strong>而生的。不过，它不仅仅支持快速查找一个数据，还支持快速插入、删除一个数据。</p><p>二叉查找树要求，在树中的<strong>任意一个节点，其左子树中的每个节点的值都比该节点的值小，而右子树节点的值都比该节点的值大</strong>。</p><h4 id="4-1-二叉查找树的查找操作"><a href="#4-1-二叉查找树的查找操作" class="headerlink" title="4.1 二叉查找树的查找操作"></a>4.1 二叉查找树的查找操作</h4><p>先取根节点，如果它等于我们要查找的数据，那就返回。<br>如果要查找的数据比根节点的值小，那就在左子树中递归查找；<br>如果要查找的数据比根节点的值大，那就在右子树中递归查找。<br><img src="/2022/04/08/data-structure-binarytree/07_06.webp"></p><h4 id="4-2-二叉查找树的插入操作"><a href="#4-2-二叉查找树的插入操作" class="headerlink" title="4.2 二叉查找树的插入操作"></a>4.2 二叉查找树的插入操作</h4><p>二叉查找树的插入操作二叉查找树的插入过程有点类似查找操作。<br>新插入的数据一般都是在叶子节点上，所以我们只需要从根节点开始，依次比较要插入的数据和节点的大小关系。<br><img src="/2022/04/08/data-structure-binarytree/07_07.webp"></p><h4 id="4-3-二叉查找树的删除操作"><a href="#4-3-二叉查找树的删除操作" class="headerlink" title="4.3 二叉查找树的删除操作"></a>4.3 二叉查找树的删除操作</h4><p>分三种情况来处理。</p><ol><li>如果要删除的节点没有子节点，我们只需要直接将父节点中，指向要删除节点的指针置为<code>null</code>。(比如图中的删除节点<code>55</code>。)</li><li>如果要删除的节点只有一个子节点，我们只需要更新父节点中，指向要删除节点的指针，让它指向要删除节点的子节点就可以了。(比如图中的删除节点<code>13</code>。)</li><li>如果要删除的节点有两个子节点，可以用后继节点或者前继节点替换删除节点，然后再删除掉替换节点。（比如图中的删除节点<code>18</code>。)<blockquote><ul><li>后继节点：删除节点的右子树中的最小节点，即右子树中最左节点。</li><li>前继节点：删除节点的左子树中最大节点，即左子树中最右节点。</li></ul></blockquote></li></ol><p><img src="/2022/04/08/data-structure-binarytree/07_08.webp"></p><h4 id="4-2-二叉查找树的其他操作"><a href="#4-2-二叉查找树的其他操作" class="headerlink" title="4.2 二叉查找树的其他操作"></a>4.2 二叉查找树的其他操作</h4><ul><li>除了插入、删除、查找操作之外，二叉查找树中还可以支持<strong>快速地查找最大节点和最小节点、前驱节点和后继节点</strong>。</li><li><strong>中序遍历二叉查找树，可以输出有序的数据序列，时间复杂度是 <code>O(n)</code>，非常高效</strong>。因此，二叉查找树也叫作<strong>二叉排序树</strong>。</li><li>支持重复数据的二叉查找树<ol><li>通过链表和支持动态扩容的数组等数据结构，把值相同的数据都存储在同一个节点上。</li><li>每个节点仍然只存储一个数据。新插入值相同的数据当作大于这个节点的值来处理。查找时，遇到值相同的节点不停止，而是继续在右子树中查找，直到遇到叶子节点才停止。这样就可以把键值等于要查找值的所有节点都找出来。删除时，也需要先查找到每个要删除的节点，依次删除。</li></ol></li></ul><h3 id="5-平衡二叉树"><a href="#5-平衡二叉树" class="headerlink" title="5. 平衡二叉树"></a>5. 平衡二叉树</h3><p>二叉查找树支持快速插入、删除、查找操作，各个操作的时间复杂度跟树的高度成正比，也就是<code>O(height)</code>，完全二叉树的高度<code>height&lt;=log2n</code>；理想情况下，时间复杂度是<code>O(logn)</code>。<br>不过，二叉查找树在频繁的动态更新过程中，可能会出现树的高度远大于<code>log2n</code>的情况，从而导致各个操作的效率下降。极端情况下，二叉树会退化为链表，时间复杂度会退化到<code>O(n)</code>。</p><p>为了解决二叉查找树因为动态更新导致的性能退化问题，发明了<strong>平衡二叉查找树</strong>这类数据结构。<br>平衡二叉查找树的高度接近<code>logn</code>，所以插入、删除、查找操作的时间复杂度也比较稳定，是<code>O(logn)</code>。<br>在工程中，很多用到平衡二叉查找树的地方都会用红黑树。红黑树是一种特殊的平衡二叉查找树。</p><p>平衡二叉树的<strong>严格定义</strong>：**二叉树中任意一个节点的左右子树的高度相差不能大于<code>1</code>**。</p><p>从这个定义来看，完全二叉树、满二叉树其实都是平衡二叉树，但是非完全二叉树也有可能是平衡二叉树。</p><p>但是很多平衡二叉查找树其实并没有符合严格的定义，比如红黑树，它从根节点到各个叶子节点的最长路径，有可能会比最短路径大一倍。</p><p>所以，平衡二叉查找树中“平衡”的意思，其实就是<strong>让整棵树左右看起来比较“对称”、比较“平衡”，不要出现左子树很高、右子树很矮的情况。这样就能让整棵树的高度相对来说低一些，相应的插入、删除、查找等操作的效率高一些</strong>。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;树：树是一种非线性的数据结构，一棵树是&lt;code&gt;n&lt;/code&gt;（&lt;code&gt;n&amp;gt;=0&lt;/code&gt;）个节点的集合。&lt;br&gt;用来连接相邻节点之间的关系，我们叫做“父子关系”。&lt;br&gt;我们把没有父节点的节点叫做&lt;strong&gt;根节点&lt;/strong&gt;，节点的上一层节点是其&lt;strong&gt;父节点&lt;/strong&gt;，下一层节点是其&lt;strong&gt;子节点&lt;/strong&gt;，拥有相同父节点的子节点之间互称为&lt;strong&gt;兄弟节点&lt;/strong&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」哈希算法</title>
    <link href="http://chaooo.github.io/2022/03/25/data-structure-hashalgorithm.html"/>
    <id>http://chaooo.github.io/2022/03/25/data-structure-hashalgorithm.html</id>
    <published>2022-03-25T13:40:12.000Z</published>
    <updated>2022-08-02T05:49:29.345Z</updated>
    
    <content type="html"><![CDATA[<p>哈希算法（Hash）又称摘要算法（Digest），它的作用是：对任意一组输入数据进行计算，得到一个固定长度的输出摘要。</p><p>哈希算法最重要的特点就是：相同的输入一定得到相同的输出；不同的输入大概率得到不同的输出。</p><span id="more"></span><p>哈希算法的目的就是为了验证原始数据是否被篡改。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java字符串的hashCode()就是一个哈希算法，它的输入是任意字符串，输出是固定的4字节int整数：</span></span><br><span class="line"><span class="string">&quot;hello&quot;</span>.hashCode(); <span class="comment">// 0x5e918d2</span></span><br><span class="line"><span class="string">&quot;hello, java&quot;</span>.hashCode(); <span class="comment">// 0x7a9d88e8</span></span><br><span class="line"><span class="string">&quot;hello, bob&quot;</span>.hashCode(); <span class="comment">// 0xa0dbae2f</span></span><br></pre></td></tr></table></figure><p>哈希碰撞是指，两个不同的输入得到了相同的输出。一个安全的哈希算法必须满足：碰撞概率低，不能猜测输出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;AaAaAa&quot;</span>.hashCode(); <span class="comment">// 0x7460e8c0</span></span><br><span class="line"><span class="string">&quot;BBAaBB&quot;</span>.hashCode(); <span class="comment">// 0x7460e8c0</span></span><br></pre></td></tr></table></figure><h3 id="1-常用的哈希算法"><a href="#1-常用的哈希算法" class="headerlink" title="1. 常用的哈希算法"></a>1. 常用的哈希算法</h3><table><thead><tr><th align="left">算法</th><th align="left">输出长度（位）</th><th align="left">输出长度（字节）</th></tr></thead><tbody><tr><td align="left">MD5</td><td align="left">128 bits</td><td align="left">16 bytes</td></tr><tr><td align="left">SHA-1</td><td align="left">160 bits</td><td align="left">20 bytes</td></tr><tr><td align="left">RipeMD-160</td><td align="left">160 bits</td><td align="left">20 bytes</td></tr><tr><td align="left">SHA-256</td><td align="left">256 bits</td><td align="left">32 bytes</td></tr><tr><td align="left">SHA-512</td><td align="left">512 bits</td><td align="left">64 bytes</td></tr></tbody></table><p>根据碰撞概率，哈希算法的输出长度越长，就越难产生碰撞，也就越安全。</p><h3 id="2-哈希算法的应用"><a href="#2-哈希算法的应用" class="headerlink" title="2. 哈希算法的应用"></a>2. 哈希算法的应用</h3><p>哈希算法的应用非常非常多，这里介绍最常见的七个，分别是安全加密、唯一标识、数据校验、散列函数、负载均衡、数据分片、分布式存储。</p><h4 id="2-1-安全加密"><a href="#2-1-安全加密" class="headerlink" title="2.1 安全加密"></a>2.1 安全加密</h4><p>最常用于加密的哈希算法是 <code>MD5</code>（MD5 Message-Digest Algorithm，MD5 消息摘要算法）和 <code>SHA</code>（Secure Hash Algorithm，安全散列算法）。<br>除了这两个之外，当然还有很多其他加密算法，比如计算机网络的<code>SSL/TLS</code>协议里面的对称加密（<code>AES</code>）、非对称加密（<code>RSA</code>）。</p><p>安全加密的关键点：①很难根据哈希值反向推导出原始数据；②散列冲突的概率要很小。</p><p>不管是什么哈希算法，只能尽量减少碰撞冲突的概率，理论上是无法做到完全不冲突的。<br>一般情况下，哈希值越长的哈希算法，散列冲突的概率越低。</p><p>没有绝对安全的加密。任何哈希算法都会出现散列冲突，但是这个冲突概率非常小。越是复杂哈希算法越难破解，但同样计算时间也就越长。所以，选择哈希算法的时候，要权衡安全性和计算时间来决定用哪种哈希算法。</p><h4 id="2-2-唯一标识"><a href="#2-2-唯一标识" class="headerlink" title="2.2 唯一标识"></a>2.2 唯一标识</h4><p>哈希算法可以对大数据做信息摘要，通过一个较短的二进制编码来表示很大的数据。</p><p>比如<code>URL</code>字段或者图片字段要求不能重复，这个时候就可以通过哈希算法对这个数据取唯一标识，或者说信息摘要（比如<code>MD5</code>处理）。<br>此外，还可以对文件之类的二进制数据做<code>MD5</code>处理，作为唯一标识，这样判定重复文件的时候更快捷。</p><h4 id="2-3-数据校验"><a href="#2-3-数据校验" class="headerlink" title="2.3 数据校验"></a>2.3 数据校验</h4><p>网络传输数据不安全，传输数据的过程中，数据可能被宿主机篡改，或数据丢失，所以需要校验文件的安全，正确，完整性。</p><p>因为哈希算法对数据很敏感，只要文件块的内容有一丁点儿的改变，最后计算出的哈希值就会完全不同；所以在文件块下载完后，使用相同的哈希算法，对于文件计算，判断是否相同。</p><h4 id="2-4-散列函数"><a href="#2-4-散列函数" class="headerlink" title="2.4 散列函数"></a>2.4 散列函数</h4><p>散列函数是设计一个散列表的关键。它直接决定了散列冲突的概率和散列表的性能。不过，散列函数对于散列算法冲突的要求要低很多。即便出现个别散列冲突，只要不是过于严重，我们都可以通过开放寻址法或者链表法解决。</p><p>散列函数中用到的散列算法，更加关注散列后的值是否能平均分布，也就是，一组数据是否能均匀地散列在各个槽中。除此之外，散列函数执行的快慢，也会影响散列表的性能，所以，散列函数用的散列算法一般都比较简单，比较追求效率。</p><h4 id="2-5-负载均衡"><a href="#2-5-负载均衡" class="headerlink" title="2.5 负载均衡"></a>2.5 负载均衡</h4><p>负载均衡算法有很多，比如轮询、随机、加权轮询等。利用哈希算法替代映射表，可以实现一个会话粘滞的负载均衡策略。</p><p>我们可以通过哈希算法，对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值与服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。 这样，我们就可以把同一个 IP 过来的所有请求，都路由到同一个后端服务器上。</p><h4 id="2-6-数据分片"><a href="#2-6-数据分片" class="headerlink" title="2.6 数据分片"></a>2.6 数据分片</h4><p>针对海量数据的处理问题，通过哈希算法对处理的海量数据进行分片，多机分布式处理。借助这种分片的思路，可以突破单机内存、CPU 等资源的限制。</p><h4 id="2-7-分布式存储"><a href="#2-7-分布式存储" class="headerlink" title="2.7 分布式存储"></a>2.7 分布式存储</h4><p>在分布式存储应用中，利用一致性哈希算法，可以解决缓存等分布式系统的扩容、缩容导致数据大量搬移的难题。</p><h5 id="2-7-1-一致性哈希算法"><a href="#2-7-1-一致性哈希算法" class="headerlink" title="2.7.1 一致性哈希算法"></a>2.7.1 一致性哈希算法</h5><p>一致性哈希算法是对<code>2^32</code>进行取模运算，是一个固定的值。即<code>0~(2^32)-1</code>的数字空间中。现在我们可以将这些数字头尾相连，想象成一个闭合的环形。如下图：<br><img src="/2022/03/25/data-structure-hashalgorithm/06_01.png"></p><p>一致性哈希要进行的两步哈希：</p><ol><li>对存储节点进行哈希计算，也就是对存储节点做哈希映射，比如根据节点的 IP 地址进行哈希；</li><li>当对数据进行存储或访问时，对数据进行哈希映射；</li><li>所以，<strong>一致性哈希是指将「存储节点」和「数据」都映射到一个首尾相连的哈希环上</strong>。</li></ol><p>如下图，已经有3个节点经过哈希计算，映射到了哈希环上相应的位置，有三个数据进行哈希映射到节点上；<br>①首先，对 <code>key</code> 进行哈希计算，确定此 <code>key</code> 在环上的位置；<br>②然后，从这个位置沿着顺时针方向走，遇到的第一节点就是存储 <code>key</code> 的节点。<br><img src="/2022/03/25/data-structure-hashalgorithm/06_02.png"></p><p>假设节点数量从 3 增加到了 4，新的节点 D 经过哈希计算后映射到了下图中的位置；<br>可以看到，key-1、key-3 都不受影响，只有 key-2 需要被迁移节点 D。<br><img src="/2022/03/25/data-structure-hashalgorithm/06_03.png"></p><p>假设节点数量从 3 减少到了 2，比如将节点 A 移除；<br>你可以看到，key-2 和 key-3 不会受到影响，只有 key-1 需要被迁移节点 B。<br><img src="/2022/03/25/data-structure-hashalgorithm/06_04.png"></p><p>在一致性哈希算法中，如果增加或者移除一个节点，<strong>仅影响该节点在哈希环上顺时针相邻的后继节点</strong>，其它数据也不会受到影响。</p><h5 id="2-7-2-虚拟节点"><a href="#2-7-2-虚拟节点" class="headerlink" title="2.7.2 虚拟节点"></a>2.7.2 虚拟节点</h5><p><strong>一致性哈希算法虽然减少了数据迁移量，但是并不保证节点能够在哈希环上分布均匀</strong>，这样就会带来一个问题，会有大量的请求集中在一个节点上。在这种情况下进行容灾与扩容时，容易出现雪崩的连锁反应。<br>如下图中 3 个节点的映射位置都在哈希环的右半边：<br><img src="/2022/03/25/data-structure-hashalgorithm/06_05.png"></p><p>要想解决节点能在哈希环上分配不均匀的问题，就是要有大量的节点，节点数越多，哈希环上的节点分布的就越均匀。<br>这个时候我们就加入<strong>虚拟节点</strong>，也就是对一个真实节点做多个副本。<br>具体做法是，不再将真实节点映射到哈希环上，而是将虚拟节点映射到哈希环上，并将虚拟节点映射到实际节点，所以这里有<strong>「两层」映射关系</strong>。</p><p>比如对每个节点分别设置 3 个虚拟节点，引入虚拟节点后，原本哈希环上只有 3 个节点的情况，就会变成有 9 个虚拟节点映射到哈希环上，哈希环上的节点数量多了 3 倍。<br>节点数量多了后，节点在哈希环上的分布就相对均匀了。<br><img src="/2022/03/25/data-structure-hashalgorithm/06_06.png"><br>这时候，如果有访问请求寻址到「A-01」这个虚拟节点，接着再通过「A-01」虚拟节点找到真实节点 A，这样请求就能访问到真实节点 A 了。</p><p>虚拟节点除了会提高节点的均衡度，还会提高系统的稳定性。当节点变化时，会有不同的节点共同分担系统的变化，因此稳定性更高。</p><p>有了虚拟节点后，还可以为硬件配置更好的节点增加权重，比如对权重更高的节点增加更多的虚拟机节点即可。</p><p>因此，<strong>带虚拟节点的一致性哈希方法不仅适合硬件配置不同的节点的场景，而且适合节点规模会发生变化的场景</strong>。</p><h5 id="2-7-3-分布式存储的哈希算法总结"><a href="#2-7-3-分布式存储的哈希算法总结" class="headerlink" title="2.7.3 分布式存储的哈希算法总结"></a>2.7.3 分布式存储的哈希算法总结</h5><p>一致性哈希是指将「存储节点」和「数据」都映射到一个首尾相连的哈希环上，如果增加或者移除一个节点，仅影响该节点在哈希环上顺时针相邻的后继节点，其它数据也不会受到影响。</p><p>但是一致性哈希算法不能够均匀的分布节点，会出现大量请求都集中在一个节点的情况，在这种情况下进行容灾与扩容时，容易出现雪崩的连锁反应。</p><p>为了解决一致性哈希算法不能够均匀的分布节点的问题，就需要引入虚拟节点，对一个真实节点做多个副本。不再将真实节点映射到哈希环上，而是将虚拟节点映射到哈希环上，并将虚拟节点映射到实际节点，所以这里有「两层」映射关系。</p><p>引入虚拟节点后，可以会提高节点的均衡度，还会提高系统的稳定性。所以，带虚拟节点的一致性哈希方法不仅适合硬件配置不同的节点的场景，而且适合节点规模会发生变化的场景。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;哈希算法（Hash）又称摘要算法（Digest），它的作用是：对任意一组输入数据进行计算，得到一个固定长度的输出摘要。&lt;/p&gt;
&lt;p&gt;哈希算法最重要的特点就是：相同的输入一定得到相同的输出；不同的输入大概率得到不同的输出。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」散列表（Hash Table）</title>
    <link href="http://chaooo.github.io/2022/03/18/data-structure-hashtable.html"/>
    <id>http://chaooo.github.io/2022/03/18/data-structure-hashtable.html</id>
    <published>2022-03-18T09:46:12.000Z</published>
    <updated>2022-08-25T08:25:39.630Z</updated>
    
    <content type="html"><![CDATA[<p>散列表（<code>Hash Table</code>），也叫“哈希表”或者“Hash表”。是能够通过给定的关键字的值直接访问到具体对应的值的一个数据结构。</p><p>通常，我们把这个关键字称为 <code>Key</code>，把对应的记录称为 <code>Value</code>，所以也可以说是通过 <code>Key</code> 访问一个映射表来得到 <code>Value</code> 的地址。而这个映射表，也叫作散列函数或者哈希函数，存放记录的数组叫作散列表。</p><p>散列表用的是<strong>数组支持按照下标随机访问数据</strong>的特性，所以散列表其实就是<strong>数组的一种扩展</strong>，由数组演化而来。</p><span id="more"></span><p><code>Hash</code>，一般翻译做“散列”&#x2F;“哈希”，就是把任意长度的输入，通过散列算法，变换成固定长度的输出，该输出就是散列值。<br>(这种转换是一种压缩映射，也就是，散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，这种现象叫作碰撞（Collision）。)<br>简单的说就是一种将任意长度的消息压缩到某一固定长度的消息摘要的函数。</p><p>对散列表中的键(<code>key</code>)进行<code>Hash</code>的函数就是散列函数（<code>Hash(key)</code>）。函数的计算结果就是散列值,就是<code>Hash(key)</code>的值。</p><h3 id="1-几种常见哈希函数："><a href="#1-几种常见哈希函数：" class="headerlink" title="1. 几种常见哈希函数："></a>1. 几种常见哈希函数：</h3><ul><li>直接寻址法：取关键字或关键字的某个线性函数值为散列地址；如<code>Hash(key)=key</code>或者<code>Hash(key)=a*key+b</code>，<code>a</code>和<code>b</code>都为常数。</li><li>数字分析法：如果关键字由多位字符或者数字组成，就可以考虑抽取其中的<code>2</code>位或者多位作为该关键字对应的散列地址，在取法上尽量选择变化较多的位，避免冲突发生。</li><li>平方取中法：对关键字做平方操作，取平方值的中间几位作为散列地址。此方法也是比较常用的构造哈希函数的方法。计算平方之后的中间几位和关键字中的每一位都相关，所以不同的关键字会以较高的概率产生不同的散列地址。</li><li>折叠法：将关键字分割成位数相同的几部分（最后一部分的位数可以不同），然后取这几部分的叠加和（舍去进位）作为哈希地址。此方法适合关键字位数较多的情况。</li><li>取随机数法：使用一个随机函数，取关键字的随机值作为散列地址，这种方式通常用于关键字长度不同的场合。</li><li>除留余数法：若已知整个哈希表的最大长度<code>m</code>，可以取一个不大于<code>m</code>的数<code>p</code>，然后对该关键字<code>key</code>做取余运算，即：<code>Hash(key)=key%p</code>。</li><li>随机数法：取关键字的一个随机函数值作为它的哈希地址，即：<code>Hash(key)=random(key)</code>，此方法适用于关键字长度不等的情况。</li></ul><p>构建哈希函数，需要根据实际的查找表的情况采取适当的方法。通常考虑的因素有以下几方面：</p><ol><li>关键字的长度。如果长度不等，就选用随机数法。如果关键字位数较多，就选用折叠法或者数字分析法；反之如果位数较短，可以考虑平方取中法；</li><li>哈希表的大小。如果大小已知，可以选用除留余数法；</li><li>关键字的分布情况；</li><li>查找表的查找频率；</li><li>计算哈希函数所需的时间（包括硬件指令的因素）</li></ol><h3 id="２-几种哈希冲突的处理方式："><a href="#２-几种哈希冲突的处理方式：" class="headerlink" title="２. 几种哈希冲突的处理方式："></a>２. 几种哈希冲突的处理方式：</h3><ul><li>开放寻址法：<code>Hash(key) = (Hash(key) + d) MOD m</code>；（其中<code>m</code>为哈希表的表长，<code>d</code>为一个增量）。当得出的哈希地址产生冲突时，选取一种探测方法获取<code>d</code>的值，然后继续计算，直到计算出的哈希地址不在冲突为止。三种探测方法：<ul><li>线性探测法：d&#x3D;1，2，3，…，m-1 （每次 +1，向右探测，直到有空闲的位置为止）</li><li>二次探测法：d&#x3D;12，-12，22，-22，32，… （按照 +12，-12，+22，…如此探测，直到有空闲的位置）</li><li>伪随机数探测法：d&#x3D;伪随机数 （每次加上一个随机数，直到探测到空闲位置结束）</li></ul></li><li>再哈希法：当通过哈希函数求得的哈希地址同其他关键字产生冲突时，使用另一个哈希函数计算，直到冲突不再发生。</li><li>链地址法：链地址法其实就是对Key通过哈希之后落在同一个地址上的值，做一个链表。</li><li>建立一个公共溢出区：建立两张表，一张为基本表，另一张为溢出表。基本表存储没有发生冲突的数据，当关键字由哈希函数生成的哈希地址产生冲突时，就将数据填入溢出表。</li></ul><h3 id="３-散列表的特点"><a href="#３-散列表的特点" class="headerlink" title="３. 散列表的特点"></a>３. 散列表的特点</h3><ol><li>访问速度很快<ul><li>由于散列表有散列函数，可以将指定的 Key 都映射到一个地址上，所以在访问一个 Key（键）对应的 Value（值）时，根本不需要一个一个地进行查找，可以直接跳到那个地址。所以我们在对散列表进行添加、删除、修改、查找等任何操作时，速度都很快。</li></ul></li><li>需要额外的空间<ul><li>首先，散列表实际上是存不满的，如果一个散列表刚好能够存满，那么肯定是个巧合。而且当散列表中元素的使用率越来越高时，性能会下降，所以一般会选择扩容来解决这个问题。另外，如果有冲突的话，则也是需要额外的空间去存储的，比如链地址法，不但需要额外的空间，甚至需要使用其他数据结构。</li><li>这个特点有个很常用的词可以表达，叫作“空间换时间”，在大多数时候，对于算法的实现，为了能够有更好的性能，往往会考虑牺牲些空间，让算法能够更快些。</li></ul></li><li>无序<ul><li>散列表还有一个非常明显的特点，那就是无序。为了能够更快地访问元素，散列表是根据散列函数直接找到存储地址的，这样我们的访问速度就能够更快，但是对于有序访问却没有办法应对。</li></ul></li><li>可能会产生碰撞<ul><li>没有完美的散列函数，无论如何总会产生冲突，这时就需要采用冲突解决方案，这也使散列表更加复杂。通常在不同的高级语言的实现中，对于冲突的解决方案不一定一样。</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;散列表（&lt;code&gt;Hash Table&lt;/code&gt;），也叫“哈希表”或者“Hash表”。是能够通过给定的关键字的值直接访问到具体对应的值的一个数据结构。&lt;/p&gt;
&lt;p&gt;通常，我们把这个关键字称为 &lt;code&gt;Key&lt;/code&gt;，把对应的记录称为 &lt;code&gt;Value&lt;/code&gt;，所以也可以说是通过 &lt;code&gt;Key&lt;/code&gt; 访问一个映射表来得到 &lt;code&gt;Value&lt;/code&gt; 的地址。而这个映射表，也叫作散列函数或者哈希函数，存放记录的数组叫作散列表。&lt;/p&gt;
&lt;p&gt;散列表用的是&lt;strong&gt;数组支持按照下标随机访问数据&lt;/strong&gt;的特性，所以散列表其实就是&lt;strong&gt;数组的一种扩展&lt;/strong&gt;，由数组演化而来。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」跳表（Skip List）</title>
    <link href="http://chaooo.github.io/2022/03/12/data-structure-skiplist.html"/>
    <id>http://chaooo.github.io/2022/03/12/data-structure-skiplist.html</id>
    <published>2022-03-12T12:08:10.000Z</published>
    <updated>2022-08-25T08:24:48.639Z</updated>
    
    <content type="html"><![CDATA[<p>跳表（Skip List）是一个动态数据结构（链表加多级索引），可以支持快速地插入、删除、查找操作的有序链表。<br>跳表在原有的有序链表上面增加了多级索引，通过索引来实现快速查找。</p><span id="more"></span><h3 id="1-跳表的演化"><a href="#1-跳表的演化" class="headerlink" title="1. 跳表的演化"></a>1. 跳表的演化</h3><p>跳表的原始链表是一个有序单链表，如果要想在其中查找某个数据，只能从头到尾遍历链表。这样查找效率就会很低，时间复杂度会很高，是 O(n)。<br><img src="/2022/03/12/data-structure-skiplist/04_01.webp"></p><p>从链表中每两个结点提取一个结点到上一级，我们把抽出来的那一级叫做<strong>索引</strong>或<strong>索引层</strong>。如下图。图中的 down 表示 down 指针，指向下一级结点。<br><img src="/2022/03/12/data-structure-skiplist/04_02.webp"></p><p>加来一层索引之后，查找一个结点需要遍历的结点个数减少了，也就是说查找效率提高了。<br>跟前面建立第一级索引的方式相似，我们在第一级索引的基础之上，每两个结点就抽出一个结点到第二级索引。查找一个结点需要遍历的结点数量又减少了。<br>这就是跳表的思想，用“空间换时间”，通过给链表建立索引，提高了查找的效率。<br><img src="/2022/03/12/data-structure-skiplist/04_03.webp"></p><p>当元素数量较多时，建立多级索引，索引提高的效率比较大，近似于二分查找。<br><img src="/2022/03/12/data-structure-skiplist/04_04.webp"></p><h3 id="2-跳表查找的时间复杂度"><a href="#2-跳表查找的时间复杂度" class="headerlink" title="2. 跳表查找的时间复杂度"></a>2. 跳表查找的时间复杂度</h3><p>跳表查找元素的过程是从最高级索引开始，一层一层遍历最后下沉到原始链表。所以，<code>时间复杂度 = 索引的高度 * 每层索引遍历元素的个数</code>。</p><p>如果每两个结点会抽出一个结点作为上一级索引的结点，那第一级索引的结点个数大约就是<code>n/2</code>，第二级索引的结点个数大约就是<code>n/4</code>，第三级索引的结点个数大约就是<code>n/8</code>，依次类推，那第<code>k</code>级索引结点的个数就是<code>n/(2^k)</code>。</p><p>最高级索引一般有<code>2</code>个元素，即：最高级索引<code>h</code>满足<code>2=n/(2^h)</code>，从而求得<code>h=log2n-1</code>，如果包含原始链表这一层，整个跳表的高度就是<code>log2n</code>。</p><p>按照前面这种索引结构，我们每一级索引都最多只需要遍历<code>3</code>个结点，根据<code>时间复杂度 = 索引的高度 * 每层索引遍历元素的个数</code>，即跳表中查找一个元素的时间复杂度为<code>O(3*log2n)</code>，省略常数即：<code>O(logn)</code>。</p><h3 id="3-跳表的空间复杂度"><a href="#3-跳表的空间复杂度" class="headerlink" title="3. 跳表的空间复杂度"></a>3. 跳表的空间复杂度</h3><p>跳表通过建立索引，来提高查找元素的效率，就是典型的“空间换时间”的思想，所以在空间上做了一些牺牲。</p><p>前面提到，如果每两个结点会抽出一个结点作为上一级索引的结点，那第一级索引的结点个数大约就是<code>n/2</code>，第二级索引的结点个数大约就是<code>n/4</code>，以此类推，每上升一级就减少一半，直到剩下<code>2</code>个结点。如果我们把每层索引的结点数写出来，就是一个等比数列。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n/2, n/4, n/8, ..., 8, 4, 2</span><br></pre></td></tr></table></figure><p>这几级索引的结点总和就是<code>n/2+n/4+n/8…+8+4+2=n-2</code>。所以，跳表的空间复杂度是<code>O(n)</code>。也就是说，如果将包含<code>n</code>个结点的单链表构造成跳表，我们需要额外再用接近<code>n</code>个结点的存储空间。</p><p>我们前面都是每两个结点抽一个结点到上级索引，如果我们每三个结点或五个结点，抽一个结点到上级索引，第一级索引需要大约<code>n/3</code>个结点，第二级索引需要大约<code>n/9</code>个结点，以此类推，每往上一级，索引结点个数都除以<code>3</code>。通过等比数列求和公式，总的索引结点大约就是<code>n/3+n/9+n/27+...+9+3+1=n/2</code>。尽管空间复杂度还是<code>O(n)</code>，但比上面的每两个结点抽一个结点的索引构建方法，要减少了一半的索引结点存储空间。</p><p><strong>在软件工程中，对象数据所占的空间要远大于指针，指针大小可以忽略。</strong></p><h3 id="4-跳表的插入和删除"><a href="#4-跳表的插入和删除" class="headerlink" title="4. 跳表的插入和删除"></a>4. 跳表的插入和删除</h3><p>跳表这个动态数据结构，插入、删除操作的时间复杂度也是<code>O(logn)</code>。</p><h4 id="4-1-插入数据"><a href="#4-1-插入数据" class="headerlink" title="4.1 插入数据"></a>4.1 插入数据</h4><p>跳表的插入首先查找某个数据应该插入的位置（时间复杂度是<code>O(logn)</code>），当我们不停地往跳表中插入数据时，如果我们不更新索引，就有可能出现某 2 个索引结点之间数据非常多的情况。极端情况下，跳表还会退化成单链表。</p><p>需要某种手段来维护索引与原始链表大小之间的平衡。<br>当我们往跳表中插入数据的时候，我们可以选择同时将这个数据插入到部分索引层中。<br>我们通过一个随机函数，来决定将这个结点插入到哪几级索引中，比如随机函数生成了值 K，那我们就将这个结点添加到第一级到第K级索引中。<br>随机函数简化跳跃链表建立层级索引的复杂度，从概率上来讲，能够保证跳表的索引大小和数据大小平衡性，不至于性能过度退化。</p><p>如下图所示，插入数据<code>6</code>到跳表中，随机函数生成<code>K=2</code>:<br><img src="/2022/03/12/data-structure-skiplist/04_05.webp"></p><h4 id="4-2-删除数据"><a href="#4-2-删除数据" class="headerlink" title="4.2 删除数据"></a>4.2 删除数据</h4><p>跳表删除数据时，要把索引中对应节点也要删掉。<br>删除元素的过程跟查找元素的过程类似，只不过在查找的路径上如果发现了要删除的元素<code>x</code>，则执行删除操作。</p><p>如下图所示，如果要删除元素<code>9</code>，需要把原始链表中的<code>9</code>和第一级索引的<code>9</code>都删除掉。<br><img src="/2022/03/12/data-structure-skiplist/04_06.webp"></p><h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h3><p>跳表是查询效率近似于二分查找的有序链表；<br>每个元素插入时随机生成它的索引层级level；<br>最底层原始链表包含所有的元素；<br>如果一个元素出现在<code>x</code>层索引，那么它肯定出现在<code>x</code>以下的索引层中；<br>跳表查询、插入、删除的时间复杂度为<code>O(logn)</code>，与平衡二叉树接近；</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;跳表（Skip List）是一个动态数据结构（链表加多级索引），可以支持快速地插入、删除、查找操作的有序链表。&lt;br&gt;跳表在原有的有序链表上面增加了多级索引，通过索引来实现快速查找。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」栈（Stack）与 队列（Queue）</title>
    <link href="http://chaooo.github.io/2022/03/05/data-structure-stack-queue.html"/>
    <id>http://chaooo.github.io/2022/03/05/data-structure-stack-queue.html</id>
    <published>2022-03-05T07:06:28.000Z</published>
    <updated>2022-08-25T08:23:55.247Z</updated>
    
    <content type="html"><![CDATA[<p>栈（Stack）和队列（Queue），严格意义上来说，也属于线性表，是一种<strong>操作受限的线性表数据结构</strong>。<br>使用栈结构存储数据，讲究“先进后出”，即最先进栈的数据，最后出栈；<br>使用队列存储数据，讲究“先进先出”，即最先进队列的数据，也最先出队列。</p><span id="more"></span><h3 id="1-栈"><a href="#1-栈" class="headerlink" title="1. 栈"></a>1. 栈</h3><p>栈（<code>Stack</code>）是一种只能从一端存取数据且遵循“<strong>先进后出</strong>”原则（First In Last Out，简称FILO）的线性存储结构。<br>通常，栈的开口端被称为栈顶；相应地，封口端被称为栈底。<br>栈只支持两个基本操作：<strong>入栈</strong><code>push()</code>和<strong>出栈</strong><code>pop()</code>。</p><h4 id="1-1-栈的实现"><a href="#1-1-栈的实现" class="headerlink" title="1.1 栈的实现"></a>1.1 栈的实现</h4><p>栈既可以用数组来实现，也可以用链表来实现。用数组实现的栈，我们叫作顺序栈，用链表实现的栈，我们叫作链式栈。</p><h4 id="1-2-栈的应用"><a href="#1-2-栈的应用" class="headerlink" title="1.2 栈的应用"></a>1.2 栈的应用</h4><ol><li>栈在函数调用中的应用<ul><li>操作系统给每个线程分配了一块独立的内存空间，这块内存被组织成“栈”这种结构，用来存储函数调用时的临时变量。每进入一个函数，就会将其中的临时变量作为栈帧入栈，当被调用函数执行完成，返回之后，将这个函数对应的栈帧出栈。</li></ul></li><li>栈在表达式求值中的应用（比如：<code>34+13*9+44-12/3</code>）<ul><li>利用两个栈，其中一个用来保存操作数，另一个用来保存运算符。我们从左向右遍历表达式，当遇到数字，我们就直接压入操作数栈；当遇到运算符，就与运算符栈的栈顶元素进行比较，若比运算符栈顶元素优先级高，就将当前运算符压入栈，若比运算符栈顶元素的优先级低或者相同，从运算符栈中取出栈顶运算符，从操作数栈顶取出2个操作数，然后进行计算，把计算完的结果压入操作数栈，继续比较。</li></ul></li><li>栈在括号匹配中的应用（比如：<code>&#123;&#125;&#123;[()]()&#125;</code>）<ul><li>用栈保存为匹配的左括号，从左到右一次扫描字符串，当扫描到左括号时，则将其压入栈中；当扫描到右括号时，从栈顶取出一个左括号，如果能匹配上，则继续扫描剩下的字符串。如果扫描过程中，遇到不能配对的右括号，或者栈中没有数据，则说明为非法格式。</li><li>当所有的括号都扫描完成之后，如果栈为空，则说明字符串为合法格式；否则，说明未匹配的左括号为非法格式。</li></ul></li><li>实现浏览器的前进后退功能<ul><li>我们使用两个栈<code>X</code>和<code>Y</code>，我们把首次浏览的页面依次压如栈<code>X</code>，当点击后退按钮时，再依次从栈<code>X</code>中出栈，并将出栈的数据一次放入<code>Y</code>栈。当点击前进按钮时，我们依次从栈<code>Y</code>中取出数据，放入栈<code>X</code>中。当栈<code>X</code>中没有数据时，说明没有页面可以继续后退浏览了。当<code>Y</code>栈没有数据，那就说明没有页面可以点击前进浏览了。</li></ul></li></ol><h4 id="1-3-为什么函数调用要用“栈”来保存临时变量？"><a href="#1-3-为什么函数调用要用“栈”来保存临时变量？" class="headerlink" title="1.3 为什么函数调用要用“栈”来保存临时变量？"></a>1.3 为什么函数调用要用“栈”来保存临时变量？</h4><ul><li>因为函数调用的执行顺序符合后进者先出，先进者后出的特点。比如函数中的局部变量的生命周期的长短是先定义的生命周期长，后定义的生命周期短；还有函数中调用函数也是这样，先开始执行的函数只有等到内部调用的其他函数执行完毕，该函数才能执行结束。</li><li>正是由于函数调用的这些特点，根据数据结构是特定应用场景的抽象的原则，我们优先考虑栈结构。</li></ul><h3 id="2-队列"><a href="#2-队列" class="headerlink" title="2. 队列"></a>2. 队列</h3><p>队列（<code>queue</code>）是一种遵循“<strong>先进先出</strong>”原则（First In First Out，简称FIFO）的线性存储结构。<br>与栈结构不同的是，队列的两端都“开口”，要求数据只能从一端进，从另一端出；通常，称进数据的一端为“队尾”，出数据的一端为“队头”。<br>最基本的操作也是两个：<strong>入队</strong><code>enqueue()</code>，放一个数据到队列尾部；<strong>出队</strong><code>dequeue()</code>，从队列头部取一个元素。<br>所以，队列跟栈一样，也是一种<strong>操作受限的线性表数据结构</strong>。</p><h4 id="2-1-队列的实现"><a href="#2-1-队列的实现" class="headerlink" title="2.1 队列的实现"></a>2.1 队列的实现</h4><ul><li>队列存储结构的实现有以下两种方式：<ul><li>顺序队列：在顺序表的基础上实现的队列结构。</li><li>链队列：在链表的基础上实现的队列结构。</li></ul></li><li>跟栈一样，队列可以用数组来实现，也可以用链表来实现。用数组实现的队列叫作顺序队列，用链表实现的队列叫作链式队列。</li><li>基于链表的实现方式，可以实现一个支持无限排队的<strong>无界队列</strong>（unbounded queue），但是可能会导致过多的请求排队等待，请求处理的响应时间过长。所以，针对响应时间比较敏感的系统，基于链表实现的无限排队的线程池是不合适的。</li><li>而基于数组实现的<strong>有界队列</strong>（bounded queue），队列的大小有限，所以线程池中排队的请求超过队列大小时，接下来的请求就会被拒绝，这种方式对响应时间敏感的系统来说，就相对更加合理。不过，设置一个合理的队列大小，也是非常有讲究的。队列太大导致等待的请求太多，队列太小会导致无法充分利用系统资源、发挥最大性能。</li></ul><h4 id="2-2-队列的应用"><a href="#2-2-队列的应用" class="headerlink" title="2.2 队列的应用"></a>2.2 队列的应用</h4><ol><li>循环队列<ul><li>循环队列还是基于数组实现的。原本数组是有头有尾的，是一条直线。我们把首尾相连，扳成了一个环，形成逻辑上的环状空间。</li></ul></li><li>阻塞队列<ul><li>在队列的基础上增加阻塞操作，就成了阻塞队列。</li><li>阻塞队列就是在队列为空的时候，从队头取数据会被阻塞，因为此时还没有数据可取，直到队列中有了数据才能返回；如果队列已经满了，那么插入数据的操作就会被阻塞，直到队列中有空闲位置后再插入数据，然后在返回。</li><li>从上面的定义可以看出这就是一个“生产者-消费者模型”。这种基于阻塞队列实现的“生产者-消费者模型”可以有效地协调生产和消费的速度。当“生产者”生产数据的速度过快，“消费者”来不及消费时，存储数据的队列很快就会满了，这时生产者就阻塞等待，直到“消费者”消费了数据，“生产者”才会被唤醒继续生产。不仅如此，基于阻塞队列，我们还可以通过协调“生产者”和“消费者”的个数，来提高数据处理效率，比如配置几个消费者，来应对一个生产者。</li></ul></li><li>并发队列<ul><li>在多线程的情况下，会有多个线程同时操作队列，这时就会存在线程安全问题。能够有效解决线程安全问题的队列就称为并发队列。</li><li>并发队列简单的实现就是在enqueue()、dequeue()方法上加锁，但是锁粒度大并发度会比较低，同一时刻仅允许一个存或取操作。</li><li>实际上，基于数组的循环队列利用CAS原子操作，可以实现非常高效的并发队列。这也是循环队列比链式队列应用更加广泛的原因。</li></ul></li><li>线程池资源枯竭是的处理<ul><li>在资源有限的场景，当没有空闲资源时，基本上都可以通过“队列”这种数据结构来实现请求排队。</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;栈（Stack）和队列（Queue），严格意义上来说，也属于线性表，是一种&lt;strong&gt;操作受限的线性表数据结构&lt;/strong&gt;。&lt;br&gt;使用栈结构存储数据，讲究“先进后出”，即最先进栈的数据，最后出栈；&lt;br&gt;使用队列存储数据，讲究“先进先出”，即最先进队列的数据，也最先出队列。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」数组与链表</title>
    <link href="http://chaooo.github.io/2022/02/28/data-structure-array-linked-list.html"/>
    <id>http://chaooo.github.io/2022/02/28/data-structure-array-linked-list.html</id>
    <published>2022-02-28T13:05:24.000Z</published>
    <updated>2022-07-27T05:22:09.734Z</updated>
    
    <content type="html"><![CDATA[<p>线性表（Linear List）。顾名思义，线性表就是数据排成像一条线一样的结构。每个线性表上的数据最多只有前和后两个方向。比如数组，链表、队列、栈等也是线性表结构。<br>而与它相对立的概念是非线性表，比如二叉树、堆、图等。之所以叫非线性，是因为，在非线性表中，数据之间并不是简单的前后关系。</p><span id="more"></span><h3 id="1-数组"><a href="#1-数组" class="headerlink" title="1. 数组"></a>1. 数组</h3><p>数组（<code>Array</code>）是一种线性表数据结构。它用一组连续的内存空间，来存储一组具有相同类型的数据。</p><p>数组寻址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[i]_address = base_address + i * data_type_size</span><br></pre></td></tr></table></figure><p>以长度为10的int数组（<code>int[] a = new int[10]</code>）为例：分配了一块连续内存空间 <code>1000～1039</code>，其中，内存块的首地址为 <code>base_address = 1000</code>，<code>int</code>类型的<code>data_type_size</code>为<code>4</code>个字节，即<code>a[0]</code>地址为<code>1000</code>，<code>a[1]</code>地址为<code>1004</code>…</p><p><img src="/2022/02/28/data-structure-array-linked-list/array_address.webp"></p><p>容器是否完全替代数组？</p><ul><li>容器的优势：对于Java语言，容器封装了数组插入、删除等操作的细节，并且支持动态扩容。</li><li>对于Java，一些更适合用数组的场景：<ol><li>Java的<code>ArrayList</code>无法存储基本类型，需要进行装箱操作，而装箱与拆箱操作都会有一定的性能消耗，如果特别注意性能，或者希望使用基本类型，就可以选用数组。</li><li>若数组大小事先已知，并且对数组只有非常简单的操作，不需要使用到<code>ArrayList</code>提供的大部分方法，则可以直接使用数组。</li><li>多维数组时，使用数组会更加直观。</li></ol></li></ul><h3 id="2-链表"><a href="#2-链表" class="headerlink" title="2. 链表"></a>2. 链表</h3><p>链表（<code>Linked list</code>）也是一种线性表数据结构。它的内存结构是不连续的内存空间，是将一组零散的内存块串联起来，从而进行数据存储。<br>链表中每一个内存块称为节点（<code>Node</code>），节点除了存储数据外，还需存储下一个节点的地址。</p><ol><li>单链表：每个节点只包含一个指针，即后继指针（<code>next</code>）；首节点地址表示整条链表，尾节点的后继指针指向空地址null。</li><li>循环链表：尾节点的后继指针指向首节点，其他与单链表一致。</li><li>双向链表：每个节点包含两个指针，前驱指针（<code>prev</code>）和后继指针（<code>next</code>），首节点的前驱指针和尾节点后继指针都指向空地址null。</li><li>双向循环链表：首节点前驱指针指向尾节点，尾节点后继指针指向首节点，其他与双链表一致。</li></ol><h3 id="3-数组vs链表"><a href="#3-数组vs链表" class="headerlink" title="3. 数组vs链表"></a>3. 数组vs链表</h3><ol><li>数组中的元素存在一个连续的内存空间中，若数组申请空间足够但不连续也会失败；而链表中的元素可以存在于不连续的内存空间，不过需要额外的内存空间存储指针信息。</li><li>数组支持随机访问，根据下标随机访问的时间复杂度是<code>O(1)</code>；链表随机访问的时间复杂度是<code>O(n)</code>。</li><li>链表适合插入、删除操作，时间复杂度为<code>O(1)</code>；数组插入、删除操作，时间复杂度为<code>O(n)</code>。</li><li>数组大小固定，若存储空间不足，需要进行扩容，扩容就需要数据复制，这非常耗时；链表进行频繁的插入删除操作会导致内存频繁的内存申请和释放，容易造成内存碎片，Java环境还可能造成频繁的<code>GC</code>(自动垃圾回收)操作。</li><li>数组在实现上使用连续的内存空间，可以借助CPU的缓冲机制预读数组中的数据，所以访问效率更高，而链表在内存中并不是连续存储，所以对CPU缓存不友好，没办法预读。</li></ol><h3 id="附：双向链表的Java实现"><a href="#附：双向链表的Java实现" class="headerlink" title="附：双向链表的Java实现"></a>附：双向链表的Java实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双向链表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedList</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 头节点指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node&lt;E&gt; first;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尾节点指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node&lt;E&gt; last;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedList</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结点类（私有静态内部类）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node&lt;E&gt; prev;</span><br><span class="line">        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.item = element;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">            <span class="built_in">this</span>.prev = prev;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回size</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加元素（默认尾部添加）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        linkLast(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加为头元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        linkFirst(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (x.item == <span class="literal">null</span>) &#123;</span><br><span class="line">                    unlink(x);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                    unlink(x);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据索引获取元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        checkElementIndex(index);</span><br><span class="line">        <span class="keyword">return</span> node(index).item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据索引设置元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">set</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">        checkElementIndex(index);</span><br><span class="line">        Node&lt;E&gt; x = node(index);</span><br><span class="line">        <span class="type">E</span> <span class="variable">oldVal</span> <span class="operator">=</span> x.item;</span><br><span class="line">        x.item = element;</span><br><span class="line">        <span class="keyword">return</span> oldVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * e元素链接为尾部</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">linkLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(l, e, <span class="literal">null</span>);</span><br><span class="line">        last = newNode;</span><br><span class="line">        <span class="keyword">if</span> (l == <span class="literal">null</span>)</span><br><span class="line">            first = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            l.next = newNode;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * e元素链接为头部</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">linkFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; f = first;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>, e, f);</span><br><span class="line">        first = newNode;</span><br><span class="line">        <span class="keyword">if</span> (f == <span class="literal">null</span>)</span><br><span class="line">            last = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            f.prev = newNode;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消非空节点 x 的链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; x)</span> &#123;</span><br><span class="line">        <span class="comment">// assert x != null;</span></span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line">        <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev.next = next;</span><br><span class="line">            x.prev = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">            last = prev;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next.prev = prev;</span><br><span class="line">            x.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        x.item = <span class="literal">null</span>;</span><br><span class="line">        size--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据指定索引检查非空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkElementIndex</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(index &gt;= <span class="number">0</span> &amp;&amp; index &lt; size))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Index: &quot;</span>+index+<span class="string">&quot;, Size: &quot;</span>+size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回指定索引的（非空）节点。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node&lt;E&gt; <span class="title function_">node</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">            x = first;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">                x = x.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            x = last;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">                x = x.prev;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;线性表（Linear List）。顾名思义，线性表就是数据排成像一条线一样的结构。每个线性表上的数据最多只有前和后两个方向。比如数组，链表、队列、栈等也是线性表结构。&lt;br&gt;而与它相对立的概念是非线性表，比如二叉树、堆、图等。之所以叫非线性，是因为，在非线性表中，数据之间并不是简单的前后关系。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「数据结构与算法」复杂度分析</title>
    <link href="http://chaooo.github.io/2022/02/26/data-structure-complexity.html"/>
    <id>http://chaooo.github.io/2022/02/26/data-structure-complexity.html</id>
    <published>2022-02-26T10:12:38.000Z</published>
    <updated>2022-07-27T06:04:07.799Z</updated>
    
    <content type="html"><![CDATA[<p>数据结构与算法解决的是：如何让计算机更快时间、更省空间的解决问题。<br>因此需要从执行时间和占用空间两个维度来评估数据结构和算法的性能，二者统称为复杂度。<br>复杂度描述的是算法执行时间或占用系统空间与数据规模的增长关系。</p><span id="more"></span><p>和性能测试相比，复杂度分析有不依赖执行环境、成本低、效率高、易操作、指导性强的特点。<br>掌握复杂度分析，将能编写出性能更优的代码，有利于降低系统开发和维护成本。</p><h3 id="1-时间复杂度与空间复杂度"><a href="#1-时间复杂度与空间复杂度" class="headerlink" title="1. 时间复杂度与空间复杂度"></a>1. 时间复杂度与空间复杂度</h3><p>大O表示法：所有代码的执行时间<code>T(n)</code>与每行代码的执行次数<code>f(n)</code>成正比，用<code>T(n) = O(f(n))</code>表示，其中<code>n</code>表示数据规模的大小</p><ul><li><code>T(n) = O(f(n))</code>表示<em>算法的执行时间与数据规模之间的增长关系</em>，所以也叫<em>渐进时间复杂度</em>（asymptotic time complexity），简称<strong>时间复杂度</strong>。</li><li>类比一下，S(n)&#x3D;O(f(n))表示<strong>空间复杂度</strong>全称就是<em>渐进空间复杂度</em>（asymptotic space complexity），表示<em>算法的存储空间与数据规模之间的增长关系</em>。</li></ul><h3 id="2-复杂度量级"><a href="#2-复杂度量级" class="headerlink" title="2. 复杂度量级"></a>2. 复杂度量级</h3><ul><li>多项式量级：随着数据规模的增长，算法的执行时间和空间占用，按照多项式的比例增长。这类有：<ul><li>常量阶<code>O(1)</code></li><li>对数阶<code>O(logn)</code></li><li>线性阶<code>O(n)</code></li><li>线性对数阶<code>O(nlogn)</code></li><li>平方阶<code>O(n^2)</code>、立方阶<code>O(n^3)</code>、···、k次方阶<code>O(n^k)</code></li></ul></li><li>非多项式量级NP（NP：Non-Deterministic Polynomial，非确定多项式）：随着数据规模的增长，算法的执行时间和空间占用暴增，这类算法性能极差。非多项式量级只有两个：指数阶<code>O(2^n)</code> 和 阶乘阶<code>O(n!)</code>。</li></ul><p><img src="/2022/02/26/data-structure-complexity/complexity.png"></p><ul><li>复杂度分析法则<ol><li>单段代码看高频：比如循环。</li><li>多段代码取最大：比如一段代码中有单循环和多重循环，那么取多重循环的复杂度。</li><li>嵌套代码求乘积：比如递归、多重循环等</li><li>多个规模求加法：比如方法有两个参数控制两个循环的次数，那么这时就取二者复杂度相加。</li></ol></li></ul><h3 id="3-复杂度分析的4个概念"><a href="#3-复杂度分析的4个概念" class="headerlink" title="3.复杂度分析的4个概念"></a>3.复杂度分析的4个概念</h3><p>代码复杂度在不同情况下出现量级差别时，为了更全面，更准确的描述代码的时间复杂度，所以引入这4个概念。大多数情况下，是不需要区别分析它们的。</p><ol><li>最好时间复杂度（best case time complexity）：代码在最理想情况下执行的时间复杂度。</li><li>最坏时间复杂度（worst case time complexity）：代码在最坏情况下执行的时间复杂度。</li><li>平均时间复杂度（average case time complexity）：用代码在所有情况下执行的次数的加权平均值表示。<ul><li>分析：代码在不同情况下复杂度出现量级差别，则用代码所有可能情况下执行次数的加权平均值表示。</li></ul></li><li>均摊时间复杂度（amortized time complexity）：在代码执行的所有复杂度情况中绝大部分是低级别的复杂度，个别情况是高级别复杂度且发生具有时序关系时，可以将个别高级别复杂度均摊到低级别复杂度上。均摊结果一般都等于低级别复杂度。<ul><li>分析：两个条件满足时使用：①代码在绝大多数情况下是低级别复杂度，只有极少数情况是高级别复杂度；②低级别和高级别复杂度出现具有时序规律。均摊结果一般都等于低级别复杂度。</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;数据结构与算法解决的是：如何让计算机更快时间、更省空间的解决问题。&lt;br&gt;因此需要从执行时间和占用空间两个维度来评估数据结构和算法的性能，二者统称为复杂度。&lt;br&gt;复杂度描述的是算法执行时间或占用系统空间与数据规模的增长关系。&lt;/p&gt;</summary>
    
    
    
    <category term="数据结构" scheme="http://chaooo.github.io/categories/data-structure/"/>
    
    
    <category term="算法" scheme="http://chaooo.github.io/tags/algorithm/"/>
    
    <category term="数据结构" scheme="http://chaooo.github.io/tags/data-structure/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」前后端分离权限控制-指令级权限</title>
    <link href="http://chaooo.github.io/2021/12/30/spring-security-permission.html"/>
    <id>http://chaooo.github.io/2021/12/30/spring-security-permission.html</id>
    <published>2021-12-30T04:28:00.000Z</published>
    <updated>2022-04-17T07:51:08.804Z</updated>
    
    <content type="html"><![CDATA[<p>实现按钮级别的权限控制，基于上一篇<a href="https://my.oschina.net/chaoo/blog/5380267">Spring Secuirty（六）前后端分离菜单权限控制-前端动态路由</a>的扩展。<br>前端部分还是基于<a href="https://panjiachen.github.io/vue-element-admin-site/zh/">vue-element-admin</a>模板来演示。</p><p>这里实现按钮级别的权限判断的逻辑：每个按钮对应一个<code>权限标识</code>，后台根据用户角色计算出当前用户可访问的<code>权限标识</code>列表，前端登录后得到<code>权限标识</code>列表存入全局，通过单个按钮的<code>权限标识</code>去匹配列表里的。来实现按钮级别的权限判断。<span id="more"></span></p><h3 id="1-数据库添加权限表"><a href="#1-数据库添加权限表" class="headerlink" title="1. 数据库添加权限表"></a>1. 数据库添加权限表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 系统权限表</span></span><br><span class="line"> <span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `system_permission`;</span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `system_permission` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  `menu_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  `name` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限标识&#x27;</span>,</span><br><span class="line">  `title` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限名称&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line"> ) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统权限表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 权限&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `system_role_permission`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `system_role_permission` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `permission_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统角色权限关联表&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="2-前端代码改造"><a href="#2-前端代码改造" class="headerlink" title="2. 前端代码改造"></a>2. 前端代码改造</h3><p>登录后通过接口直接返回用户可访问指令级权限列表：<br><img src="/2021/12/30/spring-security-permission/up-584b8affd5e003dbb50e53f100779ae49c9.webp"></p><p><a href="https://panjiachen.github.io/vue-element-admin-site/zh/">vue-element-admin</a>模板已经封装了一个通过角色来判断的指令权限：<a href="https://github.com/PanJiaChen/vue-element-admin/tree/master/src/directive/permission">v-permission</a>。</p><p>这里需要修改其逻辑：</p><h4 id="2-1-全局state中添加permissions列表"><a href="#2-1-全局state中添加permissions列表" class="headerlink" title="2.1 全局state中添加permissions列表"></a>2.1 全局<code>state</code>中添加<code>permissions</code>列表</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ---------------- state 中添加 permissions</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\store\modules\user.js</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="comment">// ... other code</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="title function_">getToken</span>(),</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">roles</span>: [],</span><br><span class="line">    <span class="attr">menus</span>: [],</span><br><span class="line">    <span class="attr">permissions</span>: [],</span><br><span class="line">    <span class="comment">// ... other code</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    <span class="attr">SET_TOKEN</span>: <span class="function">(<span class="params">state, token</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">token</span> = token</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">SET_PERMISSIONS</span>: <span class="function">(<span class="params">state, permissions</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">permissions</span> = permissions</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ... other code</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  <span class="comment">// user login</span></span><br><span class="line">  <span class="title function_">login</span>(<span class="params">&#123; commit &#125;, userInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// ... other code</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// get user info</span></span><br><span class="line">  <span class="title function_">getInfo</span>(<span class="params">&#123; commit, state &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">getInfo</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; data &#125; = response</span><br><span class="line">          <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;Verification failed, please Login again.&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> &#123; roles, menus, permissions, id, username, avatar, roleDesc, fullName, phone &#125; = data</span><br><span class="line">          <span class="comment">// roles must be a non-empty array</span></span><br><span class="line">          <span class="keyword">if</span> (!roles || roles.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;getInfo: roles must be a non-null array!&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLES&#x27;</span>, roles)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_MENUS&#x27;</span>, menus)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_PERMISSIONS&#x27;</span>, permissions)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_USERID&#x27;</span>, id)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_USERNAME&#x27;</span>, username)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_AVATAR&#x27;</span>, avatar)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLEDESC&#x27;</span>, roleDesc)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_FULLNAME&#x27;</span>, fullName)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_PHONE&#x27;</span>, phone)</span><br><span class="line">          <span class="title function_">resolve</span>(data)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(error)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// user logout</span></span><br><span class="line">  <span class="title function_">logout</span>(<span class="params">&#123; commit, state, dispatch &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ... other code</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ... other code</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  state,</span><br><span class="line">  mutations,</span><br><span class="line">  actions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------- getters 中添加 permissions</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\store\getters.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="comment">// ... other code</span></span><br><span class="line">  <span class="attr">permissions</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span>.<span class="property">permissions</span>,</span><br><span class="line">  <span class="comment">// ... other code</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> getters</span><br></pre></td></tr></table></figure><h4 id="2-2-重写全局v-permission指令逻辑"><a href="#2-2-重写全局v-permission指令逻辑" class="headerlink" title="2.2 重写全局v-permission指令逻辑"></a>2.2 重写全局<code>v-permission</code>指令逻辑</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\directive\permission\permission.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkPermission</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; value &#125; = binding</span><br><span class="line">  <span class="keyword">if</span> (value &amp;&amp; value.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> permissions = store.<span class="property">getters</span> &amp;&amp; store.<span class="property">getters</span>.<span class="property">permissions</span></span><br><span class="line">    <span class="keyword">const</span> permissionButton = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasPermission = permissions.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; permissions.<span class="title function_">some</span>(<span class="function"><span class="params">permission</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> permission === permissionButton</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!hasPermission) &#123;</span><br><span class="line">      el.<span class="property">parentNode</span> &amp;&amp; el.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`need permissions! Like v-permission=&quot;sys:menu:edit&quot;`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">inserted</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">    <span class="title function_">checkPermission</span>(el, binding)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">update</span>(<span class="params">el, binding</span>) &#123;</span><br><span class="line">    <span class="title function_">checkPermission</span>(el, binding)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-重新checkPermission权限判断函数逻辑"><a href="#2-3-重新checkPermission权限判断函数逻辑" class="headerlink" title="2.3 重新checkPermission权限判断函数逻辑"></a>2.3 重新<code>checkPermission</code>权限判断函数逻辑</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\utils\permission.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; <span class="variable">value</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Boolean</span>&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span> see @/views/permission/directive.vue</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">checkPermission</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (value &amp;&amp; value.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> permissions = store.<span class="property">getters</span> &amp;&amp; store.<span class="property">getters</span>.<span class="property">permissions</span></span><br><span class="line">    <span class="keyword">const</span> permissionButton = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasPermission = permissions.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; permissions.<span class="title function_">some</span>(<span class="function"><span class="params">permission</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> permission === permissionButton</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> hasPermission</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`need permissions! Like v-permission=&quot;sys:menu:edit&quot;`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-使用指令级权限"><a href="#3-使用指令级权限" class="headerlink" title="3. 使用指令级权限"></a>3. 使用指令级权限</h3><p>使用<code>v-permission</code>指令</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- menu delete permission can see this --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tag</span> <span class="attr">v-permission</span>=<span class="string">&quot;&#x27;sys:menu:del&#x27;&quot;</span>&gt;</span>delete<span class="tag">&lt;/<span class="name">el-tag</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- menu edit permission can see this --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tag</span> <span class="attr">v-permission</span>=<span class="string">&quot;&#x27;sys:menu:edit&#x27;&quot;</span>&gt;</span>edit<span class="tag">&lt;/<span class="name">el-tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;@/directive/permission/index.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">directives</span>: &#123; permission &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用<code>checkPermission</code>函数</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- menu delete permission can see this --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tag</span> <span class="attr">v-if</span>=<span class="string">&quot;checkPermission(&#x27;sys:menu:del&#x27;)&quot;</span>&gt;</span>delete<span class="tag">&lt;/<span class="name">el-tag</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- menu edit permission can see this --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tag</span> <span class="attr">v-if</span>=<span class="string">&quot;checkPermission(&#x27;sys:menu:edit&#x27;)&quot;</span>&gt;</span>edit<span class="tag">&lt;/<span class="name">el-tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> checkPermission <span class="keyword">from</span> <span class="string">&#x27;@/utils/permission&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span></span><br><span class="line"><span class="language-javascript">   <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    checkPermission</span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-添加按钮权限，与菜单-x2F-按钮对角色授权演示"><a href="#4-添加按钮权限，与菜单-x2F-按钮对角色授权演示" class="headerlink" title="4. 添加按钮权限，与菜单&#x2F;按钮对角色授权演示"></a>4. 添加按钮权限，与菜单&#x2F;按钮对角色授权演示</h3><p>菜单中添加按钮的权限演示<br><img src="/2021/12/30/spring-security-permission/up-3304cdd327e2f4f01862531203ae17bfa62.webp"></p><p>菜单&#x2F;按钮对角色授权演示<br><img src="/2021/12/30/spring-security-permission/up-dde01457a309a26fc04f512830e18e71485.webp"></p><p>完整代码请查看源码：</p><blockquote><p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,<br>这里我将本文的前后端分离后台菜单权限控制放在github源码tag的V5.0中，防止后续修改后代码对不上。</p></blockquote><h3 id="附：当前实例完整SQL"><a href="#附：当前实例完整SQL" class="headerlink" title="附：当前实例完整SQL"></a>附：当前实例完整SQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 系统用户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_user` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif&#x27;</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">  `fullName` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;电话&#x27;</span>,</span><br><span class="line">  `login_flag` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否阻止登录：0否，其他是&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `del_flag` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;删除标记：0未删，其他删除&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `username` (`username`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;系统用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 系统角色表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `role_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色名称&#x27;</span>,</span><br><span class="line">  `role_desc` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `del_flag` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;删除标记：0未删，其他删除&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `role_name` (`role_name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;系统角色表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 系统菜单表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_menu` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单名称&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;路由名称(前端匹配路由用)&#x27;</span>,</span><br><span class="line">  `icon` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图标&#x27;</span>,</span><br><span class="line">  `parent_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;父级菜单Id&#x27;</span>,</span><br><span class="line">  `hidden` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;隐藏状态：0显示，1隐藏&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态：0启用，1停用&#x27;</span>,</span><br><span class="line">  `sort` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `del_flag` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;删除标记：0未删，其他删除&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;系统菜单表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 系统权限表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_permission`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_permission` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  `menu_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限标识&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限名称&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci COMMENT<span class="operator">=</span><span class="string">&#x27;系统权限表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 权限&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role_permission`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role_permission` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `permission_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统角色权限关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role_user` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统用户角色关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 菜单&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role_menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role_menu` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `menu_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统角色菜单关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始数据</span></span><br><span class="line"><span class="keyword">INSERT</span>  <span class="keyword">INTO</span> `sys_user`(`id`,`username`,`password`,`create_time`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;sysadmin&#x27;</span>,<span class="string">&#x27;$2a$10$Ml/uEJ5BnUSdKspYM4vkneUHM0piXyAVU0aueWya/v7FBauz6XWE6&#x27;</span>,NOW());</span><br><span class="line"><span class="keyword">INSERT</span>  <span class="keyword">INTO</span> `sys_role`(`id`,`role_name`,`role_desc`,`create_time`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;管理员&#x27;</span>,NOW());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu` (`id`, `title`, `name`, `icon`, `parent_id`, `hidden`, `create_time`)</span><br><span class="line"><span class="keyword">VALUES</span>  (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;系统设置&#x27;</span>,<span class="string">&#x27;SysSetting&#x27;</span>,<span class="string">&#x27;el-icon-s-tools&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;菜单管理&#x27;</span>,<span class="string">&#x27;SysMenus&#x27;</span>,<span class="string">&#x27;el-icon-menu&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;角色管理&#x27;</span>,<span class="string">&#x27;SysRoles&#x27;</span>,<span class="string">&#x27;peoples&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;用户管理&#x27;</span>,<span class="string">&#x27;SysUsers&#x27;</span>,<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;系统图标&#x27;</span>,<span class="string">&#x27;SysIcons&#x27;</span>,<span class="string">&#x27;el-icon-picture&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;菜单列表&#x27;</span>,<span class="string">&#x27;SysMenuList&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;菜单编辑&#x27;</span>,<span class="string">&#x27;SysMenuEdit&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;角色列表&#x27;</span>,<span class="string">&#x27;SysRoleList&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;角色编辑&#x27;</span>,<span class="string">&#x27;SysRoleEdit&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;用户列表&#x27;</span>,<span class="string">&#x27;SysUserList&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;用户编辑&#x27;</span>,<span class="string">&#x27;SysUserEdit&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,NOW()),</span><br><span class="line">        (<span class="string">&#x27;12&#x27;</span>,<span class="string">&#x27;其他菜单&#x27;</span>,<span class="string">&#x27;Other&#x27;</span>,<span class="string">&#x27;bug&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;0&#x27;</span>,NOW());</span><br><span class="line"><span class="keyword">INSERT</span>  <span class="keyword">INTO</span> `sys_permission`(`id`,`menu_id`,`name`,`title`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">6</span>,<span class="string">&#x27;sys:menu:edit&#x27;</span>,<span class="string">&#x27;编辑&#x27;</span>),(<span class="number">2</span>,<span class="number">6</span>,<span class="string">&#x27;sys:menu:del&#x27;</span>,<span class="string">&#x27;删除&#x27;</span>),(<span class="number">3</span>,<span class="number">8</span>,<span class="string">&#x27;sys:role:edit&#x27;</span>,<span class="string">&#x27;编辑&#x27;</span>),(<span class="number">4</span>,<span class="number">8</span>,<span class="string">&#x27;sys:role:del&#x27;</span>,<span class="string">&#x27;删除&#x27;</span>),(<span class="number">5</span>,<span class="number">10</span>,<span class="string">&#x27;sys:user:edit&#x27;</span>,<span class="string">&#x27;编辑&#x27;</span>),(<span class="number">6</span>,<span class="number">10</span>,<span class="string">&#x27;sys:user:del&#x27;</span>,<span class="string">&#x27;删除&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_role_user`(`user_id`, `role_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_role_menu`(`role_id`, `menu_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>),(<span class="number">1</span>, <span class="number">2</span>),(<span class="number">1</span>, <span class="number">3</span>),(<span class="number">1</span>, <span class="number">4</span>),(<span class="number">1</span>, <span class="number">5</span>),(<span class="number">1</span>, <span class="number">6</span>),(<span class="number">1</span>, <span class="number">7</span>),(<span class="number">1</span>, <span class="number">8</span>),(<span class="number">1</span>, <span class="number">9</span>),(<span class="number">1</span>, <span class="number">10</span>),(<span class="number">1</span>, <span class="number">11</span>),(<span class="number">1</span>, <span class="number">12</span>);</span><br><span class="line"><span class="keyword">INSERT</span>  <span class="keyword">INTO</span> `sys_role_permission`(`id`,`role_id`,`permission_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">1</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="number">1</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">1</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">1</span>,<span class="number">6</span>);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;实现按钮级别的权限控制，基于上一篇&lt;a href=&quot;https://my.oschina.net/chaoo/blog/5380267&quot;&gt;Spring Secuirty（六）前后端分离菜单权限控制-前端动态路由&lt;/a&gt;的扩展。&lt;br&gt;前端部分还是基于&lt;a href=&quot;https://panjiachen.github.io/vue-element-admin-site/zh/&quot;&gt;vue-element-admin&lt;/a&gt;模板来演示。&lt;/p&gt;
&lt;p&gt;这里实现按钮级别的权限判断的逻辑：每个按钮对应一个&lt;code&gt;权限标识&lt;/code&gt;，后台根据用户角色计算出当前用户可访问的&lt;code&gt;权限标识&lt;/code&gt;列表，前端登录后得到&lt;code&gt;权限标识&lt;/code&gt;列表存入全局，通过单个按钮的&lt;code&gt;权限标识&lt;/code&gt;去匹配列表里的。来实现按钮级别的权限判断。</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
    <category term="Permissions" scheme="http://chaooo.github.io/tags/Permissions/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」前后端分离菜单权限控制-前端动态路由</title>
    <link href="http://chaooo.github.io/2021/12/27/spring-security-vue.html"/>
    <id>http://chaooo.github.io/2021/12/27/spring-security-vue.html</id>
    <published>2021-12-27T09:35:00.000Z</published>
    <updated>2022-04-17T07:51:17.868Z</updated>
    
    <content type="html"><![CDATA[<p>前端部分，这里基于<a href="https://panjiachen.github.io/vue-element-admin-site/zh/">vue-element-admin</a>模板来演示，<br><a href="https://panjiachen.github.io/vue-element-admin-site/zh/">vue-element-admin</a>是一个后台前端解决方案，它基于<a href="https://github.com/vuejs/vue">vue</a>和<a href="https://github.com/ElemeFE/element">element-ui</a>实现。<span id="more"></span></p><h3 id="1-安装-vue-element-admin"><a href="#1-安装-vue-element-admin" class="headerlink" title="1. 安装 vue-element-admin"></a>1. 安装 vue-element-admin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/PanJiaChen/vue-element-admin.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入项目目录</span></span><br><span class="line"><span class="built_in">cd</span> vue-element-admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖， 建议不要用 cnpm 安装 会有各种诡异的bug 可以通过如下操作解决 npm 下载速度慢的问题</span></span><br><span class="line">npm install --registry=https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地开发 启动项目</span></span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure><h3 id="2-改造前端路由挂载方式"><a href="#2-改造前端路由挂载方式" class="headerlink" title="2. 改造前端路由挂载方式"></a>2. 改造前端路由挂载方式</h3><p><a href="https://panjiachen.github.io/vue-element-admin-site/zh/">vue-element-admin</a>中权限的实现方式是：通过获取当前用户的权限去比对路由表，生成当前用户具有的权限可访问的路由表，通过<code>router.addRoutes</code>动态挂载到<code>router</code>上。</p><p>这里改造得更灵活一点，后台根据用户计算出可访问得菜单列表，直接返回用户可访问得菜单列表，前端也需要保存一份全的路由表，用户登录后得到可访问菜单，匹配前端保存的路由表然后动态挂载。</p><p>用户登录成功之后，在全局钩子<code>router.beforeEach</code>中拦截路由，判断是否已获得<code>token</code>，在获得<code>token</code>之后我们就要去获取用户的基本信息及可访问菜单，然后动态挂载路由。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src/permission.js</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="comment">// router.beforeEach</span></span><br><span class="line"><span class="keyword">const</span> hasRoles = store.<span class="property">getters</span>.<span class="property">roles</span> &amp;&amp; store.<span class="property">getters</span>.<span class="property">roles</span>.<span class="property">length</span> &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> (hasRoles) &#123;</span><br><span class="line"><span class="title function_">next</span>()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// get user info</span></span><br><span class="line">  <span class="keyword">const</span> &#123; menus &#125; = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;user/getInfo&#x27;</span>)</span><br><span class="line">  <span class="comment">// generate accessible routes map based on menus</span></span><br><span class="line">  <span class="keyword">const</span> accessRoutes = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;permission/generateRoutes&#x27;</span>, menus)</span><br><span class="line">  <span class="comment">// dynamically add accessible routes</span></span><br><span class="line">  router.<span class="title function_">addRoutes</span>(accessRoutes)</span><br><span class="line">  <span class="comment">// ... other code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-根据接口返回的菜单列表menus动态挂载路由"><a href="#2-1-根据接口返回的菜单列表menus动态挂载路由" class="headerlink" title="2.1 根据接口返回的菜单列表menus动态挂载路由"></a>2.1 根据接口返回的菜单列表<code>menus</code>动态挂载路由</h4><p>接口返回菜单数据：</p><p><img src="/2021/12/27/spring-security-vue/up-44f247866636a16715b39a0ed8941673c89.webp"></p><p>动态挂载路由：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\store\modules\permission.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123; constantRoutes, asyncRoutes, afterRoutes &#125; <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回当前路由名称对应的菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> menus 菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name  路由名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">filterMeun</span>(<span class="params">menus, name</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; menus.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> menu = menus[i]</span><br><span class="line">      <span class="keyword">if</span> (name === menu.<span class="property">name</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> menu</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过后台请求的菜单列表递归过滤路由表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routes asyncRoutes</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> menus  接口返回的菜单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">filterAsyncRoutes</span>(<span class="params">routes, menus</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  routes.<span class="title function_">forEach</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tmp = &#123; ...route &#125;</span><br><span class="line">    <span class="keyword">const</span> meun = <span class="title function_">filterMeun</span>(menus, tmp.<span class="property">name</span>)</span><br><span class="line">    <span class="keyword">if</span> (meun != <span class="literal">null</span> &amp;&amp; meun.<span class="property">title</span>) &#123;</span><br><span class="line">      tmp.<span class="property">hidden</span> = meun.<span class="property">hidden</span> !== <span class="number">0</span></span><br><span class="line">      <span class="comment">// 显示的菜单替换后台设置的标题</span></span><br><span class="line">      <span class="keyword">if</span> (!tmp.<span class="property">hidden</span>) &#123;</span><br><span class="line">        tmp.<span class="property">meta</span>.<span class="property">title</span> = meun.<span class="property">title</span></span><br><span class="line">        tmp.<span class="property">sort</span> = meun.<span class="property">sort</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (meun.<span class="property">icon</span>) &#123;</span><br><span class="line">        tmp.<span class="property">meta</span>.<span class="property">icon</span> = meun.<span class="property">icon</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (tmp.<span class="property">children</span>) &#123;</span><br><span class="line">        tmp.<span class="property">children</span> = <span class="title function_">filterAsyncRoutes</span>(tmp.<span class="property">children</span>, menus)</span><br><span class="line">      &#125;</span><br><span class="line">      res.<span class="title function_">push</span>(tmp)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对菜单进行排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sortRouters</span>(<span class="params">accessedRouters</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; accessedRouters.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> router = accessedRouters[i]</span><br><span class="line">    <span class="keyword">if</span> (router.<span class="property">children</span> &amp;&amp; router.<span class="property">children</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      router.<span class="property">children</span>.<span class="title function_">sort</span>(<span class="title function_">compare</span>(<span class="string">&#x27;sort&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  accessedRouters.<span class="title function_">sort</span>(<span class="title function_">compare</span>(<span class="string">&#x27;sort&#x27;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 升序比较函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">compare</span>(<span class="params">p</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">m, n</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = m[p]</span><br><span class="line">    <span class="keyword">const</span> b = n[p]</span><br><span class="line">    <span class="keyword">return</span> a - b</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">routes</span>: [],</span><br><span class="line">  <span class="attr">addRoutes</span>: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  <span class="attr">SET_ROUTES</span>: <span class="function">(<span class="params">state, routes</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">addRoutes</span> = routes</span><br><span class="line">    state.<span class="property">routes</span> = constantRoutes.<span class="title function_">concat</span>(routes)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  <span class="title function_">generateRoutes</span>(<span class="params">&#123; commit &#125;, menus</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 通过后台请求的菜单列表递归过滤路由表</span></span><br><span class="line">      <span class="keyword">const</span> roleAsyncRoutes = <span class="title function_">filterAsyncRoutes</span>(asyncRoutes, menus)</span><br><span class="line">      <span class="comment">// 对可访问菜单进行排序</span></span><br><span class="line">      <span class="title function_">sortRouters</span>(roleAsyncRoutes)</span><br><span class="line">      <span class="comment">// 拼接尾部公共菜单</span></span><br><span class="line">      <span class="keyword">const</span> accessedRoutes = roleAsyncRoutes.<span class="title function_">concat</span>(afterRoutes)</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROUTES&#x27;</span>, accessedRoutes)</span><br><span class="line">      <span class="title function_">resolve</span>(accessedRoutes)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  state,</span><br><span class="line">  mutations,</span><br><span class="line">  actions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-前端保存的全路径路由表"><a href="#2-2-前端保存的全路径路由表" class="headerlink" title="2.2 前端保存的全路径路由表"></a>2.2 前端保存的全路径路由表</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * src\router\index.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Router</span>)</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;@/layout&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 没有权限要求的基本路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> constantRoutes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/redirect&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/redirect/:path(.*)&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/redirect/index&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/login/index&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/404&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/error-page/404&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/dashboard/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;后台首页&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">affix</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/profile&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;/profile/index&#x27;</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/profile/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Profile&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;个人中心&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">noCache</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态加载的路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/sys&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">      <span class="attr">redirect</span>: <span class="string">&#x27;/sys/menus&#x27;</span>,</span><br><span class="line">      <span class="attr">alwaysShow</span>: <span class="literal">true</span>, <span class="comment">// will always show the root menu</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;SysSetting&#x27;</span>, <span class="comment">// name必须和后台配置一致，不然匹配不到</span></span><br><span class="line">      <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;系统设置&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;el-icon-s-tools&#x27;</span> &#125;,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&#x27;menus&#x27;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/menus/index&#x27;</span>),</span><br><span class="line">          <span class="attr">redirect</span>: <span class="string">&#x27;/sys/menus/list&#x27;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;SysMenus&#x27;</span>,</span><br><span class="line">          <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;菜单管理&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;el-icon-menu&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/menus/list.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysMenuList&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;菜单列表&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;edit&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/menus/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysMenuEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;编辑菜单&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/menus/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysMenuEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;添加菜单&#x27;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&#x27;roles&#x27;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/roles/index&#x27;</span>),</span><br><span class="line">          <span class="attr">redirect</span>: <span class="string">&#x27;/sys/roles/list&#x27;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;SysRoles&#x27;</span>,</span><br><span class="line">          <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;角色管理&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;lock&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/roles/list.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysRoleList&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;角色列表&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;edit&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/roles/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysRoleEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;编辑角色&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/roles/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysRoleEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;添加角色&#x27;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/users/index&#x27;</span>),</span><br><span class="line">          <span class="attr">redirect</span>: <span class="string">&#x27;/sys/users/list&#x27;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;SysUsers&#x27;</span>,</span><br><span class="line">          <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;用户管理&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;user&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/users/list.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysUserList&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;用户列表&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/users/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysUserEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;添加用户&#x27;</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="string">&#x27;edit&#x27;</span>,</span><br><span class="line">              <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/users/form.vue&#x27;</span>),</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;SysUserEdit&#x27;</span>,</span><br><span class="line">              <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;编辑用户&#x27;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&#x27;icons&#x27;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/sys/icons/index&#x27;</span>),</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;SysIcons&#x27;</span>,</span><br><span class="line">          <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;系统图标&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;el-icon-picture&#x27;</span>, <span class="attr">noCache</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="comment">/** when your routing map is too long, you can split it into small modules **/</span></span><br><span class="line">  <span class="comment">// componentsRouter,</span></span><br><span class="line">  <span class="comment">// chartsRouter,</span></span><br><span class="line">  <span class="comment">// nestedRouter,</span></span><br><span class="line">  <span class="comment">// tableRouter,</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 没有权限要求的底部基本路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> afterRoutes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;external-link&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;https://www.test.com/&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;友情链接&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;link&#x27;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 404 page must be placed at the end !!!</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span>, <span class="attr">redirect</span>: <span class="string">&#x27;/404&#x27;</span>, <span class="attr">hidden</span>: <span class="literal">true</span> &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createRouter</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;</span><br><span class="line">    <span class="comment">// mode: &#x27;history&#x27;, // require service support</span></span><br><span class="line">    <span class="attr">scrollBehavior</span>: <span class="function">() =&gt;</span> (&#123; <span class="attr">y</span>: <span class="number">0</span> &#125;),</span><br><span class="line">    <span class="attr">routes</span>: constantRoutes</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resetRouter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> newRouter = <span class="title function_">createRouter</span>()</span><br><span class="line">  router.<span class="property">matcher</span> = newRouter.<span class="property">matcher</span> <span class="comment">// reset router</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure><blockquote><p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,<br>这里我将本文的前后端分离后台菜单权限控制放在github源码tag的V4.0中，防止后续修改后代码对不上。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;前端部分，这里基于&lt;a href=&quot;https://panjiachen.github.io/vue-element-admin-site/zh/&quot;&gt;vue-element-admin&lt;/a&gt;模板来演示，&lt;br&gt;&lt;a href=&quot;https://panjiachen.github.io/vue-element-admin-site/zh/&quot;&gt;vue-element-admin&lt;/a&gt;是一个后台前端解决方案，它基于&lt;a href=&quot;https://github.com/vuejs/vue&quot;&gt;vue&lt;/a&gt;和&lt;a href=&quot;https://github.com/ElemeFE/element&quot;&gt;element-ui&lt;/a&gt;实现。</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
    <category term="Vue" scheme="http://chaooo.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」前后端分离后台菜单权限控制</title>
    <link href="http://chaooo.github.io/2021/12/13/spring-security-rbac.html"/>
    <id>http://chaooo.github.io/2021/12/13/spring-security-rbac.html</id>
    <published>2021-12-13T06:35:00.000Z</published>
    <updated>2022-04-17T07:51:23.462Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-RBAC权限控制模型"><a href="#1-RBAC权限控制模型" class="headerlink" title="1. RBAC权限控制模型"></a>1. RBAC权限控制模型</h3><p>RBAC（Role-based access control）是一种以角色为基础的访问控制（Role-based access control，RBAC），它是一种较新且广为使用的权限控制机制，这种机制不是直接给用户赋予权限，而是将权限赋予角色。</p><p>RBAC 权限模型将用户按角色进行归类，通过用户的角色来确定用户对某项资源是否具备操作权限。RBAC 简化了用户与权限的管理，它将用户与角色关联、角色与权限关联、权限与资源关联，这种模式使得用户的授权管理变得非常简单和易于维护。<span id="more"></span></p><h3 id="2-数据库设计"><a href="#2-数据库设计" class="headerlink" title="2. 数据库设计"></a>2. 数据库设计</h3><p><img src="/2021/12/13/spring-security-rbac/up-fbcbfd800689ec7a2a799e6db4b0bbb84e6.webp"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_user` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `username` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 角色表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `role_name` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色名称&#x27;</span>,</span><br><span class="line">  `role_desc` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;角色表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 菜单表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_menu` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  `menu_name` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单名称&#x27;</span>,</span><br><span class="line">  `menu_path` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单路径&#x27;</span>,</span><br><span class="line">  `menu_type` <span class="type">char</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单类型(1:一级菜单，2:子菜单，3:按钮)&#x27;</span>,</span><br><span class="line">  `menu_parent_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;父级菜单Id&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;菜单表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role_user` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统用户角色关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 菜单&amp;角色 关联表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_role_menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_role_menu` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `role_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">  `menu_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>UTF8MB4 COMMENT<span class="operator">=</span><span class="string">&#x27;系统角色菜单关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始数据：</span></span><br><span class="line"><span class="comment">-- 管理员拥有所有菜单权限</span></span><br><span class="line"><span class="comment">-- 普通用户拥有查看权限</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_role`(`id`, `role_name`, `role_desc`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;管理员&#x27;</span>),(<span class="number">2</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;普通用户&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu`(`id`, `menu_name`,`menu_path`,`menu_type`,`menu_parent_id`)</span><br><span class="line">    <span class="keyword">VALUES</span>  (<span class="number">1</span>, <span class="string">&#x27;用户管理&#x27;</span>, <span class="string">&#x27;/user&#x27;</span>, <span class="number">1</span>, <span class="keyword">null</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">&#x27;用户列表&#x27;</span>, <span class="string">&#x27;/user/list&#x27;</span>, <span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">            (<span class="number">3</span>, <span class="string">&#x27;新增用户&#x27;</span>, <span class="string">&#x27;/user/add&#x27;</span>, <span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">            (<span class="number">4</span>, <span class="string">&#x27;修改用户&#x27;</span>, <span class="string">&#x27;/user/update&#x27;</span>, <span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">            (<span class="number">5</span>, <span class="string">&#x27;删除用户&#x27;</span>, <span class="string">&#x27;/user/delete&#x27;</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_role_user`(`user_id`, `role_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_role_menu`(`role_id`, `menu_id`)</span><br><span class="line">    <span class="keyword">VALUES</span>  (<span class="number">1</span>, <span class="number">1</span>),(<span class="number">1</span>, <span class="number">2</span>),(<span class="number">1</span>, <span class="number">3</span>),(<span class="number">1</span>, <span class="number">4</span>),(<span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><h3 id="3-代码进化"><a href="#3-代码进化" class="headerlink" title="3. 代码进化"></a>3. 代码进化</h3><ol><li>修改注册逻辑，注册时添加用户权限</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResponseJson&lt;SysUser&gt; <span class="title function_">register</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(sysUser.getUsername()) &amp;&amp; StringUtils.hasLength(sysUser.getPassword())) &#123;</span><br><span class="line">        <span class="comment">// 密码加密</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encodePassword</span> <span class="operator">=</span> passwordEncoder.encode(sysUser.getPassword());</span><br><span class="line">        sysUser.setPassword(encodePassword);</span><br><span class="line">        <span class="comment">// 新增用户</span></span><br><span class="line">        sysUserDao.insertSysUser(sysUser);</span><br><span class="line">        <span class="comment">// 角色Ids，用&quot;,&quot;隔开</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">roleIds</span> <span class="operator">=</span> sysUser.getRoleIds();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(roleIds)) &#123;</span><br><span class="line">            <span class="comment">// 设置用户角色</span></span><br><span class="line">            String[] split = roleIds.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String s : split) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasLength(s)) &#123;</span><br><span class="line">                    <span class="comment">// 保存用户角色关系</span></span><br><span class="line">                    sysUserDao.insertUserRoleRelation(sysUser.getId(), Long.valueOf(s));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseJson.success(<span class="string">&quot;注册成功&quot;</span>, sysUser);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ResponseJson.error(<span class="string">&quot;用户名或密码不能为空&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>封装JWT服务工具类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisService redisService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> roleList 角色列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(String username, List&lt;String&gt; roleList)</span> &#123;</span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="comment">// 设置签发时间</span></span><br><span class="line">        calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="comment">// 设置过期时间</span></span><br><span class="line">        calendar.add(Calendar.MINUTE, ConstantKey.TOKEN_EXPIRE);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setSubject(username + <span class="string">&quot;-&quot;</span> + roleList)</span><br><span class="line">                <span class="comment">// 签发时间</span></span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                <span class="comment">// 过期时间</span></span><br><span class="line">                .setExpiration(time)</span><br><span class="line">                <span class="comment">// 自定义算法与签名：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="comment">// 将token存入redis,并设置超时时间为token过期时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expire</span> <span class="operator">=</span> time.getTime() - now.getTime();</span><br><span class="line">        redisService.set(token, token, expire);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parseToken</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userinfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(ConstantKey.TOKEN_NAME);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cacheToken</span> <span class="operator">=</span> String.valueOf(redisService.get(token));</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(cacheToken) &amp;&amp; !<span class="string">&quot;null&quot;</span>.equals(cacheToken)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                            <span class="comment">// 设置生成token的签名key</span></span><br><span class="line">                            .setSigningKey(ConstantKey.SIGNING_KEY)</span><br><span class="line">                            <span class="comment">// 解析token</span></span><br><span class="line">                            .parseClaimsJws(cacheToken).getBody();</span><br><span class="line">                    <span class="comment">// 取出用户信息</span></span><br><span class="line">                    userinfo = claims.getSubject();</span><br><span class="line">                    <span class="comment">// 重设Redis超时时间</span></span><br><span class="line">                    resetRedisExpire(token, claims);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;Token过期续签，ExpiredJwtException=&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> e.getClaims();</span><br><span class="line">                    <span class="comment">// 取出用户信息</span></span><br><span class="line">                    userinfo = claims.getSubject();</span><br><span class="line">                    <span class="comment">// 刷新Token</span></span><br><span class="line">                    refreshToken(token, claims);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedJwtException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，UnsupportedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (MalformedJwtException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，MalformedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SignatureException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，SignatureException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，IllegalArgumentException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userinfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析Token,取出用户名（Token过期仍取出用户名）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(ConstantKey.TOKEN_NAME);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userinfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                        <span class="comment">// 设置生成token的签名key</span></span><br><span class="line">                        .setSigningKey(ConstantKey.SIGNING_KEY)</span><br><span class="line">                        <span class="comment">// 解析token</span></span><br><span class="line">                        .parseClaimsJws(token).getBody();</span><br><span class="line">                <span class="comment">// 取出用户信息</span></span><br><span class="line">                userinfo = claims.getSubject();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> e.getClaims();</span><br><span class="line">                <span class="comment">// 取出用户信息</span></span><br><span class="line">                userinfo = claims.getSubject();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored)&#123;&#125;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(userinfo))&#123;</span><br><span class="line">                username = userinfo.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重设Redis超时时间</span></span><br><span class="line"><span class="comment">     * 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetRedisExpire</span><span class="params">(String token, Claims claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// token签发时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">issuedAt</span> <span class="operator">=</span> claims.getIssuedAt().getTime();</span><br><span class="line">        <span class="comment">// token过期时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expiration</span> <span class="operator">=</span> claims.getExpiration().getTime();</span><br><span class="line">        <span class="comment">// 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expireAt</span> <span class="operator">=</span> current + (expiration - issuedAt);</span><br><span class="line">        <span class="comment">// 重设Redis超时时间</span></span><br><span class="line">        redisService.expire(token, expireAt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 刷新Token</span></span><br><span class="line"><span class="comment">     * 刷新Token的时机： 当cacheToken已过期 并且Redis在有效期内</span></span><br><span class="line"><span class="comment">     * 重新生成Token并覆盖Redis的v值(这时候k、v值不一样了)，然后设置Redis过期时间为：新Token过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(String token, Claims claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 重新生成token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="comment">// 设置签发时间</span></span><br><span class="line">        calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="comment">// 设置过期时间: TOKEN_EXPIRE分钟</span></span><br><span class="line">        calendar.add(Calendar.MINUTE, ConstantKey.TOKEN_EXPIRE);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setSubject(claims.getSubject())</span><br><span class="line">                <span class="comment">// 签发时间</span></span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                <span class="comment">// 过期时间</span></span><br><span class="line">                .setExpiration(time)</span><br><span class="line">                <span class="comment">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="comment">// 将refreshToken覆盖Redis的v值,并设置超时时间为refreshToken过期时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expire</span> <span class="operator">=</span> time.getTime() - now.getTime();</span><br><span class="line">        redisService.set(token, token, expire);</span><br><span class="line">        <span class="comment">// 打印日志</span></span><br><span class="line">        log.info(<span class="string">&quot;刷新token执行时间: &#123;&#125;&quot;</span>, (System.currentTimeMillis() - current) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>编写获取用户可访问菜单接口（用户登录后，携带Token去获取用户角色，根据角色计算出用户可访问菜单）</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/menu&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseJson&lt;List&lt;SysMenu&gt;&gt; <span class="title function_">menuList</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> jwtService.getUsername(request);</span><br><span class="line">    <span class="keyword">return</span> sysUserService.menuList(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResponseJson&lt;List&lt;SysMenu&gt;&gt; <span class="title function_">menuList</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(username)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseJson.error(<span class="string">&quot;用户信息异常&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取用户角色Id</span></span><br><span class="line">    List&lt;Long&gt; roleIds = sysUserDao.getRoleIdsByUserId(username);</span><br><span class="line">    List&lt;SysMenu&gt; menus = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(roleIds)) &#123;</span><br><span class="line">        <span class="comment">// 根据角色Id获取菜单列表</span></span><br><span class="line">        menus = sysUserDao.getMenuListByRoleIds(roleIds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ResponseJson.success(menus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRoleIdsByUserId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    SELECT DISTINCT ru.role_id FROM sys_role_user ru</span><br><span class="line">    LEFT JOIN sys_user u ON ru.user_id = u.id</span><br><span class="line">    WHERE u.username=#&#123;username&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getMenuListByRoleIds&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.jwt.entity.SysMenu&quot;</span>&gt;</span></span><br><span class="line">    SELECT m.id, m.menu_name AS menuName, m.menu_path AS menuPath, m.menu_type AS menuType, m.menu_parent_id AS parentId</span><br><span class="line">    FROM sys_menu m</span><br><span class="line">             LEFT JOIN sys_role_menu rm ON m.id = rm.menu_id</span><br><span class="line">    WHERE rm.role_id IN</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">&quot;roleId&quot;</span> <span class="attr">collection</span>=<span class="string">&quot;roleIds&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">        #&#123;roleId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h3><ol><li>普通用户可访问菜单：</li></ol><p><img src="/2021/12/13/spring-security-rbac/up-2368413a1b85f66e78676578c3592e42076.webp"></p><ol start="2"><li>管理员可访问菜单：</li></ol><p><img src="/2021/12/13/spring-security-rbac/up-f0af2cb0f3d7a9221a95ddb78fd9f01cfd9.webp"></p><blockquote><p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,<br>这里我将本文的前后端分离后台菜单权限控制放在github源码tag的V3.0中，防止后续修改后代码对不上。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;1-RBAC权限控制模型&quot;&gt;&lt;a href=&quot;#1-RBAC权限控制模型&quot; class=&quot;headerlink&quot; title=&quot;1. RBAC权限控制模型&quot;&gt;&lt;/a&gt;1. RBAC权限控制模型&lt;/h3&gt;&lt;p&gt;RBAC（Role-based access control）是一种以角色为基础的访问控制（Role-based access control，RBAC），它是一种较新且广为使用的权限控制机制，这种机制不是直接给用户赋予权限，而是将权限赋予角色。&lt;/p&gt;
&lt;p&gt;RBAC 权限模型将用户按角色进行归类，通过用户的角色来确定用户对某项资源是否具备操作权限。RBAC 简化了用户与权限的管理，它将用户与角色关联、角色与权限关联、权限与资源关联，这种模式使得用户的授权管理变得非常简单和易于维护。</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
    <category term="RBAC" scheme="http://chaooo.github.io/tags/RBAC/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」基于Redis的Token自动续签优化</title>
    <link href="http://chaooo.github.io/2021/12/10/spring-security-token.html"/>
    <id>http://chaooo.github.io/2021/12/10/spring-security-token.html</id>
    <published>2021-12-10T03:35:00.000Z</published>
    <updated>2022-04-17T07:51:39.442Z</updated>
    
    <content type="html"><![CDATA[<p>本文基于上一篇文章：《Spring Security（三）整合 JWT 实现无状态登录示例》。</p><p>在 <code>SpringSecurity</code> 整合 <code>JWT</code> 实现无状态登录示例中，我们在 <code>JwtAuthenticationFilter</code> (自定义<code>JWT</code>认证过滤器) 解析 <code>Token</code> 成功后，提供了续签逻辑：<span id="more"></span></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷新Token的时机：</span></span><br><span class="line"><span class="comment"> * 1. 当前时间 &lt; token过期时间</span></span><br><span class="line"><span class="comment"> * 2. 当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(HttpServletResponse response, Claims claims)</span> &#123;</span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// token签发时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">issuedAt</span> <span class="operator">=</span> claims.getIssuedAt().getTime();</span><br><span class="line">    <span class="comment">// token过期时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">expiration</span> <span class="operator">=</span> claims.getExpiration().getTime();</span><br><span class="line">    <span class="comment">// (当前时间 &lt; token过期时间) &amp;&amp; (当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2))</span></span><br><span class="line">    <span class="keyword">if</span> ((current &lt; expiration) &amp;&amp; (current &gt; (issuedAt + ((expiration - issuedAt) / <span class="number">2</span>)))) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 重新生成token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="comment">// 设置签发时间</span></span><br><span class="line">        calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="comment">// 设置过期时间: 5分钟</span></span><br><span class="line">        calendar.add(Calendar.MINUTE, <span class="number">5</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setSubject(claims.getSubject())</span><br><span class="line">                <span class="comment">// 签发时间</span></span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                <span class="comment">// 过期时间</span></span><br><span class="line">                .setExpiration(time)</span><br><span class="line">                <span class="comment">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="comment">// 主动刷新token，并返回给前端</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;refreshToken&quot;</span>, refreshToken);</span><br><span class="line">        log.info(<span class="string">&quot;刷新token执行时间: &#123;&#125;&quot;</span>, (System.currentTimeMillis() - current) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的逻辑是：<code>Token</code> 未过期并且当前时间已经超过 <code>Token</code> 有效时间的一半，重新生成一个 <code>refreshToken</code>，并返回给前端，前端需要用 <code>refreshToken</code> 替换之前旧的 <code>Token</code>。</p><h3 id="Token续签优化方案"><a href="#Token续签优化方案" class="headerlink" title="Token续签优化方案"></a>Token续签优化方案</h3><p>预期效果：前端不需要手动替换 <code>Token</code>，每次用 <code>Token</code> 请求资源时自动续期。</p><p>实现方案：引入 <code>Redis</code>，实现逻辑：</p><ol><li>登录成功后将 <code>Token</code> 存储到 <code>Redis</code> 里面(k,v都为 <code>Token</code> 的值)，并设置 <code>Redis</code> 过期时间为： <code>Token</code> 过期时间。</li><li>用户发起请求时，每次都根据k为<code>Token</code>的键去换取 <code>Redis</code> 的值，这里命名为 <code>cacheToken</code>：<ul><li>当 <code>cacheToken</code> 在有效期内，重设 <code>Redis</code> 过期时间为：当前时间 + (<code>cacheToken</code>过期时间 - <code>cacheToken</code>签发时间)。</li><li>当 <code>cacheToken</code> 已过期（<code>Redis</code> 在有效期内），则 <code>JWT</code> 重新生成 <code>Token</code> 并覆盖v值(这时候k、v值不一样了)，然后设置 <code>Redis</code> 过期时间为： <code>cacheToken</code> 过期时间。</li><li>若 <code>Redis</code> 也过期，取不到 <code>cacheToken</code>，则拒绝访问或返回错误信息，需要重新登录。</li></ul></li></ol><h4 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h4><h5 id="1-在-pom-xml-中引入-Redis-依赖："><a href="#1-在-pom-xml-中引入-Redis-依赖：" class="headerlink" title="1. 在 pom.xml 中引入 Redis 依赖："></a>1. 在 <code>pom.xml</code> 中引入 <code>Redis</code> 依赖：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="2-在-application-yml-配置文件中配置-Redis："><a href="#2-在-application-yml-配置文件中配置-Redis：" class="headerlink" title="2. 在 application.yml 配置文件中配置 Redis："></a>2. 在 <code>application.yml</code> 配置文件中配置 <code>Redis</code>：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: 127.0.0.1</span><br><span class="line">    port: 6379</span><br><span class="line">    password: 123456</span><br><span class="line">    # Redis数据库索引（默认为0）</span><br><span class="line">    database: 0</span><br><span class="line">    # 连接超时时间（毫秒）</span><br><span class="line">    timeout: 5000</span><br></pre></td></tr></table></figure><h5 id="3-简单的-RedisService-封装"><a href="#3-简单的-RedisService-封装" class="headerlink" title="3. 简单的 RedisService 封装"></a>3. 简单的 <code>RedisService</code> 封装</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Serializable, Object&gt; redisTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        ValueOperations&lt;Serializable, Object&gt; operations = redisTemplate.opsForValue();</span><br><span class="line">        <span class="keyword">return</span> operations.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断缓存中是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.hasLength(key) &amp;&amp; Boolean.TRUE.equals(redisTemplate.hasKey(key));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (exists(key)) &#123;</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ValueOperations&lt;Serializable, Object&gt; operations = redisTemplate.opsForValue();</span><br><span class="line">            operations.set(key, value);</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入缓存 并 加上过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value, Date date)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ValueOperations&lt;Serializable, Object&gt; operations = redisTemplate.opsForValue();</span><br><span class="line">            operations.set(key, value);</span><br><span class="line">            redisTemplate.expireAt(key, date);</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入过期时间（毫秒）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(String key, Long expireTimeMillis)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.expire(key, expireTimeMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-修改JWT登录过滤器-JwtLoginFilter，构造方法中加入-RedisService，并生成-Token-后存入-Redis"><a href="#4-修改JWT登录过滤器-JwtLoginFilter，构造方法中加入-RedisService，并生成-Token-后存入-Redis" class="headerlink" title="4. 修改JWT登录过滤器 JwtLoginFilter，构造方法中加入 RedisService，并生成 Token 后存入 Redis:"></a>4. 修改JWT登录过滤器 <code>JwtLoginFilter</code>，构造方法中加入 <code>RedisService</code>，并生成 <code>Token</code> 后存入 <code>Redis</code>:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisService redisService;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtLoginFilter</span><span class="params">(AuthenticationManager authenticationManager, RedisService redisService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.redisService = redisService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试身份认证(接收并解析用户凭证)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> authenticationManager.authenticate(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证成功(用户成功登录后，这个方法会被调用，我们在这个方法里生成token)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = auth.getAuthorities();</span><br><span class="line">            <span class="comment">// 定义存放角色集合的对象</span></span><br><span class="line">            List&lt;String&gt; roleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority grantedAuthority : authorities) &#123;</span><br><span class="line">                roleList.add(grantedAuthority.getAuthority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 生成token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            <span class="comment">// 设置签发时间</span></span><br><span class="line">            calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="comment">// 设置过期时间: 5分钟</span></span><br><span class="line">            calendar.add(Calendar.MINUTE, <span class="number">5</span>);</span><br><span class="line">            <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                    .setSubject(auth.getName() + <span class="string">&quot;-&quot;</span> + roleList)</span><br><span class="line">                    <span class="comment">// 签发时间</span></span><br><span class="line">                    .setIssuedAt(now)</span><br><span class="line">                    <span class="comment">// 过期时间</span></span><br><span class="line">                    .setExpiration(time)</span><br><span class="line">                    <span class="comment">// 自定义算法与签名：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                    .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                    .compact();</span><br><span class="line">            <span class="comment">// 将token存入redis,并设置超时时间为token过期时间</span></span><br><span class="line">            redisService.set(token, token, time);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 返回token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            log.info(<span class="string">&quot;用户登录成功，生成token=&#123;&#125;&quot;</span>, token);</span><br><span class="line">            <span class="comment">// 登录成功后，返回token到header里面</span></span><br><span class="line">            response.addHeader(<span class="string">&quot;Authorization&quot;</span>, token);</span><br><span class="line">            <span class="comment">// 登录成功后，返回token到body里面</span></span><br><span class="line">            ResponseJson&lt;String&gt; result = ResponseJson.success(<span class="string">&quot;登录成功&quot;</span>, token);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;IOException:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证失败调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;登录失败[&#123;&#125;]，AuthenticationException=&#123;&#125;&quot;</span>, request.getRequestURI(), exception.getMessage());</span><br><span class="line">        <span class="comment">// 登录失败，返回错误信息</span></span><br><span class="line">        ResponseJson&lt;Void&gt; result = ResponseJson.error(exception.getMessage(), <span class="literal">null</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-修改JWT认证过滤器-JwtAuthenticationFilter，构造方法中加入-RedisService，并添加-Token-续签逻辑"><a href="#5-修改JWT认证过滤器-JwtAuthenticationFilter，构造方法中加入-RedisService，并添加-Token-续签逻辑" class="headerlink" title="5. 修改JWT认证过滤器 JwtAuthenticationFilter，构造方法中加入 RedisService，并添加 Token 续签逻辑:"></a>5. 修改JWT认证过滤器 <code>JwtAuthenticationFilter</code>，构造方法中加入 <code>RedisService</code>，并添加 <code>Token</code> 续签逻辑:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">BasicAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisService redisService;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(AuthenticationManager authenticationManager, RedisService redisService)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(authenticationManager);</span><br><span class="line">        <span class="built_in">this</span>.redisService = redisService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> getAuthentication(request, response);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UsernamePasswordAuthenticationToken <span class="title function_">getAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 解析token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cacheToken</span> <span class="operator">=</span> String.valueOf(redisService.get(token));</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(token) &amp;&amp; !<span class="string">&quot;null&quot;</span>.equals(cacheToken)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                            <span class="comment">// 设置生成token的签名key</span></span><br><span class="line">                            .setSigningKey(ConstantKey.SIGNING_KEY)</span><br><span class="line">                            <span class="comment">// 解析token</span></span><br><span class="line">                            .parseClaimsJws(cacheToken).getBody();</span><br><span class="line">                    <span class="comment">// 取出用户信息</span></span><br><span class="line">                    user = claims.getSubject();</span><br><span class="line">                    <span class="comment">// 重设Redis超时时间</span></span><br><span class="line">                    resetRedisExpire(token, claims);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;Token过期续签，ExpiredJwtException=&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> e.getClaims();</span><br><span class="line">                    <span class="comment">// 取出用户信息</span></span><br><span class="line">                    user = claims.getSubject();</span><br><span class="line">                    <span class="comment">// 刷新Token</span></span><br><span class="line">                    refreshToken(token, claims);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedJwtException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，UnsupportedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (MalformedJwtException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，MalformedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SignatureException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，SignatureException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，IllegalArgumentException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获取用户权限和角色</span></span><br><span class="line">                    String[] split = user.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    ArrayList&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (String s : split) &#123;</span><br><span class="line">                        authorities.add(<span class="keyword">new</span> <span class="title class_">GrantedAuthorityImpl</span>(s));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 返回Authentication</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, authorities);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，需要身份认证&quot;</span>, request.getRequestURI());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重设Redis超时时间</span></span><br><span class="line"><span class="comment">     * 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetRedisExpire</span><span class="params">(String token, Claims claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// token签发时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">issuedAt</span> <span class="operator">=</span> claims.getIssuedAt().getTime();</span><br><span class="line">        <span class="comment">// token过期时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expiration</span> <span class="operator">=</span> claims.getExpiration().getTime();</span><br><span class="line">        <span class="comment">// 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expireAt</span> <span class="operator">=</span> current + (expiration - issuedAt);</span><br><span class="line">        <span class="comment">// 重设Redis超时时间</span></span><br><span class="line">        redisService.expire(token, expireAt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 刷新Token</span></span><br><span class="line"><span class="comment">     * 刷新Token的时机： 当cacheToken已过期 并且Redis在有效期内</span></span><br><span class="line"><span class="comment">     * 重新生成Token并覆盖Redis的v值(这时候k、v值不一样了)，然后设置Redis过期时间为：新Token过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(String token, Claims claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 重新生成token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="comment">// 设置签发时间</span></span><br><span class="line">        calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="comment">// 设置过期时间: 5分钟</span></span><br><span class="line">        calendar.add(Calendar.MINUTE, <span class="number">5</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setSubject(claims.getSubject())</span><br><span class="line">                <span class="comment">// 签发时间</span></span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                <span class="comment">// 过期时间</span></span><br><span class="line">                .setExpiration(time)</span><br><span class="line">                <span class="comment">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="comment">// 将refreshToken覆盖Redis的v值,并设置超时时间为refreshToken过期时间</span></span><br><span class="line">        redisService.set(token, refreshToken, time);</span><br><span class="line">        <span class="comment">// 打印日志</span></span><br><span class="line">        log.info(<span class="string">&quot;刷新token执行时间: &#123;&#125;&quot;</span>, (System.currentTimeMillis() - current) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6-修改-SpringSecurity-配置类，注入-RedisService："><a href="#6-修改-SpringSecurity-配置类，注入-RedisService：" class="headerlink" title="6. 修改 SpringSecurity 配置类，注入 RedisService："></a>6. 修改 <code>SpringSecurity</code> 配置类，注入 <code>RedisService</code>：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisService redisService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全局请求忽略规则配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> &#123;</span><br><span class="line">        <span class="comment">// 需要放行的URL</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义认证策略：登录的时候会进入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> &#123;</span><br><span class="line">        <span class="comment">// 2. 通过实现 AuthenticationProvider 自定义身份认证验证组件</span></span><br><span class="line">        auth.authenticationProvider(<span class="keyword">new</span> <span class="title class_">AuthenticationProviderImpl</span>(userDetailsService, bCryptPasswordEncoder));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义 HTTP 验证规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// 关闭Session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            <span class="comment">// 所有请求需要身份认证</span></span><br><span class="line">            .and().authorizeRequests().anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// 自定义JWT登录过滤器</span></span><br><span class="line">            .addFilter(<span class="keyword">new</span> <span class="title class_">JwtLoginFilter</span>(authenticationManager(), redisService))</span><br><span class="line">            <span class="comment">// 自定义JWT认证过滤器</span></span><br><span class="line">            .addFilter(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(authenticationManager(), redisService))</span><br><span class="line">            <span class="comment">// 自定义认证拦截器，也可以直接使用内置实现类Http403ForbiddenEntryPoint</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">AuthenticationEntryPointImpl</span>())</span><br><span class="line">            <span class="comment">// 允许跨域</span></span><br><span class="line">            .and().cors()</span><br><span class="line">            <span class="comment">// 禁用跨站伪造</span></span><br><span class="line">            .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,<br>这里我将本文的基于Redis的Token自动续签优化放在github源码tag的V2.0中，防止后续修改后代码对不上。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文基于上一篇文章：《Spring Security（三）整合 JWT 实现无状态登录示例》。&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;SpringSecurity&lt;/code&gt; 整合 &lt;code&gt;JWT&lt;/code&gt; 实现无状态登录示例中，我们在 &lt;code&gt;JwtAuthenticationFilter&lt;/code&gt; (自定义&lt;code&gt;JWT&lt;/code&gt;认证过滤器) 解析 &lt;code&gt;Token&lt;/code&gt; 成功后，提供了续签逻辑：</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
    <category term="Token" scheme="http://chaooo.github.io/tags/Token/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」整合 JWT 实现无状态登录示例</title>
    <link href="http://chaooo.github.io/2021/12/09/spring-security-jwt.html"/>
    <id>http://chaooo.github.io/2021/12/09/spring-security-jwt.html</id>
    <published>2021-12-09T08:35:00.000Z</published>
    <updated>2022-04-17T07:53:38.627Z</updated>
    
    <content type="html"><![CDATA[<p>JSON Web Token（缩写 JWT）基于JSON格式信息一种Token令牌，是目前最流行的跨域认证解决方案。</p><span id="more"></span><ul><li>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户。</li><li>此后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名。</li><li>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</li></ul><h3 id="1-依赖与配置文件"><a href="#1-依赖与配置文件" class="headerlink" title="1. 依赖与配置文件"></a>1. 依赖与配置文件</h3><ol><li>在 <code>pom.xml</code> 中引入依赖：</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.78<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>用户信息从数据库中获取，在 <code>application.yml</code> 配置文件中配置：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql://192.168.2.100:3306/security?characterEncoding=UTF8&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">    username: developer</span><br><span class="line">    password: 05bZ/OxTB:X+yd%1</span><br><span class="line"></span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br></pre></td></tr></table></figure><h3 id="2-自定义Security策略"><a href="#2-自定义Security策略" class="headerlink" title="2. 自定义Security策略"></a>2. 自定义Security策略</h3><h4 id="2-1-通过继承-WebSecurityConfigurerAdapter-实现自定义Security策略"><a href="#2-1-通过继承-WebSecurityConfigurerAdapter-实现自定义Security策略" class="headerlink" title="2.1 通过继承 WebSecurityConfigurerAdapter 实现自定义Security策略"></a>2.1 通过继承 WebSecurityConfigurerAdapter 实现自定义Security策略</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 通过继承 WebSecurityConfigurerAdapter 实现自定义Security策略</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Configuration</span>：声明当前类是一个配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@EnableWebSecurity</span>：开启WebSecurity模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@EnableGlobalMethodSecurity</span>(securedEnabled=true)：开启注解，支持方法级别的权限控制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全局请求忽略规则配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> &#123;</span><br><span class="line">        <span class="comment">// 需要放行的URL</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义认证策略：登录的时候会进入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> &#123;</span><br><span class="line">        <span class="comment">// 2.通过实现 AuthenticationProvider 自定义身份认证验证组件</span></span><br><span class="line">        auth.authenticationProvider(<span class="keyword">new</span> <span class="title class_">AuthenticationProviderImpl</span>(userDetailsService, bCryptPasswordEncoder));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HTTP 验证规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// 关闭Session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            <span class="comment">// 所有请求需要身份认证</span></span><br><span class="line">            .and().authorizeRequests().anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// 3.自定义JWT登录过滤器</span></span><br><span class="line">            .addFilter(<span class="keyword">new</span> <span class="title class_">JwtLoginFilter</span>(authenticationManager()))</span><br><span class="line">            <span class="comment">// 4.自定义JWT认证过滤器</span></span><br><span class="line">            .addFilter(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(authenticationManager()))</span><br><span class="line">            <span class="comment">// 5.自定义认证拦截器，也可以直接使用内置实现类Http403ForbiddenEntryPoint</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">AuthenticationEntryPointImpl</span>())</span><br><span class="line">            <span class="comment">// 允许跨域</span></span><br><span class="line">            .and().cors()</span><br><span class="line">            <span class="comment">// 禁用跨站伪造</span></span><br><span class="line">            .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BCryptPasswordEncoder</code> 解析器注入到容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">bCryptPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <code>UserDetailsService</code> 接口，自定义逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysUserDao sysUserDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 数据库中查找用户</span></span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">user</span> <span class="operator">=</span> sysUserDao.findByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户&quot;</span> + username + <span class="string">&quot;不存在!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(user.getUsername(), user.getPassword(), emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-通过实现-AuthenticationProvider-自定义身份认证验证组件"><a href="#2-2-通过实现-AuthenticationProvider-自定义身份认证验证组件" class="headerlink" title="2.2 通过实现 AuthenticationProvider 自定义身份认证验证组件"></a>2.2 通过实现 AuthenticationProvider 自定义身份认证验证组件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthenticationProviderImpl</span><span class="params">(UserDetailsService userDetailsService, BCryptPasswordEncoder bCryptPasswordEncoder)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.bCryptPasswordEncoder = bCryptPasswordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来验证用户身份 （对传递的Authentication对象的身份验证）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication 传递的Authentication对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 包含凭证的经过完全认证的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException 份验证失败异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 获取认证的用户名 &amp; 密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">        <span class="comment">// 认证逻辑</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(name);</span><br><span class="line">        <span class="keyword">if</span> (bCryptPasswordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;用户登录成功，username=&#123;&#125;&quot;</span>, name);</span><br><span class="line">            <span class="comment">// 这里设置权限和角色</span></span><br><span class="line">            ArrayList&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            authorities.add( <span class="keyword">new</span> <span class="title class_">GrantedAuthorityImpl</span>(<span class="string">&quot;ROLE_ADMIN&quot;</span>));</span><br><span class="line">            authorities.add( <span class="keyword">new</span> <span class="title class_">GrantedAuthorityImpl</span>(<span class="string">&quot;AUTH_WRITE&quot;</span>));</span><br><span class="line">            <span class="comment">// 生成令牌 这里令牌里面存入了:name,password,authorities, 当然你也可以放其他内容</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(name, password, authorities);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前的AuthenticationProvider 是否支持对应的Authentication对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication Authentication对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> authentication.equals(UsernamePasswordAuthenticationToken.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <code>GrantedAuthority</code> 存储权限和角色</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 权限类型，负责存储权限和角色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrantedAuthorityImpl</span> <span class="keyword">implements</span> <span class="title class_">GrantedAuthority</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String authority;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GrantedAuthorityImpl</span><span class="params">(String authority)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authority = authority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthority</span><span class="params">(String authority)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authority = authority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAuthority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-自定义JWT登录过滤器，继承-UsernamePasswordAuthenticationFilter"><a href="#2-3-自定义JWT登录过滤器，继承-UsernamePasswordAuthenticationFilter" class="headerlink" title="2.3 自定义JWT登录过滤器，继承 UsernamePasswordAuthenticationFilter"></a>2.3 自定义JWT登录过滤器，继承 UsernamePasswordAuthenticationFilter</h4><p>重写了其中的3个方法</p><ul><li><code>attemptAuthentication</code>：接收并解析用户凭证。</li><li><code>successfulAuthentication</code>：用户成功登录后被调用，我们在这个方法里生成token。</li><li><code>unsuccessfulAuthentication</code>：认证失败后被调用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtLoginFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试身份认证(接收并解析用户凭证)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> authenticationManager.authenticate(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证成功(用户成功登录后，这个方法会被调用，我们在这个方法里生成token)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = auth.getAuthorities();</span><br><span class="line">            <span class="comment">// 定义存放角色集合的对象</span></span><br><span class="line">            List&lt;String&gt; roleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority grantedAuthority : authorities) &#123;</span><br><span class="line">                roleList.add(grantedAuthority.getAuthority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 生成token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            <span class="comment">// 设置签发时间</span></span><br><span class="line">            calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="comment">// 设置过期时间: 5分钟</span></span><br><span class="line">            calendar.add(Calendar.MINUTE, <span class="number">5</span>);</span><br><span class="line">            <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                    .setSubject(auth.getName() + <span class="string">&quot;-&quot;</span> + roleList)</span><br><span class="line">                    <span class="comment">// 签发时间</span></span><br><span class="line">                    .setIssuedAt(now)</span><br><span class="line">                    <span class="comment">// 过期时间</span></span><br><span class="line">                    .setExpiration(time)</span><br><span class="line">                    <span class="comment">// 自定义算法与签名：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                    .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                    .compact();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 返回token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            log.info(<span class="string">&quot;用户登录成功，生成token=&#123;&#125;&quot;</span>, token);</span><br><span class="line">            <span class="comment">// 登录成功后，返回token到header里面</span></span><br><span class="line">            response.addHeader(<span class="string">&quot;Authorization&quot;</span>, token);</span><br><span class="line">            <span class="comment">// 登录成功后，返回token到body里面</span></span><br><span class="line">            ResponseJson&lt;String&gt; result = ResponseJson.success(token);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;IOException:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证失败调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;登录失败[&#123;&#125;]，AuthenticationException=&#123;&#125;&quot;</span>, request.getRequestURI(), exception.getMessage());</span><br><span class="line">        <span class="comment">// 登录失败，返回错误信息</span></span><br><span class="line">        ResponseJson&lt;Void&gt; result = ResponseJson.error(exception.getMessage(), <span class="literal">null</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义加密的签名<code>key</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义签名key常量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstantKey</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SIGNING_KEY</span> <span class="operator">=</span> <span class="string">&quot;Charles@Jwt!&amp;Secret^#&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义全局API返回JSON数据对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseJson</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">/** 自定义状态码 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="comment">/** 提示信息 */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="comment">/** 返回数据 */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ResponseJson</span><span class="params">(<span class="type">int</span> code, String msg, T data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResponseJson&lt;Void&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(<span class="number">0</span>, <span class="string">&quot;操作成功&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; ResponseJson&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(<span class="number">0</span>, <span class="string">&quot;操作成功&quot;</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; ResponseJson&lt;T&gt; <span class="title function_">success</span><span class="params">(String msg, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(<span class="number">0</span>, msg, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; ResponseJson&lt;T&gt; <span class="title function_">success</span><span class="params">(<span class="type">int</span> code, String msg, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(code, msg, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResponseJson&lt;Void&gt; <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(-<span class="number">1</span>, <span class="string">&quot;操作失败&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResponseJson&lt;Void&gt; <span class="title function_">error</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(-<span class="number">1</span>, msg, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResponseJson&lt;Void&gt; <span class="title function_">error</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(code, msg, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; ResponseJson&lt;T&gt; <span class="title function_">error</span><span class="params">(String msg, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(-<span class="number">1</span>, msg, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; ResponseJson&lt;T&gt; <span class="title function_">error</span><span class="params">(<span class="type">int</span> code, String msg, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>&lt;&gt;(code, msg, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ResponseJson&#123;&quot;</span> + <span class="string">&quot;code=&quot;</span> + code + <span class="string">&quot;, msg=&#x27;&quot;</span> + msg + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&quot;, data=&quot;</span> + data + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-自定义JWT认证过滤器，继承-BasicAuthenticationFilter，重写doFilterInternal方法"><a href="#2-4-自定义JWT认证过滤器，继承-BasicAuthenticationFilter，重写doFilterInternal方法" class="headerlink" title="2.4 自定义JWT认证过滤器，继承 BasicAuthenticationFilter，重写doFilterInternal方法"></a>2.4 自定义JWT认证过滤器，继承 BasicAuthenticationFilter，重写doFilterInternal方法</h4><p>从http头的Authorization 项读取token数据，然后用Jwts包提供的方法校验token的合法性。如果校验通过，就认为这是一个取得授权的合法请求。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">BasicAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(authenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> getAuthentication(request, response);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UsernamePasswordAuthenticationToken <span class="title function_">getAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 解析token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                        <span class="comment">// 设置生成token的签名key</span></span><br><span class="line">                        .setSigningKey(ConstantKey.SIGNING_KEY)</span><br><span class="line">                        <span class="comment">// 解析token</span></span><br><span class="line">                        .parseClaimsJws(token).getBody();</span><br><span class="line">                <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> claims.getSubject();</span><br><span class="line">                <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">                    String[] split = user.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    ArrayList&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (String s : split) &#123;</span><br><span class="line">                        authorities.add(<span class="keyword">new</span> <span class="title class_">GrantedAuthorityImpl</span>(s));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 刷新Token</span></span><br><span class="line">                    refreshToken(response, claims);</span><br><span class="line">                    <span class="comment">// 返回Authentication</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, authorities);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，ExpiredJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedJwtException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，UnsupportedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MalformedJwtException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，MalformedJwtException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SignatureException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，SignatureException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，IllegalArgumentException=&#123;&#125;&quot;</span>, request.getRequestURI(), e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.warn(<span class="string">&quot;访问[&#123;&#125;]失败，需要身份认证&quot;</span>, request.getRequestURI());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 刷新Token</span></span><br><span class="line"><span class="comment">     * 刷新Token的时机：</span></span><br><span class="line"><span class="comment">     * 1. 当前时间 &lt; token过期时间</span></span><br><span class="line"><span class="comment">     * 2. 当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(HttpServletResponse response, Claims claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// token签发时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">issuedAt</span> <span class="operator">=</span> claims.getIssuedAt().getTime();</span><br><span class="line">        <span class="comment">// token过期时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expiration</span> <span class="operator">=</span> claims.getExpiration().getTime();</span><br><span class="line">        <span class="comment">// (当前时间 &lt; token过期时间) &amp;&amp; (当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2))</span></span><br><span class="line">        <span class="keyword">if</span> ((current &lt; expiration) &amp;&amp; (current &gt; (issuedAt + ((expiration - issuedAt) / <span class="number">2</span>)))) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 重新生成token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            <span class="comment">// 设置签发时间</span></span><br><span class="line">            calendar.setTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="comment">// 设置过期时间: 5分钟</span></span><br><span class="line">            calendar.add(Calendar.MINUTE, <span class="number">5</span>);</span><br><span class="line">            <span class="type">Date</span> <span class="variable">time</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">            <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                    .setSubject(claims.getSubject())</span><br><span class="line">                    <span class="comment">// 签发时间</span></span><br><span class="line">                    .setIssuedAt(now)</span><br><span class="line">                    <span class="comment">// 过期时间</span></span><br><span class="line">                    .setExpiration(time)</span><br><span class="line">                    <span class="comment">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span></span><br><span class="line">                    .signWith(SignatureAlgorithm.HS512, ConstantKey.SIGNING_KEY)</span><br><span class="line">                    .compact();</span><br><span class="line">            <span class="comment">// 主动刷新token，并返回给前端</span></span><br><span class="line">            response.addHeader(<span class="string">&quot;refreshToken&quot;</span>, refreshToken);</span><br><span class="line">            log.info(<span class="string">&quot;刷新token执行时间: &#123;&#125;&quot;</span>, (System.currentTimeMillis() - current) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-通过实现-AuthenticationEntryPoint-自定义认证拦截器"><a href="#2-5-通过实现-AuthenticationEntryPoint-自定义认证拦截器" class="headerlink" title="2.5 通过实现 AuthenticationEntryPoint 自定义认证拦截器"></a>2.5 通过实现 <code>AuthenticationEntryPoint</code> 自定义认证拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthenticationEntryPointImpl</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 遇到了认证异常authException用户请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 将要返回给客户的相应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;预认证入口被调用。拒绝访问，AuthenticationException=&#123;&#125;&quot;</span>, exception.getMessage());</span><br><span class="line">        <span class="comment">// 没有权限，返回403</span></span><br><span class="line">        response.sendError(<span class="number">403</span>, <span class="string">&quot;Access Denied&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-示例DEMO"><a href="#3-示例DEMO" class="headerlink" title="3. 示例DEMO"></a>3. 示例DEMO</h3><p>sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sys_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sys_user` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;系统用户表&#x27;</span>;</span><br></pre></td></tr></table></figure><p>Java代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserApi</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseJson&lt;SysUser&gt; <span class="title function_">register</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUserService.register(sysUser);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseJson&lt;Void&gt; <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseJson.success(<span class="string">&quot;访问成功！公开接口：/hello&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/private&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseJson&lt;Void&gt; <span class="title function_">hello2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseJson.success(<span class="string">&quot;访问成功！非公开接口：/private&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUser</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysUserDao sysUserDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">public</span> ResponseJson&lt;SysUser&gt; <span class="title function_">register</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(sysUser.getUsername()) || StringUtils.isEmpty(sysUser.getPassword()))&#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseJson.error(<span class="string">&quot;用户名或密码不能为空&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodePassword</span> <span class="operator">=</span> passwordEncoder.encode(sysUser.getPassword());</span><br><span class="line">        sysUser.setPassword(encodePassword);</span><br><span class="line">        sysUserDao.insertSysUser(sysUser);</span><br><span class="line">        <span class="keyword">return</span> ResponseJson.success(<span class="string">&quot;注册成功&quot;</span>, sysUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DAO层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SysUserDao</span> &#123;</span><br><span class="line">    SysUser <span class="title function_">findByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertSysUser</span><span class="params">(SysUser sysUser)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertSysUser&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">INSERT INTO sys_user(username, password) VALUES(#&#123;username&#125;, #&#123;password&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.jwt.entity.SysUser&quot;</span>&gt;</span></span><br><span class="line">SELECT id,username,PASSWORD FROM sys_user WHERE username=#&#123;username&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h3><p>注册一个用户：</p><p><img src="/2021/12/09/spring-security-jwt/up-370de8ce7710b876dfd137c959fa7eee380.webp"></p><p>登录，返回Token：</p><p><img src="/2021/12/09/spring-security-jwt/up-1fef936e1e165efa73d6b133eba887c9d6d.webp"></p><p>访问公开接口：</p><p><img src="/2021/12/09/spring-security-jwt/up-f342a930a199bcca09e0866b790c3a6a2db.webp"></p><p>访问需要认证的接口，无权限返回403：</p><p><img src="/2021/12/09/spring-security-jwt/up-13ffbcfb34a1c5d879d1e2b2a0c883fb204.webp"></p><p>访问需要认证的接口，通过有效Token访问：</p><p><img src="/2021/12/09/spring-security-jwt/up-c5efb32d07d1bd147f8c3dae689cde5eda6.webp"></p><blockquote><p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,<br>这里我将本文的登录认证逻辑放在github源码tag的V1.0中，防止后续修改后对不上。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;JSON Web Token（缩写 JWT）基于JSON格式信息一种Token令牌，是目前最流行的跨域认证解决方案。&lt;/p&gt;</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
    <category term="JWT" scheme="http://chaooo.github.io/tags/JWT/"/>
    
  </entry>
  
  <entry>
    <title>「Spring Security」安全架构与认证鉴权原理</title>
    <link href="http://chaooo.github.io/2021/11/29/spring-security-filter.html"/>
    <id>http://chaooo.github.io/2021/11/29/spring-security-filter.html</id>
    <published>2021-11-29T06:01:00.000Z</published>
    <updated>2022-04-17T08:03:28.704Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-Spring-Security-Servlet-安全架构"><a href="#1-Spring-Security-Servlet-安全架构" class="headerlink" title="1. Spring Security Servlet 安全架构"></a>1. Spring Security Servlet 安全架构</h3><p><code>Spring Security</code> 设计的 <code>Servlet</code> 安全从架构上分为三个层次，分别是「认证」、「鉴权」、「入侵防护」。通过<strong>过滤器机制</strong>将安全逻辑应用到 <code>Servlet</code> 项目。</p><p>请求的接收和处理是通过一个一个的过滤器顺序执行实现的，过滤器是 <code>Servlet</code> 项目处理请求的基础。</p><p><code>Spring</code> 将自己体系内的过滤器交由「过滤器代理<code>FilterChainProxy</code>」管理，<code>FilterChainProxy</code> 同样也是一个过滤器，被封装在 <code>Spring</code> 的「过滤器委托代理<code>DelegatingFilterProxy</code>」中。<br><code>Spring Security</code> 在 <code>FilterChainProxy</code> 中加入了「安全过滤器链<code>SecurityFilterChain</code>」实现安全保护功能。<span id="more"></span></p><p>其过程如图：<br><img src="/2021/11/29/spring-security-filter/up-0190e15403889a4a54ded3892f2a2d7cd18.webp"></p><p>安全过滤器链（<code>SecurityFilterChain</code>）的特点：</p><ul><li>为所有 <code>Spring Security</code> 支持的 <code>Servlet</code> 指明了起点；</li><li>对于一些后台操作，可以提升执行效率；</li><li>在 <code>Servlet</code> 容器中，过滤器的选择是由 <code>URL</code> 决定的，如此便可针对不同 <code>URL</code> 指定相互独立的安全策略。</li></ul><h4 id="1-1-安全过滤器-Filter"><a href="#1-1-安全过滤器-Filter" class="headerlink" title="1.1 安全过滤器 Filter"></a>1.1 安全过滤器 Filter</h4><p><code>Spring Security</code> 内置了 <code>33</code> 种安全过滤器，每个过滤器有固定的顺序及应用场景；内置过滤器的参数设置通过 <code>HttpSecurity</code> 类相应的配置方法完成。</p><p>在认证与授权中关键的三个过滤器：</p><ol><li><code>UsernamePasswordAuthenticationFilter</code>：该过滤器用于拦截我们表单提交的请求（默认为&#x2F;login），进行用户的认证过程。</li><li><code>FilterSecurityInterceptor</code>：该过滤器主要用来进行授权判断。</li><li><code>ExceptionTranslationFilter</code>：该过滤器主要用来捕获处理<code>spring security</code>抛出的异常，异常主要来源于<code>FilterSecurityInterceptor</code>。</li></ol><p><code>Spring Security</code> 的认证、授权异常在过滤器校验过程中产生，并在 <code>ExceptionTranslationFilter</code> 中接收并进行处理，</p><ol><li><code>ExceptionTranslationFilter</code> 过滤器首先像其他过滤器一样，调用过滤器链的执行方法 <code>FilterChain.doFilter(request, response)</code> 启动过滤处理；</li><li>如果当前的用户没有通过认证或者因为其他原因在执行过程中抛出了 AuthenticationException 异常，此时将开启「认证流程」：<ul><li>清空 <code>SecurityContextHolder</code> 对象；</li><li>并将原始请求信息「<code>request</code>」保存到 <code>RequestCache</code> 对象中；</li><li>使用 <code>AuthenticationEntryPoint</code> 对象存储的认证地址，向客户端索要身份证明。例如，使用浏览器登录的用户，将浏览器地址重定向到 &#x2F;login 或者回传一个 WWW-Authenticate 认证请求头。</li></ul></li><li>如果当前用户身份信息已确认，但是没有访问权限，则会产生 <code>AccessDeniedException</code> 异常，然后访问被拒绝。继续执行拒绝处理 <code>AccessDeniedHandler</code>。</li></ol><h4 id="1-2-自定义过滤器-Filter"><a href="#1-2-自定义过滤器-Filter" class="headerlink" title="1.2 自定义过滤器 Filter"></a>1.2 自定义过滤器 Filter</h4><p>在 <code>HttpSecurity</code> 对象中增加自定义 <code>Filter</code> 可用于实现认证方式的扩展等场景，扩展 <code>Filter</code> 需要实现 <code>javax.servlet.Filter</code> 接口；并且需要指定新过滤器的位置。</p><p>例如，扩展自定义接口 SimpleFilter。</p><ol><li>自定义接口类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;In SimpleFilter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>加入到指定位置，比如加在 UsernamePasswordAuthenticationFilter 之前</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(<span class="keyword">new</span> <span class="title class_">SimpleFilter</span>(), UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure><h3 id="2-Spring-Security-认证"><a href="#2-Spring-Security-认证" class="headerlink" title="2. Spring Security 认证"></a>2. Spring Security 认证</h3><h4 id="2-1-Spring-Security-基本认证组件"><a href="#2-1-Spring-Security-基本认证组件" class="headerlink" title="2.1 Spring Security 基本认证组件"></a>2.1 Spring Security 基本认证组件</h4><table>    <thead><tr><th>组别</th><th>组件名</th><th>简述</th></tr></thead>    <tbody>        <tr><td rowspan="4">存储单元</td><td>Authentication</td><td>维护用户用于认证的信息</td></tr>        <tr><td>GrantedAuthority</td><td>认证用户的权限信息比如角色、范围等等</td></tr>        <tr><td>SecurityContextHolder</td><td>用于维护 SpringContext</td></tr>        <tr><td>SecurityContext</td><td>用来存储当前认证用户的信息</td></tr>        <tr><td rowspan="4">认证管理</td><td>AuthenticationManager</td><td>SpringSecurity 向外提供的用于认证的 API 集合</td></tr>        <tr><td>ProviderManager</td><td>AuthenticationManager 的常见实现类</td></tr>        <tr><td>AuthenticationProvider</td><td>用于 ProviderManager 提供认证实现</td></tr>        <tr><td>AuthenticationEntryPoint</td><td>用于获取用户认证信息</td></tr>        <tr><td>流程管理</td><td>AbstractAuthenticationProcessingFilter</td><td>是认证过滤器的基础，用于组合认证流程</td></tr>    </tbody></table><h4 id="2-2-存储单元"><a href="#2-2-存储单元" class="headerlink" title="2.2 存储单元"></a>2.2 存储单元</h4><p><img src="/2021/11/29/spring-security-filter/up-911c8967517a976252c03eb5d98f9a97151.webp"></p><ol><li><code>SecurityContextHolder</code> 对象是整个 <code>Spring Security</code> 体系的核心，它维护着 <code>SecurityContext</code> 对象。它是唯一的。</li><li><code>SecurityContext</code> 对象用于衔接 <code>SecurityContextHolder</code> 和 <code>Authentication</code> 对象，是对 <code>Authentication</code> 的外层封装。</li><li><code>Authentication</code> 是用户的认证信息。</li></ol><p><code>Authentication</code>对象有三个核心属性：</p><ul><li><strong>principal</strong>：用户的身份信息；</li><li><strong>credentials</strong>：用户的认证凭据，比如密码，通常情况下，当用户完成认证后，此项内容就会被清空；</li><li><strong>authorities</strong>：用户的权限，用于更高层次的鉴权功能，通常包括角色、使用范围等信息。该属性基本由 <code>GrantedAuthority</code> 实现。<code>GrantedAuthority</code> 是在前述 <code>Authentication</code> 对象中所指的权限信息。在开发过程中，可以通过 <code>Authentication.getAuthorities()</code> 方法获取。权限信息通常包括角色、范围，或者其他扩展内容。</li></ul><p><code>Authentication</code> 两个主要作用：</p><ol><li>为 <code>AuthenticationManager</code> 对象提供用于认证的信息载体；</li><li>用于获取某个用户的基本信息。</li></ol><h4 id="2-3-认证管理"><a href="#2-3-认证管理" class="headerlink" title="2.3 认证管理"></a>2.3 认证管理</h4><ol><li><code>AuthenticationManager</code> 为 <code>Spring</code> 过滤器提供认证支持 <code>API</code>。<code>AuthenticationManager</code> 的实现形式并没有严格限制，通常情况下使用 <code>ProviderManager</code>。</li><li><code>ProviderManager</code> 是 <code>AuthenticationManager</code> 的最常用的实现类，它包含了一系列的 <code>AuthenticationProvider</code> 对象，用以判断认证流程是否完成、认证结构是否成功。</li><li><code>AuthenticationProvider</code>：每个 <code>ProviderManager</code> 可以包含多个 <code>AuthenticationProvider</code> ，每个 <code>AuthenticationProvider</code> 提供一种认证类型，例如：<code>DaoAuthenticationProvider</code> 可以完成「用户名 &#x2F; 密码」的认证，<code>JwtAuthenticationProvider</code> 用于完成 JWT 方式的认证。</li><li><code>AuthenticationEntryPoint</code> 在当一个请求包含的认证信息不全时，比如未认证终端访问受保护资源时发挥作用，如跳转到登录页面、返回认证要求等。</li></ol><h4 id="2-4-流程管理"><a href="#2-4-流程管理" class="headerlink" title="2.4 流程管理"></a>2.4 流程管理</h4><p><code>AbstractAuthenticationProcessingFilter</code> 是所有认证过滤器的基类。</p><ol><li>当用户提交认证信息，AbstractAuthenticationProcessingFilter 首先从请求信息（例如用户名、密码）中创建 Authentication 对象；</li><li>将 Authentication 对象传递给 AuthenticationManager 对象，用于后续认证；</li><li>如果认证失败，则执行失败流程：<ul><li>清空 SecurityContextHolder 对象；</li><li>触发 RememberMeServices.loginFail 方法；</li><li>触发 AuthenticationFailureHandler。</li></ul></li><li>如果认证成功，则执行成功流程：<ul><li>SessionAuthenticationStrategy 登记新的登录；</li><li>将 Authentication 对象设置到 SecurityContextHolder 对象中，并将 SecurityContext 对象保持到 Session 中；</li><li>调用 RememberMeServices.loginSuccess 方法；</li><li>ApplicationEventPublisher 发起事件 InteractiveAuthenticationSuccessEvent</li></ul></li></ol><h3 id="3-Spring-Security-鉴权"><a href="#3-Spring-Security-鉴权" class="headerlink" title="3. Spring Security 鉴权"></a>3. Spring Security 鉴权</h3><p>Spring Security 包含<strong>确认身份</strong>和<strong>确认身份的可执行操作</strong>两部分，前者为认证(<code>Authentication</code>)，后者即为鉴权(<code>Authorization</code>)；</p><h4 id="3-1-权限"><a href="#3-1-权限" class="headerlink" title="3.1 权限"></a>3.1 权限</h4><p><code>Spring Security</code> 的权限默认是以字符串形式存储的权限信息，比如角色名称、功能名称等；</p><p>在用户身份信息得到确认后，<code>Authentication</code> 中会存储一系列的 <code>GrantedAuthority</code> 对象，这些对象用来判断用户可以使用哪些资源。</p><p><code>GrantedAuthority</code> 对象通过 <code>AuthenticationManager</code> 插入到 <code>Authentication</code> 对象中，并被 <code>AccessDecisionManager</code> 使用，判断其权限。</p><p><code>GrantedAuthority</code> 是一个接口，其仅包含一个 <code>getAuthority()</code> 方法，返回一个字符串值，该值作为权限的描述，当权限较为复杂，该方法需要返回 null，此时 <code>AccessDecisionManager</code> 会根据 <code>getAuthority()</code> 返回值情况判断是否要进行特殊处理。</p><p><code>SimpleGrantedAuthority</code> 是 <code>GrantedAuthority</code> 的一个基础实现类，可以满足一般的业务需求。</p><h4 id="3-2-鉴权"><a href="#3-2-鉴权" class="headerlink" title="3.2 鉴权"></a>3.2 鉴权</h4><ul><li>前置鉴权：由 <code>AccessDecisionManager</code> 对象判断其是否允许继续执行； 权限判断发生在方法被调用前，或者 WEB 请求之前。不满足抛出 <code>AccessDeniedException</code> 异常。</li><li>后置鉴权：通过 <code>AfterInvocationManager</code> 进行管理；后置鉴权在资源被访问后，根据权限的判定来修改返回的内容，或者返回 <code>AccessDeniedException</code>。</li></ul><p>前置鉴权 <code>AccessDecisionManager</code> 对象由 <code>AbstractSecurityInterceptor</code> 发起调用，其职责是给出资源是否能被访问的最终结果；</p><ul><li><code>AccessDecisionManager</code> 包含三个主要方法：<ul><li><code>boolean supports(ConfigAttribute attribute);</code>：判断配置属性是否可被访问；</li><li><code>boolean supports(Class clazz);</code>：判断安全对象的类型是否支持被访问；</li><li><code>void decide(Authentication authentication, Object secureObject,Collection&lt;ConfigAttribute&gt; attrs) throws AccessDeniedException;</code>：通过认证信息、安全对象、权限信息综合判断安全对象是否允许被访问。</li></ul></li></ul><p><code>Spring Security</code> 内置了以「<strong>投票</strong>」为判定方法的鉴权策略。<code>Spring Security</code> 的鉴权策略可以由用户自己实现。</p><p><strong>投票策略</strong>下，<code>AccessDecisionManager</code> 控制着一系列的 <code>AccessDecisionVoter</code> 实例，判断权限是否满足，如果不满足抛出 <code>AccessDeniedException</code> 异常。</p><ul><li><code>AccessDecisionVoter</code> 也包含三个方法：<ul><li><code>boolean supports(ConfigAttribute attribute);</code>：判断配置属性是否支持；</li><li><code>boolean supports(Class clazz);</code>：判断类型是否支持；</li><li><code>int vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attrs);</code>：根据认证信息对安全资源进行投票。</li></ul></li></ul><p>投票鉴权分为三类：</p><ul><li>基于角色的投票：<code>RoleVoter</code>；</li><li>基于认证信息的投票：<code>AuthenticatedVoter</code>，主要区分认证用户、匿名用户等；</li><li>自定义投票策略。</li></ul><h4 id="3-3-Servlet-请求鉴权流程"><a href="#3-3-Servlet-请求鉴权流程" class="headerlink" title="3.3 Servlet 请求鉴权流程"></a>3.3 Servlet 请求鉴权流程</h4><p><code>Servlet</code> 鉴权主要围绕着 <code>FilterSecurityInterceptor</code> 类展开，该类作为一个安全过滤器，被放置在 <code>FilterChainProxy</code> 中。</p><p>具体流程如下：</p><ol><li><code>FilterSecurityInterceptor</code> 从 <code>SecurityContextHolder</code> 中获取 <code>Authentication</code> 对象；</li><li><code>FilterSecurityInterceptor</code> 从 <code>HttpServletRequest</code>、<code>HttpServletREsponse</code>、 <code>FilterChain</code> 中创建 <code>FilterInvocation</code> 对象；</li><li>将创建的 <code>FilterInvocation</code> 对象传递给 <code>SecurityMetadataSource</code> 用来获取 <code>ConfigAttribute</code> 对象集合；</li><li>最后，将 <code>Authentication</code>、<code>FilterInvocation</code> 和 <code>ConfigAttribute</code> 对象传递给 <code>AccessDecisionManager</code> 实例验证权限：<ul><li>如果验证失败，将抛出 <code>AccessDeniedException</code> 异常，并由 <code>ExceptionTranslationFilter</code> 接收并处理；</li><li>如果验证通过，<code>FilterSecurityInterceptor</code> 将控制权交还给 <code>FilterChain</code>，使程序继续执行。</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;1-Spring-Security-Servlet-安全架构&quot;&gt;&lt;a href=&quot;#1-Spring-Security-Servlet-安全架构&quot; class=&quot;headerlink&quot; title=&quot;1. Spring Security Servlet 安全架构&quot;&gt;&lt;/a&gt;1. Spring Security Servlet 安全架构&lt;/h3&gt;&lt;p&gt;&lt;code&gt;Spring Security&lt;/code&gt; 设计的 &lt;code&gt;Servlet&lt;/code&gt; 安全从架构上分为三个层次，分别是「认证」、「鉴权」、「入侵防护」。通过&lt;strong&gt;过滤器机制&lt;/strong&gt;将安全逻辑应用到 &lt;code&gt;Servlet&lt;/code&gt; 项目。&lt;/p&gt;
&lt;p&gt;请求的接收和处理是通过一个一个的过滤器顺序执行实现的，过滤器是 &lt;code&gt;Servlet&lt;/code&gt; 项目处理请求的基础。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Spring&lt;/code&gt; 将自己体系内的过滤器交由「过滤器代理&lt;code&gt;FilterChainProxy&lt;/code&gt;」管理，&lt;code&gt;FilterChainProxy&lt;/code&gt; 同样也是一个过滤器，被封装在 &lt;code&gt;Spring&lt;/code&gt; 的「过滤器委托代理&lt;code&gt;DelegatingFilterProxy&lt;/code&gt;」中。&lt;br&gt;&lt;code&gt;Spring Security&lt;/code&gt; 在 &lt;code&gt;FilterChainProxy&lt;/code&gt; 中加入了「安全过滤器链&lt;code&gt;SecurityFilterChain&lt;/code&gt;」实现安全保护功能。</summary>
    
    
    
    <category term="安全认证" scheme="http://chaooo.github.io/categories/safe/"/>
    
    
    <category term="后端开发" scheme="http://chaooo.github.io/tags/back-end/"/>
    
    <category term="安全认证" scheme="http://chaooo.github.io/tags/safe/"/>
    
    <category term="SpringSecurity" scheme="http://chaooo.github.io/tags/SpringSecurity/"/>
    
  </entry>
  
</feed>
